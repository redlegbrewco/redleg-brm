<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --primary: #8B0000;
      --primary-light: #A52A2A;
      --primary-dark: #5c0000;
      --accent: #c41e3a;
      --success: #38a169;
      --warning: #d69e2e;
      --danger: #e53e3e;
      --bg: #f7fafc;
      --card: #ffffff;
      --text: #2d3748;
      --text-light: #718096;
      --border: #e2e8f0;
      --gold: #d4af37;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    
    /* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .header h1 { 
      font-size: 20px; 
      display: flex; 
      align-items: center; 
      gap: 10px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    .header h1 span.subtitle {
      font-size: 12px;
      font-weight: 400;
      opacity: 0.8;
      margin-left: 5px;
    }
    .header-right { display: flex; align-items: center; gap: 15px; }
    .header-date { font-size: 13px; opacity: 0.9; }
    .header-badge { 
      background: var(--gold); 
      color: var(--primary-dark);
      padding: 5px 12px; 
      border-radius: 20px; 
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* ‚ïê‚ïê‚ïê NAVIGATION ‚ïê‚ïê‚ïê */
    .nav-tabs {
      background: var(--card);
      border-bottom: 2px solid var(--primary);
      display: flex;
      overflow-x: auto;
      padding: 0;
      scrollbar-width: thin;
    }
    
    .nav-tabs::-webkit-scrollbar { height: 4px; }
    .nav-tabs::-webkit-scrollbar-thumb { background: var(--primary-light); border-radius: 2px; }
    
    .nav-tab {
      padding: 14px 18px;
      border: none;
      background: none;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-light);
      cursor: pointer;
      white-space: nowrap;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      position: relative;
    }
    
    .nav-tab:hover { 
      color: var(--primary); 
      background: rgba(139, 0, 0, 0.05); 
    }
    .nav-tab.active { 
      color: var(--primary); 
      border-bottom-color: var(--primary); 
      font-weight: 600;
      background: rgba(139, 0, 0, 0.08);
    }
    
    /* ‚ïê‚ïê‚ïê CONTENT ‚ïê‚ïê‚ïê */
    .content { padding: 20px; max-width: 1600px; margin: 0 auto; }
    .tab-content { display: none; animation: fadeIn 0.3s ease; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* ‚ïê‚ïê‚ïê CARDS ‚ïê‚ïê‚ïê */
    .card {
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
      margin-bottom: 20px;
      overflow: hidden;
      border: 1px solid var(--border);
    }
    
    .card-header {
      padding: 15px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(to right, #fafafa, #ffffff);
    }
    
    .card-title { 
      font-size: 15px; 
      font-weight: 600; 
      display: flex; 
      align-items: center; 
      gap: 8px;
      color: var(--text);
    }
    .card-body { padding: 20px; }
    
    /* ‚ïê‚ïê‚ïê STATS ‚ïê‚ïê‚ïê */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid var(--border);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .stat-card.highlight {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      border: none;
    }
    
    .stat-card.success { border-left: 4px solid var(--success); }
    .stat-card.warning { border-left: 4px solid var(--warning); }
    .stat-card.danger { border-left: 4px solid var(--danger); }
    
    .stat-label { 
      font-size: 11px; 
      color: var(--text-light); 
      text-transform: uppercase; 
      letter-spacing: 0.5px; 
      margin-bottom: 8px;
      font-weight: 600;
    }
    .stat-card.highlight .stat-label { color: rgba(255,255,255,0.8); }
    .stat-value { font-size: 28px; font-weight: 700; line-height: 1.2; }
    .stat-sub { font-size: 12px; color: var(--text-light); margin-top: 5px; }
    .stat-card.highlight .stat-sub { color: rgba(255,255,255,0.7); }
    
    /* ‚ïê‚ïê‚ïê TABLES ‚ïê‚ïê‚ïê */
    .table-container { overflow-x: auto; }
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th {
      text-align: left;
      padding: 12px 15px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-light);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: #f8f9fa;
      border-bottom: 2px solid var(--border);
      position: sticky;
      top: 0;
    }
    .data-table td { 
      padding: 12px 15px; 
      border-bottom: 1px solid var(--border); 
      font-size: 14px; 
    }
    .data-table tr:hover { background: #f8f9fa; }
    .data-table tr:last-child td { border-bottom: none; }
    
    /* ‚ïê‚ïê‚ïê BADGES ‚ïê‚ïê‚ïê */
    .badge { 
      display: inline-block; 
      padding: 4px 10px; 
      border-radius: 12px; 
      font-size: 11px; 
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .badge-success { background: #c6f6d5; color: #276749; }
    .badge-warning { background: #fefcbf; color: #975a16; }
    .badge-danger { background: #fed7d7; color: #c53030; }
    .badge-info { background: #bee3f8; color: #2c5282; }
    .badge-gray { background: #e2e8f0; color: #4a5568; }
    
    /* ‚ïê‚ïê‚ïê PROGRESS ‚ïê‚ïê‚ïê */
    .progress-bar { height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
    .progress-fill.success { background: linear-gradient(90deg, #48bb78, #38a169); }
    .progress-fill.warning { background: linear-gradient(90deg, #ecc94b, #d69e2e); }
    .progress-fill.danger { background: linear-gradient(90deg, #fc8181, #e53e3e); }
    
    /* ‚ïê‚ïê‚ïê ALERTS ‚ïê‚ïê‚ïê */
    .alert { 
      padding: 15px 20px; 
      border-radius: 8px; 
      margin-bottom: 15px; 
      display: flex; 
      align-items: center; 
      gap: 10px;
      font-size: 14px;
    }
    .alert-warning { background: #fffbeb; border: 1px solid #f59e0b; color: #92400e; }
    .alert-danger { background: #fef2f2; border: 1px solid #ef4444; color: #991b1b; }
    .alert-success { background: #f0fdf4; border: 1px solid #22c55e; color: #166534; }
    .alert-info { background: #eff6ff; border: 1px solid #3b82f6; color: #1e40af; }
    
    /* ‚ïê‚ïê‚ïê LAYOUT ‚ïê‚ïê‚ïê */
    .two-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
    .three-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    
    /* ‚ïê‚ïê‚ïê FORMS ‚ïê‚ïê‚ïê */
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { 
      display: block; 
      font-size: 12px; 
      font-weight: 600; 
      color: var(--text-light); 
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.1);
    }
    
    /* ‚ïê‚ïê‚ïê BUTTONS ‚ïê‚ïê‚ïê */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }
    .btn-primary { 
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); 
      color: white; 
    }
    .btn-primary:hover { 
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(139, 0, 0, 0.3);
    }
    .btn-primary:disabled { background: #a0aec0; cursor: not-allowed; transform: none; box-shadow: none; }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover { background: #2f855a; }
    .btn-outline { background: white; border: 1px solid var(--border); color: var(--text); }
    .btn-outline:hover { background: #f7fafc; border-color: var(--primary); }
    .btn-secondary { background: #e2e8f0; color: var(--text); }
    .btn-secondary:hover { background: #cbd5e0; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn-icon { 
      background: none; 
      border: none; 
      cursor: pointer; 
      padding: 6px 8px; 
      font-size: 16px; 
      border-radius: 4px; 
      transition: background 0.2s; 
    }
    .btn-icon:hover { background: #e9ecef; }
    .btn-icon.btn-danger:hover { background: #fed7d7; }
    
    /* ‚ïê‚ïê‚ïê FILTERS ‚ïê‚ïê‚ïê */
    .action-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    .search-box { position: relative; flex: 1; min-width: 250px; }
    .search-box input { 
      width: 100%; 
      padding: 10px 15px 10px 40px; 
      border: 1px solid var(--border); 
      border-radius: 6px; 
      font-size: 14px; 
    }
    .search-box::before { content: "üîç"; position: absolute; left: 12px; top: 50%; transform: translateY(-50%); }
    
    .filter-pills { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
    .filter-pill { 
      padding: 6px 14px; 
      border: 1px solid var(--border); 
      border-radius: 20px; 
      font-size: 13px; 
      cursor: pointer; 
      background: white;
      transition: all 0.2s;
    }
    .filter-pill:hover { border-color: var(--primary); color: var(--primary); }
    .filter-pill.active { background: var(--primary); color: white; border-color: var(--primary); }
    
    /* ‚ïê‚ïê‚ïê UTILITIES ‚ïê‚ïê‚ïê */
    .loading { text-align: center; padding: 40px; color: var(--text-light); }
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-light); }
    .action-cell { white-space: nowrap; }
    .text-success { color: var(--success); }
    .text-danger { color: var(--danger); }
    .text-warning { color: var(--warning); }
    .text-muted { color: var(--text-light); }
    .font-bold { font-weight: 600; }
    
    /* ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(2px);
    }
    .modal-content { 
      background: white; 
      border-radius: 12px; 
      width: 90%; 
      max-width: 600px;
      max-height: 90vh; 
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0,0,0,0.25);
    }
    .modal-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 16px 20px; 
      border-bottom: 1px solid var(--border);
      background: linear-gradient(to right, #fafafa, #ffffff);
    }
    .modal-header h2 { margin: 0; font-size: 18px; }
    .close-btn { 
      font-size: 24px; 
      cursor: pointer; 
      color: #666; 
      line-height: 1; 
      background: none; 
      border: none;
      padding: 5px;
      border-radius: 4px;
    }
    .close-btn:hover { color: #333; background: #f0f0f0; }
    .modal-body { padding: 20px; }
    .modal-actions { 
      display: flex; 
      justify-content: flex-end; 
      gap: 12px; 
      margin-top: 20px; 
      padding-top: 16px; 
      border-top: 1px solid var(--border); 
    }
    
    /* ‚ïê‚ïê‚ïê QUICK ACTIONS ‚ïê‚ïê‚ïê */
    .quick-actions { 
      position: fixed; 
      bottom: 20px; 
      right: 20px; 
      display: flex; 
      flex-direction: column; 
      gap: 10px; 
      z-index: 50; 
    }
    .quick-action-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(139, 0, 0, 0.3);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .quick-action-btn:hover { 
      transform: scale(1.1); 
      box-shadow: 0 6px 20px rgba(139, 0, 0, 0.4);
    }
    
    /* ‚ïê‚ïê‚ïê TOAST NOTIFICATIONS ‚ïê‚ïê‚ïê */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 80px;
      padding: 12px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 10000;
      animation: slideIn 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    
    /* ‚ïê‚ïê‚ïê RESPONSIVE ‚ïê‚ïê‚ïê */
    @media (max-width: 768px) {
      .two-col, .three-col { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .nav-tab { padding: 12px 14px; font-size: 12px; }
      .header h1 { font-size: 16px; }
      .header h1 span.subtitle { display: none; }
      .form-row { grid-template-columns: 1fr; }
      .action-bar { flex-direction: column; }
      .search-box { min-width: 100%; }
    }
    
    /* ‚ïê‚ïê‚ïê COLLAPSIBLE PANELS ‚ïê‚ïê‚ïê */
    .panel-header {
      cursor: pointer;
      user-select: none;
    }
    .panel-header:hover {
      background: rgba(0,0,0,0.02);
    }
    .panel-toggle {
      font-size: 12px;
      transition: transform 0.2s;
    }
    .panel-toggle.open {
      transform: rotate(180deg);
    }
    <!-- 
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  RED LEG BREWING - MULTI-ENTRY BREW LABOR UI
  Updated Brewer's Sheet to support multiple brew labor entries
  Replace the brew labor section in BRM_Labor_HTML_Additions.html with this
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-->

<style>
  /* Multi-entry brew labor styles */
  .brew-labor-section {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    border: 2px solid #d97706;
    border-radius: 8px;
    padding: 16px;
    margin: 16px 0;
  }
  
  .brew-labor-section h4 {
    margin: 0 0 12px 0;
    color: #92400e;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .brew-labor-entries {
    margin-bottom: 12px;
  }
  
  .brew-labor-entry-logged {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    padding: 8px 12px;
    border-radius: 6px;
    margin-bottom: 6px;
    border-left: 4px solid #22c55e;
  }
  
  .brew-labor-entry-logged .entry-name {
    font-weight: 600;
    color: #166534;
  }
  
  .brew-labor-entry-logged .entry-hours {
    color: #166534;
  }
  
  .brew-labor-entry-logged .entry-check {
    color: #22c55e;
    font-size: 18px;
  }
  
  .brew-labor-new-entry {
    background: white;
    padding: 12px;
    border-radius: 6px;
    border: 2px dashed #d97706;
  }
  
  .brew-labor-new-entry .entry-row {
    display: flex;
    gap: 12px;
    align-items: flex-end;
  }
  
  .brew-labor-new-entry .form-group {
    flex: 1;
  }
  
  .brew-labor-new-entry .form-group.hours-input {
    flex: 0 0 100px;
  }
  
  .brew-labor-new-entry .form-group.btn-group {
    flex: 0 0 auto;
  }
  
  .brew-labor-new-entry label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 4px;
  }
  
  .brew-labor-new-entry select,
  .brew-labor-new-entry input {
    width: 100%;
    padding: 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
  }
  
  .btn-log-hours {
    padding: 10px 16px;
    background: #22c55e;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    white-space: nowrap;
  }
  
  .btn-log-hours:hover {
    background: #16a34a;
  }
  
  .brew-labor-totals {
    display: flex;
    justify-content: space-between;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 2px solid #d97706;
  }
  
  .brew-labor-totals .total-label {
    font-weight: 600;
    color: #92400e;
  }
  
  .brew-labor-totals .total-value {
    font-weight: bold;
    font-size: 16px;
    color: #92400e;
  }
  
  .brew-labor-note {
    font-size: 11px;
    color: #b45309;
    margin-top: 8px;
    font-style: italic;
  }
  </style>
</head>
<body>
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       HEADER
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <header class="header">
    <h1>üç∫ RED LEG BRM <span class="subtitle">Brewery Resource Management</span></h1>
    <div class="header-right">
      <span class="header-date" id="currentDate"></span>
      <span class="header-badge">Veteran Owned</span>
    </div>
  </header>
  
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       NAVIGATION
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <nav class="nav-tabs">
    <button class="nav-tab active" data-tab="dashboard">üìä Dashboard</button>
    <button class="nav-tab" data-tab="production">üç∫ Production</button>
    <button class="nav-tab" data-tab="recipes">üìù Recipes</button>
    <button class="nav-tab" data-tab="raw-materials">üåæ Raw Materials</button>
    <button class="nav-tab" data-tab="finished-goods">üì¶ Finished Goods</button>
    <button class="nav-tab" data-tab="purchases">üõí Purchases</button>
    <button class="nav-tab" data-tab="sales">üíµ Sales</button>
    <button class="nav-tab" data-tab="taproom">üç∫ Taproom</button>
    <button class="nav-tab" data-tab="beer-cogs">üí∞ Beer COGS</button>
    <button class="nav-tab" data-tab="qb-journal">üìí QB Journal</button>
    <button class="nav-tab" data-tab="ttb">üìã TTB/Tax</button>
    <button class="nav-tab" data-tab="opex">üí≥ OpEx</button>
    <button class="nav-tab" data-tab="floor-pricing">üè∑Ô∏è Pricing</button>
    <button class="nav-tab" data-tab="yeast">üß´ Yeast</button>
  </nav>
  
  <div class="content">
    
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         DASHBOARD TAB
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="dashboard" class="tab-content active">
      <div id="dashboardAlerts"></div>
      
      <div class="stats-grid">
        <div class="stat-card highlight">
          <div class="stat-label">FCCR</div>
          <div class="stat-value" id="fccrValue">--</div>
          <div class="stat-sub" id="fccrStatus">Loading...</div>
        </div>
        <div class="stat-card success">
          <div class="stat-label">Finished Goods</div>
          <div class="stat-value" id="fgValue">$--</div>
          <div class="stat-sub">Packaged & Ready</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Raw Materials</div>
          <div class="stat-value" id="rmValue">$--</div>
          <div class="stat-sub">Ingredients & Supplies</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">WIP Batches</div>
          <div class="stat-value" id="wipCount">--</div>
          <div class="stat-sub">Fermenting/Conditioning</div>
        </div>
      </div>
      
      <div class="two-col">
        <div class="card">
          <div class="card-header"><span class="card-title">üìà Financial Health</span></div>
          <div class="card-body">
            <div style="margin-bottom: 20px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>Debt Service Coverage</span>
                <strong id="debtServiceDisplay">$--</strong>
              </div>
              <div class="progress-bar"><div class="progress-fill success" id="fccrProgress" style="width: 0%"></div></div>
              <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-light); margin-top: 5px;">
                <span>Covenant: 1.25x</span><span>Target: 1.35x</span>
              </div>
            </div>
            <div style="margin-bottom: 20px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>2026 OpEx Budget</span>
                <span><strong id="opexActual">$--</strong> / <span id="opexBudget">$--</span></span>
              </div>
              <div class="progress-bar"><div class="progress-fill" id="opexProgress" style="width: 0%"></div></div>
              <div style="text-align: right; font-size: 11px; color: var(--text-light); margin-top: 5px;">Variance: <span id="opexVariance">$--</span></div>
            </div>
            <div id="revenueBreakdown">
              <div style="display: flex; justify-content: space-between; padding: 12px 0; border-top: 1px solid var(--border);">
                <span>Net Revenue Target</span><strong id="revenueTarget">$--</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 8px 0; padding-left: 15px;">
                <span style="color: var(--text-light);">‚Ü≥ Taproom (<span id="taproomPct">40%</span>)</span><span id="taproomRev">$--</span>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 8px 0; padding-left: 15px;">
                <span style="color: var(--text-light);">‚Ü≥ Wholesale (<span id="wholesalePct">60%</span>)</span><span id="wholesaleRev">$--</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header"><span class="card-title">‚ö†Ô∏è Alerts & Actions</span></div>
          <div class="card-body" id="inventoryAlerts"><div class="loading">Loading...</div></div>
        </div>
      </div>
      
      <div class="two-col">
        <div class="card">
          <div class="card-header"><span class="card-title">üç∫ Batches In Progress</span></div>
          <div class="card-body" id="batchesInProgress"><div class="loading">Loading...</div></div>
        </div>
        <div class="card">
          <div class="card-header"><span class="card-title">üì¶ Low Stock Items</span></div>
          <div class="card-body" id="lowStockItems"><div class="loading">Loading...</div></div>
        </div>
      </div>
    </div>
    
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         PRODUCTION TAB
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="production" class="tab-content">
      <div class="action-bar">
        <div class="search-box"><input type="text" id="batchSearch" placeholder="Search batches..." oninput="filterBatchTable()"></div>
        <button class="btn btn-primary" onclick="showNewBatchModal()">+ New Batch</button>
      </div>
      
      <div class="filter-pills">
        <button class="filter-pill active" data-filter="all">All</button>
        <button class="filter-pill" data-filter="Planned">Planned</button>
        <button class="filter-pill" data-filter="Brewing">Brewing</button>
        <button class="filter-pill" data-filter="Fermenting">Fermenting</button>
        <button class="filter-pill" data-filter="Conditioning">Conditioning</button>
        <button class="filter-pill" data-filter="Ready to Package">Ready</button>
        <button class="filter-pill" data-filter="Packaged">Packaged</button>
      </div>
      
      <!-- Vessel Status Panel -->
      <div class="card" style="margin-bottom:15px;">
        <div class="card-header panel-header" onclick="togglePanel('vesselPanel')">
          <span class="card-title">üõ¢Ô∏è Vessel Status</span>
          <span class="panel-toggle" id="vesselPanelToggle">‚ñº</span>
        </div>
        <div id="vesselPanel" style="display:none;padding:15px;">
          <div id="vesselStatusGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;">
            <div class="loading">Loading vessels...</div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <span class="card-title">üìã Batch Log</span>
          <span class="badge badge-info" id="batchCount">0 batches</span>
        </div>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Batch #</th>
                <th>Brew Date</th>
                <th>Beer</th>
                <th>Brewer</th>
                <th>Vessel</th>
                <th style="text-align:right;">Size</th>
                <th style="text-align:right;">RM Cost</th>
                <th style="text-align:right;">Total Cost</th>
                <th>Status</th>
                <th style="text-align:right;">Yield</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="batchTableBody">
              <tr><td colspan="11" class="loading">Loading batches...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         RECIPES TAB
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="recipes" class="tab-content">
      <div class="card" style="margin-bottom:20px;">
        <div class="card-body" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
          <div>
            <h2 style="margin:0 0 5px 0;">üç∫ Recipe Manager</h2>
            <p style="color:var(--text-light);margin:0;">Manage recipes, ingredients, and brewing specs</p>
          </div>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-secondary" onclick="loadRecipes()">üîÑ Refresh</button>
            <button class="btn btn-primary" onclick="openNewRecipeModal()">+ New Recipe</button>
          </div>
        </div>
      </div>
      
      <div class="stats-grid" style="margin-bottom:20px;">
        <div class="stat-card">
          <div class="stat-label">Total Recipes</div>
          <div class="stat-value" id="recipesTotalCount">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Avg Batch Size</div>
          <div class="stat-value" id="recipesAvgBatch">-</div>
          <div class="stat-sub">BBL</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Most Common Style</div>
          <div class="stat-value" id="recipesTopStyle" style="font-size:16px;">-</div>
        </div>
      </div>
      
      <div class="action-bar">
        <div class="search-box">
          <input type="text" id="recipeSearch" placeholder="Search recipes..." onkeyup="filterRecipes()">
        </div>
        <select id="styleFilter" onchange="filterRecipes()" style="padding:10px;border:1px solid var(--border);border-radius:6px;">
          <option value="">All Styles</option>
        </select>
      </div>
      
      <div id="recipeGrid" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));gap:15px;">
        <div class="loading" style="grid-column:1/-1;">Loading recipes...</div>
      </div>
    </div>
    
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         RAW MATERIALS TAB
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="raw-materials" class="tab-content">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-label">Total Items</div><div class="stat-value" id="rmTotalItems">--</div></div>
        <div class="stat-card"><div class="stat-label">Inventory Value</div><div class="stat-value" id="rmTotalValue">$--</div></div>
        <div class="stat-card warning"><div class="stat-label">Need Reorder</div><div class="stat-value" id="rmLowStock">--</div></div>
        <div class="stat-card danger"><div class="stat-label">Out of Stock</div><div class="stat-value" id="rmOutOfStock">--</div></div>
      </div>
      
      <div class="action-bar">
        <button class="btn btn-primary" onclick="openAddMaterialModal()">+ Add Material</button>
        <button class="btn btn-secondary" onclick="openModal('importEkosModal')">üì• Import Ekos</button>
        <div class="search-box" style="flex:1;">
          <input type="text" id="rmSearchInput" placeholder="Search materials..." oninput="filterMaterials()">
        </div>
        <select id="rmCategoryFilter" onchange="filterMaterials()" style="padding:10px;border:1px solid var(--border);border-radius:6px;">
          <option value="">All Categories</option>
          <option value="Grain">üåæ Grain</option>
          <option value="Hops">üåø Hops</option>
          <option value="Yeast">üß´ Yeast</option>
          <option value="Adjuncts">üçØ Adjuncts</option>
          <option value="Finings">‚ú® Finings</option>
          <option value="Packaging">üì¶ Packaging</option>
          <option value="Chemicals">üß™ Chemicals</option>
        </select>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;">
          <input type="checkbox" id="rmLowStockFilter" onchange="filterMaterials()"> Low Stock
        </label>
      </div>
      
      <div class="card">
        <div class="card-header"><span class="card-title">üåæ Raw Materials Inventory</span></div>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Category</th>
                <th style="text-align:right;">Qty On Hand</th>
                <th>Unit</th>
                <th style="text-align:right;">Avg Cost</th>
                <th style="text-align:right;">Total Value</th>
                <th>Status</th>
                <th>Supplier</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="rmTableBody">
              <tr><td colspan="9" class="loading">Loading materials...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         FINISHED GOODS TAB
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="finished-goods" class="tab-content">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-label">Total FG Value</div><div class="stat-value" id="fgTotalValue">$--</div></div>
        <div class="stat-card"><div class="stat-label">Total Kegs</div><div class="stat-value" id="fgKegCount">--</div></div>
        <div class="stat-card"><div class="stat-label">Total Cases</div><div class="stat-value" id="fgCaseCount">--</div></div>
        <div class="stat-card warning"><div class="stat-label">Low Stock</div><div class="stat-value" id="fgLowCount">--</div></div>
      </div>
      
      <div class="action-bar">
        <button class="btn btn-primary" onclick="openAddFGModal()">+ Add SKU</button>
        <div class="search-box" style="flex:1;">
          <input type="text" id="fgSearchInput" placeholder="Search beer..." oninput="filterFG()">
        </div>
        <select id="fgPackageFilter" onchange="filterFG()" style="padding:10px;border:1px solid var(--border);border-radius:6px;">
          <option value="">All Packages</option>
          <option value="1/2 BBL Keg">1/2 BBL Keg</option>
          <option value="1/6 BBL Keg">1/6 BBL Keg</option>
          <option value="12oz Case">12oz Case</option>
          <option value="16oz Case">16oz Case</option>
        </select>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;">
          <input type="checkbox" id="fgLowStockFilter" onchange="filterFG()"> Low Stock
        </label>
      </div>
      
      <div class="card">
        <div class="card-header"><span class="card-title">üì¶ Finished Goods Inventory</span></div>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Beer</th>
                <th>Package</th>
                <th style="text-align:right;">On Hand</th>
                <th style="text-align:right;">Cost/Unit</th>
                <th style="text-align:right;">Total Value</th>
                <th style="text-align:right;">Floor Price</th>
                <th style="text-align:right;">Min Qty</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="fgTableBody">
              <tr><td colspan="9" class="loading">Loading inventory...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         PURCHASES TAB
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="purchases" class="tab-content">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-label">YTD Purchases</div><div class="stat-value" id="purchaseYTD">$--</div></div>
        <div class="stat-card"><div class="stat-label">This Month</div><div class="stat-value" id="purchaseMonth">$--</div></div>
        <div class="stat-card warning"><div class="stat-label">Pending Receipt</div><div class="stat-value" id="purchasePending">--</div></div>
      </div>
      
      <div class="action-bar">
        <button class="btn btn-primary" onclick="showNewPurchaseModal()">+ New Purchase</button>
        <div class="search-box" style="flex:1;">
          <input type="text" id="purchaseSearch" placeholder="Search purchases..." oninput="filterPurchases()">
        </div>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;">
          <input type="checkbox" id="purchasePendingFilter" onchange="filterPurchases()"> Pending Only
        </label>
      </div>
      
      <div class="card">
        <div class="card-header"><span class="card-title">üõí Purchase Log</span></div>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>PO #</th>
                <th>Supplier</th>
                <th>Item</th>
                <th style="text-align:right;">Qty</th>
                <th style="text-align:right;">Cost/Unit</th>
                <th style="text-align:right;">Total</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="purchaseTableBody">
              <tr><td colspan="9" class="loading">Loading purchases...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         SALES TAB
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="sales" class="tab-content">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-label">YTD Revenue</div><div class="stat-value" id="salesYTDRev">$--</div></div>
        <div class="stat-card"><div class="stat-label">YTD COGS</div><div class="stat-value" id="salesYTDCogs">$--</div></div>
        <div class="stat-card success"><div class="stat-label">YTD Gross Profit</div><div class="stat-value" id="salesYTDProfit">$--</div></div>
        <div class="stat-card"><div class="stat-label">Gross Margin</div><div class="stat-value" id="salesYTDMargin">--%</div></div>
      </div>
      
      <div class="action-bar">
        <button class="btn btn-primary" onclick="openNewSaleModal()">+ New Sale</button>
        <button class="btn btn-secondary" onclick="openToastImport()">üì§ Toast Import</button>
        <div class="search-box" style="flex:1;">
          <input type="text" id="salesSearchInput" placeholder="Search sales..." oninput="filterSales()">
        </div>
        <select id="salesChannelFilter" onchange="filterSales()" style="padding:10px;border:1px solid var(--border);border-radius:6px;">
          <option value="">All Channels</option>
          <option value="Taproom">Taproom</option>
          <option value="Wholesale - Direct">Wholesale - Direct</option>
          <option value="Wholesale - Distributor">Distributor</option>
          <option value="Military - AAFES">Military - AAFES</option>
        </select>
      </div>
      
      <div class="card">
        <div class="card-header"><span class="card-title">üíµ Sales Depletion Log</span></div>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Invoice #</th>
                <th>Customer</th>
                <th>Channel</th>
                <th>Beer</th>
                <th>Pkg</th>
                <th style="text-align:right;">Qty</th>
                <th style="text-align:right;">Revenue</th>
                <th style="text-align:right;">COGS</th>
                <th style="text-align:right;">Profit</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="salesTableBody">
              <tr><td colspan="11" class="loading">Loading sales...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         TAPROOM TAB (NEW - 85% of revenue!)
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="taproom" class="tab-content">
      <div class="stats-grid">
        <div class="stat-card highlight">
          <div class="stat-label">MTD Revenue</div>
          <div class="stat-value" id="taproomMTD">$--</div>
          <div class="stat-sub" id="taproomMTDvsTarget">-- vs target</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">YTD Revenue</div>
          <div class="stat-value" id="taproomYTD">$--</div>
          <div class="stat-sub">Taproom sales</div>
        </div>
        <div class="stat-card success">
          <div class="stat-label">Avg Daily</div>
          <div class="stat-value" id="taproomAvgDaily">$--</div>
          <div class="stat-sub" id="taproomDaysCount">-- days</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">MTD Tips</div>
          <div class="stat-value" id="taproomMTDTips">$--</div>
          <div class="stat-sub">For staff</div>
        </div>
      </div>
      
      <!-- Upload Section -->
      <div class="card" style="border:2px dashed var(--primary);margin-bottom:20px;">
        <div class="card-body">
          <div id="uploadZone" style="text-align:center;padding:30px;cursor:pointer;" onclick="document.getElementById('toastFileInput').click();">
            <div style="font-size:48px;margin-bottom:10px;">üì§</div>
            <h3 style="margin:0 0 10px 0;">Upload Toast Daily Report</h3>
            <p style="color:var(--text-light);margin:0;">Drag & drop CSV file here, or click to browse</p>
            <p style="color:var(--text-light);font-size:12px;margin-top:10px;">Accepts Toast Sales Summary CSV export</p>
            <input type="file" id="toastFileInput" accept=".csv,.xlsx,.xls" style="display:none;" onchange="handleToastFile(this.files[0])">
          </div>
          <div id="uploadProgress" style="display:none;text-align:center;padding:20px;">
            <div style="font-size:24px;margin-bottom:10px;">‚è≥</div>
            <p>Processing file...</p>
          </div>
          <div id="uploadResult" style="display:none;"></div>
        </div>
      </div>
      
      <!-- Quick Actions -->
      <div class="action-bar">
        <div class="form-group" style="margin:0;">
          <select id="taproomMonth" onchange="loadTaproomData()" style="padding:10px;border:1px solid var(--border);border-radius:6px;">
            <option value="1">January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
        </div>
        <div class="form-group" style="margin:0;">
          <select id="taproomYear" onchange="loadTaproomData()" style="padding:10px;border:1px solid var(--border);border-radius:6px;"></select>
        </div>
        <button class="btn btn-secondary" onclick="loadTaproomData()">üîÑ Refresh</button>
        <button class="btn btn-outline" onclick="openTaproomSheet()">üìã Open Sheet</button>
        <button class="btn btn-outline" onclick="addManualToastEntry()">+ Manual Entry</button>
        <div style="flex:1;"></div>
        <span id="taproomMissingAlert" style="color:var(--danger);font-weight:600;display:none;">‚ö†Ô∏è <span id="missingDaysCount">0</span> days missing</span>
      </div>
      
      <!-- Two Column Layout -->
      <div class="two-col">
        <!-- Daily Sales Table -->
        <div class="card" style="grid-column: span 1;">
          <div class="card-header">
            <span class="card-title">üìÖ Daily Sales</span>
            <span class="badge badge-info" id="taproomDaysBadge">0 days</span>
          </div>
          <div class="table-container" style="max-height:500px;overflow-y:auto;">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Day</th>
                  <th style="text-align:right;">Cash</th>
                  <th style="text-align:right;">Card</th>
                  <th style="text-align:right;">Total</th>
                  <th style="text-align:right;">Tips</th>
                  <th style="text-align:right;">Tax</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="taproomTableBody">
                <tr><td colspan="8" class="loading">Loading sales data...</td></tr>
              </tbody>
              <tfoot id="taproomTableFoot" style="background:#f7fafc;font-weight:600;">
              </tfoot>
            </table>
          </div>
        </div>
        
        <!-- Insights Panel -->
        <div>
          <!-- Day of Week Analysis -->
          <div class="card" style="margin-bottom:15px;">
            <div class="card-header"><span class="card-title">üìä Best Days</span></div>
            <div class="card-body" id="dayOfWeekAnalysis">
              <div class="loading">Loading...</div>
            </div>
          </div>
          
          <!-- Fees & Costs -->
          <div class="card" style="margin-bottom:15px;">
            <div class="card-header"><span class="card-title">üí≥ Fees & Costs</span></div>
            <div class="card-body">
              <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);">
                <span>Merchant Fees (MTD)</span>
                <strong id="taproomMerchantFees">$--</strong>
              </div>
              <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);">
                <span>Fee Rate</span>
                <span id="taproomFeeRate">--% of card</span>
              </div>
              <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);">
                <span>Discounts (MTD)</span>
                <strong id="taproomDiscounts">$--</strong>
              </div>
              <div style="display:flex;justify-content:space-between;padding:8px 0;">
                <span>Gift Cards Sold</span>
                <strong id="taproomGiftCards">$--</strong>
              </div>
            </div>
          </div>
          
          <!-- QB Journal Link -->
          <div class="card" style="background:linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);border:1px solid var(--success);">
            <div class="card-body" style="text-align:center;">
              <div style="font-size:32px;margin-bottom:10px;">üìí</div>
              <h4 style="margin:0 0 10px 0;">Ready for QuickBooks?</h4>
              <p style="color:var(--text-light);font-size:13px;margin-bottom:15px;">
                Generate journal entries from this data in the QB Journal tab.
              </p>
              <button class="btn btn-success" onclick="switchToQBJournal()">Go to QB Journal ‚Üí</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Manual Entry Modal (inline) -->
      <div id="manualEntryForm" style="display:none;margin-top:20px;" class="card">
        <div class="card-header">
          <span class="card-title">‚ûï Add Daily Sales Manually</span>
          <button class="btn-icon" onclick="document.getElementById('manualEntryForm').style.display='none'">‚úï</button>
        </div>
        <div class="card-body">
          <div class="form-row">
            <div class="form-group"><label>Date</label><input type="date" id="manualDate"></div>
            <div class="form-group"><label>Cash</label><input type="number" id="manualCash" step="0.01" placeholder="0.00"></div>
            <div class="form-group"><label>Card</label><input type="number" id="manualCard" step="0.01" placeholder="0.00"></div>
            <div class="form-group"><label>Gift Cards Redeemed</label><input type="number" id="manualGiftRedeemed" step="0.01" placeholder="0.00"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Net Sales</label><input type="number" id="manualNetSales" step="0.01" placeholder="0.00"></div>
            <div class="form-group"><label>Merchandise</label><input type="number" id="manualMerch" step="0.01" placeholder="0.00"></div>
            <div class="form-group"><label>Sales Tax</label><input type="number" id="manualTax" step="0.01" placeholder="0.00"></div>
            <div class="form-group"><label>Tips</label><input type="number" id="manualTips" step="0.01" placeholder="0.00"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Merchant Fees</label><input type="number" id="manualFees" step="0.01" placeholder="0.00"></div>
            <div class="form-group"><label>Discounts</label><input type="number" id="manualDiscounts" step="0.01" placeholder="0.00"></div>
            <div class="form-group"><label>Gift Cards Sold</label><input type="number" id="manualGiftSold" step="0.01" placeholder="0.00"></div>
            <div class="form-group"><label>Gross Receipts</label><input type="number" id="manualGross" step="0.01" placeholder="0.00"></div>
          </div>
          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:15px;">
            <button class="btn btn-secondary" onclick="document.getElementById('manualEntryForm').style.display='none'">Cancel</button>
            <button class="btn btn-primary" onclick="saveManualEntry()">üíæ Save Entry</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         BEER COGS TAB (NEW)
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="beer-cogs" class="tab-content">
      <div class="card" style="margin-bottom:20px;">
        <div class="card-body" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
          <div>
            <h2 style="margin:0 0 5px 0;">üí∞ Beer COGS Master</h2>
            <p style="color:var(--text-light);margin:0;">Real production costs with ingredients, labor, and yield calculations</p>
          </div>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-secondary" onclick="loadBeerCOGS()">üîÑ Refresh</button>
            <button class="btn btn-primary" onclick="recalculateCOGS()">üìä Recalculate All</button>
          </div>
        </div>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card success">
          <div class="stat-label">Lowest COGS</div>
          <div class="stat-value" id="cogsLowest">$--</div>
          <div class="stat-sub" id="cogsLowestBeer">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Average COGS</div>
          <div class="stat-value" id="cogsAverage">$--</div>
          <div class="stat-sub">per BBL</div>
        </div>
        <div class="stat-card danger">
          <div class="stat-label">Highest COGS</div>
          <div class="stat-value" id="cogsHighest">$--</div>
          <div class="stat-sub" id="cogsHighestBeer">--</div>
        </div>
        <div class="stat-card highlight">
          <div class="stat-label">Labor Cost/Batch</div>
          <div class="stat-value" id="cogsLaborBatch">$--</div>
          <div class="stat-sub">from Labor Config</div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <span class="card-title">üç∫ Production Costs by Beer</span>
          <span class="badge badge-info" id="cogsCount">0 beers</span>
        </div>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Beer</th>
                <th style="text-align:right;">Batch Size</th>
                <th style="text-align:right;">Yield %</th>
                <th style="text-align:right;">Expected BBL</th>
                <th style="text-align:right;">Ingredients</th>
                <th style="text-align:right;">Labor</th>
                <th style="text-align:right;">Total Batch</th>
                <th style="text-align:right;">COGS/BBL</th>
                <th style="text-align:right;">Floor Price</th>
                <th style="text-align:right;">Margin</th>
              </tr>
            </thead>
            <tbody id="cogsTableBody">
              <tr><td colspan="10" class="loading">Loading COGS data...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <div class="two-col" style="margin-top:20px;">
        <div class="card">
          <div class="card-header"><span class="card-title">üìä Yield % Guide</span></div>
          <div class="card-body">
            <table style="width:100%;font-size:14px;">
              <tr><td><strong>Clean Lagers</strong></td><td style="text-align:right;">96-97%</td></tr>
              <tr><td><strong>Standard Ales</strong></td><td style="text-align:right;">95%</td></tr>
              <tr><td><strong>Hoppy IPAs (dry hop loss)</strong></td><td style="text-align:right;">92-94%</td></tr>
              <tr><td><strong>Fruited Sours</strong></td><td style="text-align:right;">90-93%</td></tr>
              <tr><td><strong>High Gravity</strong></td><td style="text-align:right;">90-92%</td></tr>
            </table>
            <p style="margin-top:15px;font-size:12px;color:var(--text-light);">
              Edit yield % in the <strong>Recipes</strong> sheet to adjust per-beer calculations.
            </p>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><span class="card-title">üíµ Cost Breakdown</span></div>
          <div class="card-body">
            <div style="margin-bottom:15px;">
              <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                <span>Ingredients</span>
                <span id="cogsIngredientsPct">--</span>
              </div>
              <div class="progress-bar"><div class="progress-fill success" id="cogsIngredientsBar" style="width:0%"></div></div>
            </div>
            <div style="margin-bottom:15px;">
              <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                <span>Labor</span>
                <span id="cogsLaborPct">--</span>
              </div>
              <div class="progress-bar"><div class="progress-fill warning" id="cogsLaborBar" style="width:0%"></div></div>
            </div>
            <p style="font-size:12px;color:var(--text-light);margin-top:10px;">
              Labor from <strong>Labor Config</strong>: $<span id="cogsLaborRate">--</span>/batch
            </p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         QB JOURNAL TAB (NEW)
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="qb-journal" class="tab-content">
      <div class="alert alert-success">
        üìí Generate QuickBooks journal entries automatically from BRM data. <strong>Saves ~15+ hours/month!</strong>
      </div>
      
      <div class="two-col">
        <div class="card">
          <div class="card-header"><span class="card-title">üìÖ Generate Monthly Entries</span></div>
          <div class="card-body">
            <p style="color:var(--text-light);margin-bottom:20px;">
              Generate all recurring journal entries for a month with one click.
            </p>
            <div class="form-row">
              <div class="form-group">
                <label>Year</label>
                <select id="qbYear"></select>
              </div>
              <div class="form-group">
                <label>Month</label>
                <select id="qbMonth">
                  <option value="1">January</option>
                  <option value="2">February</option>
                  <option value="3">March</option>
                  <option value="4">April</option>
                  <option value="5">May</option>
                  <option value="6">June</option>
                  <option value="7">July</option>
                  <option value="8">August</option>
                  <option value="9">September</option>
                  <option value="10">October</option>
                  <option value="11">November</option>
                  <option value="12">December</option>
                </select>
              </div>
            </div>
            <button class="btn btn-primary" onclick="generateQBEntries()" style="width:100%;margin-top:10px;" id="generateQBBtn">
              <span class="btn-text">üìä Generate Journal Entries</span>
              <span class="btn-loading" style="display:none;">Generating...</span>
            </button>
            
            <div id="qbGenerateResult" style="display:none;margin-top:20px;padding:15px;background:#f0fff4;border-radius:8px;border:1px solid #38a169;">
              <h4 style="color:#276749;margin:0 0 10px 0;">‚úÖ Entries Generated!</h4>
              <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                <span>Journal Entries:</span><strong id="qbEntryCount">--</strong>
              </div>
              <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                <span>Total Lines:</span><strong id="qbLineCount">--</strong>
              </div>
              <p style="font-size:12px;color:var(--text-light);margin:0;">
                View <strong>QB Journal Export</strong> sheet to review.
              </p>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header"><span class="card-title">‚öôÔ∏è What Gets Generated</span></div>
          <div class="card-body" style="font-size:14px;">
            <h4 style="margin:0 0 8px 0;font-size:13px;text-transform:uppercase;color:var(--text-light);">Monthly Recurring</h4>
            <ul style="margin:0 0 15px 20px;color:var(--text);">
              <li>Depreciation ($12,595)</li>
              <li>Property Tax Accrual ($3,584)</li>
              <li>Rent to View Properties (seasonal)</li>
              <li>Management Fee ($5,000)</li>
              <li>Loan Amortization ($205)</li>
            </ul>
            
            <h4 style="margin:0 0 8px 0;font-size:13px;text-transform:uppercase;color:var(--text-light);">Calculated</h4>
            <ul style="margin:0 0 15px 20px;color:var(--text);">
              <li>Federal Excise Tax ($3.50/BBL)</li>
              <li>Colorado State Tax ($0.08/gal)</li>
              <li>Allocated Brewing Costs (75/25)</li>
            </ul>
            
            <h4 style="margin:0 0 8px 0;font-size:13px;text-transform:uppercase;color:var(--text-light);">Toast Sales (if data present)</h4>
            <ul style="margin:0 0 0 20px;color:var(--text);">
              <li>Daily cash, card, tips, tax</li>
              <li>~8-10 lines per day (~240/month)</li>
            </ul>
          </div>
        </div>
      </div>
      
      <!-- Toast Data Status -->
      <div class="card" style="margin-top:20px;border:2px solid var(--warning);">
        <div class="card-header" style="background:linear-gradient(135deg, #d69e2e 0%, #b7791f 100%);color:white;">
          <span class="card-title" style="color:white;">üçû Taproom Data Status</span>
          <button class="btn btn-sm" style="background:white;color:#b7791f;" onclick="switchToTab('taproom')">üìä Go to Taproom ‚Üí</button>
        </div>
        <div class="card-body">
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;">
            <div style="text-align:center;padding:15px;background:#fffbeb;border-radius:8px;">
              <div style="font-size:11px;color:#92400e;text-transform:uppercase;margin-bottom:5px;">Days Loaded</div>
              <div style="font-size:28px;font-weight:700;color:#d69e2e;" id="qbToastDays">--</div>
            </div>
            <div style="text-align:center;padding:15px;background:#fffbeb;border-radius:8px;">
              <div style="font-size:11px;color:#92400e;text-transform:uppercase;margin-bottom:5px;">Month Revenue</div>
              <div style="font-size:28px;font-weight:700;color:#d69e2e;" id="qbToastRevenue">$--</div>
            </div>
            <div style="text-align:center;padding:15px;background:#fffbeb;border-radius:8px;">
              <div style="font-size:11px;color:#92400e;text-transform:uppercase;margin-bottom:5px;">Missing Days</div>
              <div style="font-size:28px;font-weight:700;color:#d69e2e;" id="qbToastMissing">--</div>
            </div>
          </div>
          <p style="margin:15px 0 0 0;font-size:13px;color:var(--text-light);text-align:center;">
            Upload Toast daily reports in the <strong>üç∫ Taproom</strong> tab before generating journal entries.
          </p>
        </div>
      </div>
      
      <div class="card" style="margin-top:20px;">
        <div class="card-header">
          <span class="card-title">üìù Recurring Entries Config</span>
          <button class="btn btn-secondary btn-sm" onclick="openRecurringConfig()">‚öôÔ∏è Edit Config</button>
        </div>
        <div class="card-body">
          <p style="color:var(--text-light);margin-bottom:15px;font-size:14px;">
            Edit monthly amounts in <strong>Recurring Entries Config</strong> sheet. Different amounts per month for seasonal variations (like rent).
          </p>
          <div class="table-container" style="max-height:250px;overflow-y:auto;">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Entry</th>
                  <th>Debit Account</th>
                  <th>Credit Account</th>
                  <th style="text-align:right;">This Month</th>
                </tr>
              </thead>
              <tbody id="recurringConfigPreview">
                <tr><td colspan="4" class="loading">Loading config...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <div class="card" style="margin-top:20px;">
        <div class="card-header"><span class="card-title">üì§ Export to QuickBooks</span></div>
        <div class="card-body">
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn btn-outline" onclick="exportQBToCSV()">üìÅ Download CSV</button>
            <button class="btn btn-outline" onclick="viewQBExportSheet()">üìã View Export Sheet</button>
          </div>
          <p style="margin-top:15px;font-size:13px;color:var(--text-light);">
            Export CSV ‚Üí Import into QuickBooks via <strong>File ‚Üí Utilities ‚Üí Import ‚Üí Journal Entries</strong>
          </p>
        </div>
      </div>
    </div>
    
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         TTB/TAX TAB (UPDATED with Colorado)
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="ttb" class="tab-content">
      <div class="alert alert-warning">
        ‚ö†Ô∏è This is a <strong>GUIDE</strong> for TTB Form 5130.9 and Colorado DR 0447. Always verify with your accountant before filing.
      </div>
      
      <div class="form-row" style="margin-bottom:20px;">
        <div class="form-group">
          <label>Report Year</label>
          <select id="ttbYear"></select>
        </div>
        <div class="form-group">
          <label>Report Month</label>
          <select id="ttbMonth">
            <option value="1">January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
        </div>
        <div class="form-group" style="display:flex;align-items:flex-end;">
          <button class="btn btn-primary" onclick="generateTTBReport()">Generate Report</button>
        </div>
      </div>
      
      <div class="two-col">
        <div class="card">
          <div class="card-header"><span class="card-title">üìä Part I - Production (Barrels)</span></div>
          <div class="card-body">
            <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);"><span>Beginning Inventory</span><strong id="ttbBeginInv">--</strong></div>
            <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);"><span>Beer Produced</span><strong id="ttbProduced">--</strong></div>
            <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);"><span>Total</span><strong id="ttbTotal">--</strong></div>
            <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);"><span>Ending Inventory</span><strong id="ttbEndInv">--</strong></div>
            <div style="display:flex;justify-content:space-between;padding:15px;background:#f7fafc;margin:15px -20px -20px;border-radius:0 0 12px 12px;">
              <span><strong>Removals for Tax</strong></span><strong id="ttbRemovals">--</strong>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header" style="background:linear-gradient(135deg, #1a365d 0%, #2c5282 100%);color:white;">
            <span class="card-title" style="color:white;">üèõÔ∏è Federal Excise Tax (TTB 5130.9)</span>
          </div>
          <div class="card-body">
            <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);"><span>Federal Rate (CBMTRA)</span><strong>$3.50/BBL</strong></div>
            <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);"><span>Taxable Barrels</span><strong id="ttbTaxableBBL">--</strong></div>
            <div style="display:flex;justify-content:space-between;padding:15px;background:linear-gradient(135deg, #1a365d 0%, #2c5282 100%);color:white;margin:15px -20px -20px;border-radius:0 0 12px 12px;">
              <span><strong>FEDERAL TAX DUE</strong></span><strong id="ttbFederalTaxDue">$--</strong>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Colorado State Tax -->
      <div class="card" style="margin-top:20px;">
        <div class="card-header" style="background:linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);color:white;">
          <span class="card-title" style="color:white;">üèîÔ∏è Colorado State Tax (DR 0447)</span>
        </div>
        <div class="card-body">
          <div class="two-col" style="gap:30px;">
            <div>
              <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);"><span>Colorado Tax Rate</span><strong>$0.08/gallon</strong></div>
              <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);"><span>Rate per BBL (31 gal)</span><strong>$2.48/BBL</strong></div>
              <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);"><span>In-State Taxable Barrels</span><strong id="ttbColoradoBBL">--</strong></div>
              <div style="display:flex;justify-content:space-between;padding:10px 0;"><span>Taxable Gallons</span><strong id="ttbColoradoGallons">--</strong></div>
            </div>
            <div style="display:flex;flex-direction:column;justify-content:center;">
              <div style="background:linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);color:white;padding:25px;border-radius:12px;text-align:center;">
                <div style="font-size:12px;opacity:0.9;margin-bottom:5px;text-transform:uppercase;">Colorado Tax Due</div>
                <div style="font-size:36px;font-weight:700;" id="ttbColoradoTaxDue">$--</div>
                <div style="font-size:11px;opacity:0.8;margin-top:5px;">Due: 20th of following month</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Total Tax Summary -->
      <div class="card" style="margin-top:20px;">
        <div class="card-body" style="background:linear-gradient(135deg, var(--success) 0%, #276749 100%);color:white;border-radius:12px;padding:25px;">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:20px;">
            <div>
              <div style="font-size:12px;opacity:0.9;text-transform:uppercase;">Total Excise Tax Due</div>
              <div style="font-size:42px;font-weight:700;" id="ttbTotalTaxDue">$--</div>
            </div>
            <div style="text-align:right;">
              <div style="margin-bottom:5px;">Federal: <span id="ttbFederalSummary">$--</span></div>
              <div>Colorado: <span id="ttbColoradoSummary">$--</span></div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card" style="margin-top:20px;">
        <div class="card-body" style="text-align:center;color:var(--text-light);font-size:13px;">
          <p>üìù 1 BBL = 31 gallons = 117 12oz cans = 248 pints</p>
          <p style="margin-top:8px;">CBMTRA reduced rate of $3.50/BBL applies to first 60,000 BBL</p>
          <p style="margin-top:8px;"><strong>Due Dates:</strong> Federal: Semi-monthly (14th & last day) if >$50K/year | Colorado: 20th of following month</p>
        </div>
      </div>
    </div>
    
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         OPEX TAB
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="opex" class="tab-content">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-label">2026 Total Budget</div><div class="stat-value" id="opexTotalBudget">$--</div></div>
        <div class="stat-card"><div class="stat-label">YTD Actual</div><div class="stat-value" id="opexYTDActual">$--</div></div>
        <div class="stat-card"><div class="stat-label">YTD Budget</div><div class="stat-value" id="opexYTDBudget">$--</div></div>
        <div class="stat-card" id="opexVarianceCard"><div class="stat-label">Variance</div><div class="stat-value" id="opexVarianceValue">$--</div><div class="stat-sub" id="opexVarianceStatus">--</div></div>
      </div>
      
      <div class="card">
        <div class="card-header"><span class="card-title">üí≥ Operating Expenses by Category</span></div>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Category</th>
                <th style="text-align:right;">2025 Actual</th>
                <th style="text-align:right;">Growth %</th>
                <th style="text-align:right;">2026 Budget</th>
                <th style="text-align:right;">YTD Actual</th>
                <th style="text-align:right;">YTD Budget</th>
                <th style="text-align:right;">Variance</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="opexTableBody">
              <tr><td colspan="8" class="loading">Loading budget data...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         FLOOR PRICING TAB
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="floor-pricing" class="tab-content">
      <div class="alert alert-info">
        üè∑Ô∏è Floor prices ensure FCCR compliance. Prices below these minimums require approval.
      </div>
      
      <div class="two-col" style="margin-bottom:20px;">
        <div class="card">
          <div class="card-header"><span class="card-title">üìä Pricing Channels</span></div>
          <div class="card-body">
            <div style="margin-bottom:15px;">
              <h4 style="margin:0 0 5px 0;">Taproom (Floor Pricing)</h4>
              <p style="color:var(--text-light);font-size:13px;margin:0;">COGS + Taproom Margin. No sales overhead.</p>
            </div>
            <div>
              <h4 style="margin:0 0 5px 0;">B2B (Fully Loaded Pricing)</h4>
              <p style="color:var(--text-light);font-size:13px;margin:0;">COGS + $159/BBL sales overhead + 30% margin.</p>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><span class="card-title">üíµ Key Numbers</span></div>
          <div class="card-body">
            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);">
              <span>Sales Overhead (B2B)</span><strong>$158.92/BBL</strong>
            </div>
            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);">
              <span>Target Margin (B2B)</span><strong>30%</strong>
            </div>
            <div style="display:flex;justify-content:space-between;padding:8px 0;">
              <span>Target Margin (Taproom)</span><strong>70%+</strong>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header"><span class="card-title">üè∑Ô∏è Floor Pricing by Package</span></div>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Beer</th>
                <th style="text-align:right;">COGS/BBL</th>
                <th style="text-align:right;">1/2 BBL</th>
                <th style="text-align:right;">1/6 BBL</th>
                <th style="text-align:right;">Pint</th>
                <th style="text-align:right;">12oz Case</th>
                <th style="text-align:right;">16oz Case</th>
              </tr>
            </thead>
            <tbody id="floorPricingTableBody">
              <tr><td colspan="7" class="loading">Loading prices...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         YEAST PROPAGATION TAB
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="yeast" class="tab-content">
      <div class="card" style="margin-bottom:20px;">
        <div class="card-body" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
          <div>
            <h2 style="margin:0 0 5px 0;">üß´ Yeast Propagation Manager</h2>
            <p style="color:var(--text-light);margin:0;">Track yeast inventory, generations, costs, and traceability</p>
          </div>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-secondary" onclick="loadYeastData()">üîÑ Refresh</button>
            <button class="btn btn-primary" onclick="showNewP0Modal()">+ New P0 Propagation</button>
            <button class="btn btn-success" onclick="showHarvestModal()">üåæ Harvest Yeast</button>
          </div>
        </div>
      </div>
      
      <!-- Summary Stats -->
      <div class="stats-grid">
        <div class="stat-card highlight">
          <div class="stat-label">Active Pitches</div>
          <div class="stat-value" id="yeastActivePitches">--</div>
          <div class="stat-sub">Ready to use</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Pitches</div>
          <div class="stat-value" id="yeastTotalPitches">--</div>
          <div class="stat-sub">All time</div>
        </div>
        <div class="stat-card success">
          <div class="stat-label">Avg Generation</div>
          <div class="stat-value" id="yeastAvgGen">--</div>
          <div class="stat-sub">Active pitches</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Avg Cost/Pitch</div>
          <div class="stat-value" id="yeastAvgCost">$--</div>
          <div class="stat-sub">Weighted average</div>
        </div>
      </div>
      
      <!-- Strain Overview -->
      <div class="card" style="margin-bottom:20px;">
        <div class="card-header">
          <span class="card-title">üß™ Strain Overview</span>
          <button class="btn btn-sm btn-secondary" onclick="updateYeastCostsInRawMaterials()">üìä Update Raw Materials Costs</button>
        </div>
        <div class="card-body">
          <div id="strainOverviewGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:15px;">
            <div class="loading">Loading strains...</div>
          </div>
        </div>
      </div>
      
      <!-- Available Pitches Table -->
      <div class="card" style="margin-bottom:20px;">
        <div class="card-header">
          <span class="card-title">üì¶ Available Pitches</span>
          <span class="badge badge-success" id="yeastAvailableCount">0 available</span>
        </div>
        <div class="action-bar" style="padding:15px;border-bottom:1px solid var(--border);">
          <select id="yeastStrainFilter" onchange="filterYeastPitches()" style="padding:10px;border:1px solid var(--border);border-radius:6px;">
            <option value="">All Strains</option>
          </select>
          <select id="yeastStatusFilter" onchange="filterYeastPitches()" style="padding:10px;border:1px solid var(--border);border-radius:6px;">
            <option value="Active">Active Only</option>
            <option value="">All Status</option>
            <option value="Depleted">Depleted</option>
          </select>
        </div>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Pitch ID</th>
                <th>Strain</th>
                <th>Generation</th>
                <th>Date Created</th>
                <th style="text-align:right;">Volume (gal)</th>
                <th style="text-align:right;">Cost/Pitch</th>
                <th>Source</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="yeastTableBody">
              <tr><td colspan="9" class="loading">Loading yeast inventory...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Cost Analysis -->
      <div class="two-col">
        <div class="card">
          <div class="card-header"><span class="card-title">üí∞ Cost by Generation</span></div>
          <div class="card-body" id="yeastCostByGen">
            <div class="loading">Loading cost analysis...</div>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><span class="card-title">üìä Strain Cost Comparison</span></div>
          <div class="card-body" id="yeastStrainCosts">
            <div class="loading">Loading strain costs...</div>
          </div>
        </div>
      </div>
    </div>
   
  </div><!-- /content -->
  
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       MODALS
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  
<!-- Edit Finished Goods Modal -->
<div id="editFGModal" class="modal">
  <div class="modal-content" style="max-width:450px;">
    <div class="modal-header">
      <h2>‚úèÔ∏è Edit Finished Good</h2>
      <button class="close-btn" onclick="closeEditFGModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Beer</label>
        <input type="text" id="editFGBeer" readonly style="background:#f3f4f6;">
      </div>
      <div class="form-group">
        <label>Package</label>
        <input type="text" id="editFGPackage" readonly style="background:#f3f4f6;">
      </div>
      <div class="form-group">
        <label>Qty On Hand</label>
        <input type="number" id="editFGQty" step="1" min="0">
      </div>
      <div class="form-group">
        <label>Min Qty (Reorder Point)</label>
        <input type="number" id="editFGMinQty" step="1" min="0">
      </div>
      <div class="form-group">
        <label>Unit Cost ($)</label>
        <input type="number" id="editFGCost" step="0.01" min="0">
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeEditFGModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveEditFG()">üíæ Save</button>
    </div>
  </div>
</div>

<!-- Edit Raw Materials Modal -->
<div id="editRMModal" class="modal">
  <div class="modal-content" style="max-width:500px;">
    <div class="modal-header">
      <h2>‚úèÔ∏è Edit Raw Material</h2>
      <button class="close-btn" onclick="closeEditRMModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Item</label>
        <input type="text" id="editRMItem" readonly style="background:#f3f4f6;">
      </div>
      <div class="form-group">
        <label>Category</label>
        <input type="text" id="editRMCategory" readonly style="background:#f3f4f6;">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Qty On Hand</label>
          <input type="number" id="editRMQty" step="0.01" min="0">
        </div>
        <div class="form-group">
          <label>Unit</label>
          <input type="text" id="editRMUnit" readonly style="background:#f3f4f6;">
        </div>
      </div>
      <div class="form-group">
        <label>Avg Cost/Unit ($)</label>
        <input type="number" id="editRMCost" step="0.01" min="0">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Reorder Point</label>
          <input type="number" id="editRMReorderPoint" step="0.01" min="0">
        </div>
        <div class="form-group">
          <label>Reorder Qty</label>
          <input type="number" id="editRMReorderQty" step="0.01" min="0">
        </div>
      </div>
      <div class="form-group">
        <label>Supplier</label>
        <input type="text" id="editRMSupplier">
      </div>
      <div class="form-group">
        <label>Notes</label>
        <textarea id="editRMNotes" rows="2"></textarea>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeEditRMModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveEditRM()">üíæ Save</button>
    </div>
  </div>
</div>

  <!-- Recipe Detail Modal -->
  <div id="recipeModal" class="modal">
    <div class="modal-content" style="max-width:800px;">
      <div class="modal-header" id="recipeModalHeader" style="background:linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);color:white;">
        <div>
          <h2 id="recipeModalTitle" style="margin:0;">Recipe Name</h2>
          <div id="recipeModalStyle" style="font-size:14px;opacity:0.9;">Style</div>
        </div>
        <button class="close-btn" onclick="closeModal('recipeModal')" style="color:white;">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Quick Stats -->
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px;">
          <div style="text-align:center;padding:15px;background:#f7fafc;border-radius:8px;">
            <div style="font-size:24px;font-weight:700;" id="recipeModalBatchSize">60</div>
            <div style="font-size:11px;color:var(--text-light);text-transform:uppercase;">BBL</div>
          </div>
          <div style="text-align:center;padding:15px;background:#f7fafc;border-radius:8px;">
            <div style="font-size:24px;font-weight:700;" id="recipeModalABV">-</div>
            <div style="font-size:11px;color:var(--text-light);text-transform:uppercase;">ABV %</div>
          </div>
          <div style="text-align:center;padding:15px;background:#f7fafc;border-radius:8px;">
            <div style="font-size:24px;font-weight:700;" id="recipeModalIBU">-</div>
            <div style="font-size:11px;color:var(--text-light);text-transform:uppercase;">IBU</div>
          </div>
          <div style="text-align:center;padding:15px;background:#f7fafc;border-radius:8px;">
            <div style="font-size:24px;font-weight:700;" id="recipeModalYield">95%</div>
            <div style="font-size:11px;color:var(--text-light);text-transform:uppercase;">Yield</div>
          </div>
        </div>
        
        <!-- Ingredients -->
        <div class="two-col" style="gap:20px;">
          <div>
            <h4 style="margin:0 0 10px 0;display:flex;align-items:center;gap:8px;">üåæ Grains</h4>
            <div id="recipeModalGrains" style="font-size:14px;color:var(--text);">
              <p class="text-muted">No grain bill data</p>
            </div>
          </div>
          <div>
            <h4 style="margin:0 0 10px 0;display:flex;align-items:center;gap:8px;">üåø Hops</h4>
            <div id="recipeModalHops" style="font-size:14px;color:var(--text);">
              <p class="text-muted">No hop schedule data</p>
            </div>
          </div>
        </div>
        
        <div class="two-col" style="gap:20px;margin-top:20px;">
          <div>
            <h4 style="margin:0 0 10px 0;display:flex;align-items:center;gap:8px;">üß´ Yeast</h4>
            <div id="recipeModalYeast" style="font-size:14px;color:var(--text);">
              <p class="text-muted">No yeast data</p>
            </div>
          </div>
          <div>
            <h4 style="margin:0 0 10px 0;display:flex;align-items:center;gap:8px;">üçØ Adjuncts</h4>
            <div id="recipeModalAdjuncts" style="font-size:14px;color:var(--text);">
              <p class="text-muted">No adjuncts</p>
            </div>
          </div>
        </div>
        
        <!-- COGS Summary -->
        <div style="margin-top:20px;padding:15px;background:linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);border-radius:8px;border:1px solid var(--success);">
          <h4 style="margin:0 0 10px 0;color:#276749;">üí∞ Cost Summary</h4>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;">
            <div>
              <div style="font-size:12px;color:var(--text-light);">Ingredient Cost</div>
              <div style="font-size:18px;font-weight:600;" id="recipeModalIngredientCost">$--</div>
            </div>
            <div>
              <div style="font-size:12px;color:var(--text-light);">Labor Cost</div>
              <div style="font-size:18px;font-weight:600;" id="recipeModalLaborCost">$--</div>
            </div>
            <div>
              <div style="font-size:12px;color:var(--text-light);">COGS/BBL</div>
              <div style="font-size:18px;font-weight:600;color:var(--success);" id="recipeModalCOGS">$--</div>
            </div>
          </div>
        </div>
        
        <!-- Notes -->
        <div id="recipeModalNotesSection" style="margin-top:20px;display:none;">
          <h4 style="margin:0 0 10px 0;">üìù Brewing Notes</h4>
          <div id="recipeModalNotes" style="font-size:14px;color:var(--text);padding:10px;background:#f7fafc;border-radius:6px;"></div>
        </div>
        
        <!-- Actions -->
        <div class="modal-actions">
          <button class="btn btn-secondary" onclick="closeModal('recipeModal')">Close</button>
          <button class="btn btn-outline" onclick="openRecipeInSheet()">üìã View in Sheet</button>
          <button class="btn btn-secondary" onclick="closeModal('recipeModal'); openEditRecipeModal(currentRecipeName);">‚úèÔ∏è Edit Recipe</button>
          <button class="btn btn-primary" onclick="brewThisRecipe()">üç∫ Brew This</button>
        </div>
      </div>
    </div>
  </div>

  <!-- New P0 Propagation Modal -->
  <div id="newP0Modal" class="modal">
    <div class="modal-content" style="max-width:550px;">
      <div class="modal-header" style="background:linear-gradient(135deg,#8B0000,#a50000);color:white;">
        <h2 style="margin:0;">üß´ New P0 Propagation</h2>
        <button class="close-btn" onclick="closeModal('newP0Modal')" style="color:white;">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color:var(--text-light);font-size:13px;margin-bottom:20px;">
          Start a new yeast culture from purchased yeast. This is P0 - the initial propagation.
        </p>
        
        <div class="form-group">
          <label>Strain *</label>
          <select id="p0Strain" required onchange="updateP0Defaults()" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;">
            <option value="">Select strain...</option>
          </select>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>DME Used (lbs) *</label>
            <input type="number" id="p0DME" step="0.1" min="0" value="4.0" onchange="calculateP0Cost()" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;">
          </div>
          <div class="form-group">
            <label>Labor Hours *</label>
            <input type="number" id="p0Labor" step="0.1" min="0" value="1.0" onchange="calculateP0Cost()" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Nutrients</label>
            <input type="text" id="p0Nutrients" value="Yeastex" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;">
          </div>
          <div class="form-group">
            <label>Nutrient Cost ($)</label>
            <input type="number" id="p0NutrientCost" step="0.01" min="0" value="4.00" onchange="calculateP0Cost()" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;">
          </div>
        </div>
        
        <div class="form-group">
          <label>Initial Yeast Cost ($)</label>
          <input type="number" id="p0YeastCost" step="0.01" min="0" value="8.00" onchange="calculateP0Cost()" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;">
          <small style="color:#666;">Purchase cost for dry yeast or culture</small>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Date Created</label>
            <input type="date" id="p0Date" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;">
          </div>
          <div class="form-group">
            <label>Volume (gallons)</label>
            <input type="number" id="p0Volume" step="0.1" min="0" value="2.0" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;">
          </div>
        </div>
        
        <div class="form-group">
          <label>Cell Count (Billions)</label>
          <input type="number" id="p0CellCount" step="10" min="0" value="300" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;">
        </div>
        
        <div class="form-group">
          <label>Notes</label>
          <textarea id="p0Notes" rows="2" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;" placeholder="Optional notes..."></textarea>
        </div>
        
        <!-- Cost Preview -->
        <div style="background:#f8f9fa;border-radius:8px;padding:15px;margin-top:15px;">
          <h4 style="margin:0 0 10px 0;color:#555;">üí∞ Cost Preview</h4>
          <div style="display:flex;justify-content:space-between;padding:5px 0;"><span>DME Cost:</span><span id="p0DMECostPreview">$10.00</span></div>
          <div style="display:flex;justify-content:space-between;padding:5px 0;"><span>Nutrient Cost:</span><span id="p0NutrientCostPreview">$4.00</span></div>
          <div style="display:flex;justify-content:space-between;padding:5px 0;"><span>Initial Yeast:</span><span id="p0YeastCostPreview">$8.00</span></div>
          <div style="display:flex;justify-content:space-between;padding:5px 0;"><span>Labor Cost:</span><span id="p0LaborCostPreview">$25.00</span></div>
          <div style="display:flex;justify-content:space-between;padding:10px 0;border-top:1px solid #ddd;margin-top:5px;font-weight:600;">
            <span>Total Cost Per Pitch:</span>
            <span id="p0TotalCostPreview" style="color:#8B0000;font-size:18px;">$47.00</span>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('newP0Modal')">Cancel</button>
        <button class="btn btn-primary" onclick="submitNewP0()">üß´ Create P0 Propagation</button>
      </div>
    </div>
  </div>
  
  <!-- Harvest Yeast Modal -->
  <div id="harvestModal" class="modal">
    <div class="modal-content" style="max-width:550px;">
      <div class="modal-header" style="background:linear-gradient(135deg,#28a745,#218838);color:white;">
        <h2 style="margin:0;">üåæ Harvest Yeast from Batch</h2>
        <button class="close-btn" onclick="closeModal('harvestModal')" style="color:white;">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color:var(--text-light);font-size:13px;margin-bottom:20px;">
          Harvest yeast from a completed fermentation for the next batch.
        </p>
        
        <div class="form-group">
          <label>Source Pitch *</label>
          <select id="harvestParentPitch" required onchange="updateHarvestParentInfo()" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;">
            <option value="">Select pitch to harvest from...</option>
          </select>
          <small style="color:#666;">Select the pitch that was used in the source batch</small>
        </div>
        
        <div id="harvestParentInfo" style="display:none;background:#e8f4f8;border-radius:8px;padding:15px;margin:15px 0;">
          <h4 style="margin:0 0 10px 0;color:#0c5460;">Parent Pitch Info</h4>
          <div style="display:flex;justify-content:space-between;padding:4px 0;"><span>Strain:</span><strong id="harvestParentStrain">-</strong></div>
          <div style="display:flex;justify-content:space-between;padding:4px 0;"><span>Current Gen:</span><strong id="harvestParentGen">-</strong></div>
          <div style="display:flex;justify-content:space-between;padding:4px 0;"><span>New Generation:</span><strong id="harvestNewGen" style="color:#28a745;">-</strong></div>
          <div style="display:flex;justify-content:space-between;padding:4px 0;"><span>Parent Cost:</span><strong id="harvestParentCost">-</strong></div>
        </div>
        
        <div id="harvestSingleUseWarning" style="display:none;background:#fff3cd;border:1px solid #ffc107;border-radius:8px;padding:15px;margin:15px 0;color:#856404;">
          ‚ö†Ô∏è <strong>This strain is SINGLE USE ONLY</strong> and cannot be harvested. Use it once and discard.
        </div>
        
        <div class="form-group">
          <label>Source Batch # *</label>
          <input type="text" id="harvestSourceBatch" required placeholder="e.g., 1247" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;">
          <small style="color:#666;">Batch number the yeast was harvested from</small>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>DME for Step-up (lbs)</label>
            <input type="number" id="harvestDME" step="0.1" min="0" value="0" onchange="calculateHarvestCost()" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;">
            <small style="color:#666;">Usually 0 for direct harvest</small>
          </div>
          <div class="form-group">
            <label>Harvest Time (min)</label>
            <input type="number" id="harvestLabor" step="5" min="0" value="10" onchange="calculateHarvestCost()" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;">
            <small style="color:#666;">Typically ~10 minutes</small>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Volume (gallons)</label>
            <input type="number" id="harvestVolume" step="0.1" min="0" value="2.0" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;">
          </div>
          <div class="form-group">
            <label>Cell Count (Billions)</label>
            <input type="number" id="harvestCellCount" step="10" min="0" value="300" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;">
          </div>
        </div>
        
        <div class="form-group">
          <label>Notes</label>
          <textarea id="harvestNotes" rows="2" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;" placeholder="Optional notes..."></textarea>
        </div>
        
        <!-- Cost Preview -->
        <div style="background:#f0fff4;border-radius:8px;padding:15px;margin-top:15px;border:1px solid #c6f6d5;">
          <h4 style="margin:0 0 10px 0;color:#276749;">üí∞ Cost Preview</h4>
          <div style="display:flex;justify-content:space-between;padding:5px 0;"><span>DME Cost:</span><span id="harvestDMECostPreview">$0.00</span></div>
          <div style="display:flex;justify-content:space-between;padding:5px 0;"><span>Labor Cost (harvest):</span><span id="harvestLaborCostPreview">$4.17</span></div>
          <div style="display:flex;justify-content:space-between;padding:10px 0;border-top:1px solid #c6f6d5;margin-top:5px;font-weight:600;">
            <span>Total Cost Per Pitch:</span>
            <span id="harvestTotalCostPreview" style="color:#276749;font-size:18px;">$4.17</span>
          </div>
          <div id="harvestSavingsNote" style="color:#28a745;font-size:12px;text-align:right;margin-top:10px;"></div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('harvestModal')">Cancel</button>
        <button class="btn btn-success" id="harvestSubmitBtn" onclick="submitHarvest()">üåæ Create Harvest</button>
      </div>
    </div>
  </div>
  
  <!-- Use Pitch Modal -->
  <div id="usePitchModal" class="modal">
    <div class="modal-content" style="max-width:450px;">
      <div class="modal-header" style="background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;">
        <h2 style="margin:0;">üç∫ Use Pitch for Batch</h2>
        <button class="close-btn" onclick="closeModal('usePitchModal')" style="color:white;">&times;</button>
      </div>
      <div class="modal-body">
        <div id="usePitchInfo" style="background:#e0f2fe;border-radius:8px;padding:15px;margin-bottom:20px;">
          <div style="display:flex;justify-content:space-between;padding:4px 0;"><span>Pitch ID:</span><strong id="usePitchId">-</strong></div>
          <div style="display:flex;justify-content:space-between;padding:4px 0;"><span>Strain:</span><strong id="usePitchStrain">-</strong></div>
          <div style="display:flex;justify-content:space-between;padding:4px 0;"><span>Generation:</span><strong id="usePitchGen">-</strong></div>
          <div style="display:flex;justify-content:space-between;padding:4px 0;"><span>Cost:</span><strong id="usePitchCost">-</strong></div>
        </div>
        
        <div class="form-group">
          <label>Batch Number *</label>
          <input type="text" id="usePitchBatch" required placeholder="e.g., 1250" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;">
        </div>
        
        <div style="background:#fff3cd;border:1px solid #ffc107;border-radius:8px;padding:15px;margin-top:15px;color:#856404;">
          ‚ö†Ô∏è This will mark the pitch as used and decrement available pitches.
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('usePitchModal')">Cancel</button>
        <button class="btn btn-primary" onclick="submitUsePitch()">‚úÖ Mark Used</button>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="quick-actions">
    <button class="quick-action-btn" onclick="refreshCurrentTab()" title="Refresh">üîÑ</button>
  </div>
  
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       JAVASCRIPT - COMPLETE WORKING VERSION
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INITIALIZATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', { 
        weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' 
      });
      
      var currentYear = new Date().getFullYear();
      ['ttbYear', 'qbYear', 'taproomYear'].forEach(function(id) {
        var select = document.getElementById(id);
        if (select) {
          select.innerHTML = '<option value="' + (currentYear - 1) + '">' + (currentYear - 1) + '</option>' +
            '<option value="' + currentYear + '" selected>' + currentYear + '</option>' +
            '<option value="' + (currentYear + 1) + '">' + (currentYear + 1) + '</option>';
        }
      });
      
      var currentMonth = new Date().getMonth() + 1;
      ['ttbMonth', 'qbMonth', 'taproomMonth'].forEach(function(id) {
        var select = document.getElementById(id);
        if (select) select.value = currentMonth;
      });
      
      initTabs();
      loadDashboardData();
    });
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TAB NAVIGATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    var currentTab = 'dashboard';
    
    function initTabs() {
      document.querySelectorAll('.nav-tab').forEach(function(tab) {
        tab.addEventListener('click', function() {
          document.querySelectorAll('.nav-tab').forEach(function(t) { t.classList.remove('active'); });
          this.classList.add('active');
          document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
          var tabId = this.dataset.tab;
          document.getElementById(tabId).classList.add('active');
          currentTab = tabId;
          loadTabData(tabId);
        });
      });
      
      document.querySelectorAll('.filter-pill').forEach(function(pill) {
        pill.addEventListener('click', function() {
          this.closest('.filter-pills').querySelectorAll('.filter-pill').forEach(function(p) { p.classList.remove('active'); });
          this.classList.add('active');
          applyFilter(this.dataset.filter);
        });
      });
    }
    
    function loadTabData(tabId) {
      switch(tabId) {
        case 'dashboard': loadDashboardData(); break;
        case 'production': loadBatches(); break;
        case 'recipes': loadRecipes(); break;
        case 'raw-materials': loadRawMaterials(); break;
        case 'finished-goods': loadFinishedGoods(); break;
        case 'purchases': loadPurchases(); break;
        case 'sales': loadSales(); break;
        case 'taproom': loadTaproomData(); break;
        case 'beer-cogs': loadBeerCOGS(); break;
        case 'qb-journal': loadQBJournal(); break;
        case 'ttb': break;
        case 'opex': loadOpEx(); break;
        case 'floor-pricing': loadFloorPricing(); break;
      }
    }
    
    function refreshCurrentTab() {
      loadTabData(currentTab);
      showToast('Refreshed!', 'success');
    }
    
    function switchToTab(tabId) {
      document.querySelector('[data-tab="' + tabId + '"]').click();
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // UTILITIES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function showToast(message, type) {
      var existing = document.querySelector('.toast');
      if (existing) existing.remove();
      
      var toast = document.createElement('div');
      toast.className = 'toast toast-' + (type || 'info');
      toast.innerHTML = message;
      toast.style.cssText = 'position:fixed;bottom:20px;right:20px;padding:12px 20px;border-radius:8px;color:white;font-weight:500;z-index:9999;animation:slideIn 0.3s ease;';
      toast.style.background = type === 'success' ? '#38a169' : type === 'error' ? '#e53e3e' : type === 'warning' ? '#d69e2e' : '#8B0000';
      document.body.appendChild(toast);
      setTimeout(function() { toast.remove(); }, 4000);
    }
    
    function handleError(err) {
      console.error('Error:', err);
      showToast('Error: ' + err, 'error');
    }
    
    function formatNumber(num) {
      return (num || 0).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
    }
    
    function formatDate(date) {
      if (!date) return '-';
      var d = date instanceof Date ? date : new Date(date);
      return isNaN(d.getTime()) ? '-' : d.toLocaleDateString();
    }
    
    function formatDateShort(date) {
      if (!date) return '-';
      var d = date instanceof Date ? date : new Date(date);
      return isNaN(d.getTime()) ? '-' : (d.getMonth()+1) + '/' + d.getDate();
    }
    
    function escapeHtml(text) {
      if (!text) return '';
      return String(text).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }
    
    function getStatusBadge(status) {
      if (!status) return '';
      var s = status.toLowerCase();
      if (s.includes('brewing') || s.includes('ferment')) return 'badge-warning';
      if (s.includes('packaged') || s.includes('complete')) return 'badge-success';
      if (s.includes('dump') || s.includes('cancel')) return 'badge-danger';
      return 'badge-info';
    }
    
    function getStyleColor(style) {
      var colors = {
        'ipa': '#f6ad55', 'pale': '#faf089', 'amber': '#ed8936', 'red': '#fc8181',
        'stout': '#4a5568', 'porter': '#718096', 'wheat': '#fbd38d', 'lager': '#90cdf4',
        'pilsner': '#fefcbf', 'saison': '#fbd38d', 'sour': '#fbb6ce', 'blonde': '#faf089'
      };
      if (!style) return '#a0aec0';
      var s = style.toLowerCase();
      for (var key in colors) { if (s.includes(key)) return colors[key]; }
      return '#a0aec0';
    }
    
    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'flex';
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // DASHBOARD
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function loadDashboardData() {
      google.script.run.withSuccessHandler(updateDashboard).withFailureHandler(handleError).getDashboardData();
    }
    
    function updateDashboard(data) {
      if (!data) return;
      
      if (data.fccr && !data.fccr.error) {
        var fccr = data.fccr.projectedFCCR || 0;
        document.getElementById('fccrValue').textContent = fccr.toFixed(2) + 'x';
        document.getElementById('fccrStatus').textContent = fccr >= 1.35 ? '‚úÖ Above Target' : fccr >= 1.25 ? '‚ö†Ô∏è Meets Covenant' : 'üö® Below Covenant!';
        var progress = Math.min(100, Math.max(0, (fccr - 1.0) / 0.5 * 100));
        document.getElementById('fccrProgress').style.width = progress + '%';
        document.getElementById('fccrProgress').className = 'progress-fill ' + (fccr >= 1.35 ? 'success' : fccr >= 1.25 ? 'warning' : 'danger');
        document.getElementById('debtServiceDisplay').textContent = '$' + formatNumber(data.fccr.debtService || 0);
        document.getElementById('revenueTarget').textContent = '$' + formatNumber(data.fccr.netRevenueTarget || 0);
        document.getElementById('taproomPct').textContent = ((data.fccr.taproomPct || 0.85) * 100).toFixed(0) + '%';
        document.getElementById('wholesalePct').textContent = ((data.fccr.wholesalePct || 0.15) * 100).toFixed(0) + '%';
        document.getElementById('taproomRev').textContent = '$' + formatNumber(data.fccr.taproomRevenue || 0);
        document.getElementById('wholesaleRev').textContent = '$' + formatNumber(data.fccr.wholesaleRevenue || 0);
      }
      
      if (data.opex && !data.opex.error) {
        document.getElementById('opexActual').textContent = '$' + formatNumber(data.opex.ytdActual || 0);
        document.getElementById('opexBudget').textContent = '$' + formatNumber(data.opex.ytdBudget || 0);
        var variance = data.opex.variance || 0;
        document.getElementById('opexVariance').textContent = (variance >= 0 ? '+' : '') + '$' + formatNumber(Math.abs(variance));
        document.getElementById('opexVariance').style.color = variance >= 0 ? 'var(--success)' : 'var(--danger)';
        var pct = data.opex.ytdBudget > 0 ? (data.opex.ytdActual / data.opex.ytdBudget * 100) : 0;
        document.getElementById('opexProgress').style.width = Math.min(pct, 100) + '%';
        document.getElementById('opexProgress').className = 'progress-fill ' + (pct > 100 ? 'danger' : pct > 90 ? 'warning' : 'success');
      }
      
      document.getElementById('fgValue').textContent = '$' + formatNumber(data.finishedGoodsValue || 0);
      document.getElementById('rmValue').textContent = '$' + formatNumber(data.rawMaterialsValue || 0);
      document.getElementById('wipCount').textContent = data.batchesInProgress || 0;
      
      var alerts = [];
      if (data.lowStockItems > 0) alerts.push({ type: 'warning', text: data.lowStockItems + ' finished goods items low' });
      if (data.reorderNeeded > 0) alerts.push({ type: 'danger', text: data.reorderNeeded + ' raw materials need reorder' });
      if (alerts.length === 0) alerts.push({ type: 'success', text: 'All systems operational' });
      document.getElementById('dashboardAlerts').innerHTML = alerts.map(function(a) {
        return '<div class="alert alert-' + a.type + '">' + (a.type === 'danger' ? 'üö®' : a.type === 'warning' ? '‚ö†Ô∏è' : '‚úÖ') + ' ' + a.text + '</div>';
      }).join('');
      
      loadBatchesWidget();
      loadLowStockWidget();
      loadInventoryAlertsWidget();
    }
    
    function loadBatchesWidget() {
      google.script.run.withSuccessHandler(function(data) {
        var batches = (data.batches || []).filter(function(b) { 
          return b.status && !['Packaged', 'Dumped'].includes(b.status); 
        }).slice(0, 5);
        if (batches.length === 0) {
          document.getElementById('batchesInProgress').innerHTML = '<p class="text-muted">No batches in progress</p>';
          return;
        }
        document.getElementById('batchesInProgress').innerHTML = batches.map(function(b) {
          return '<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);">' +
            '<div><strong>' + escapeHtml(b.batchNumber || 'N/A') + '</strong> - ' + escapeHtml(b.beer || b.beerType || 'Unknown') +
            '<div style="font-size:12px;color:var(--text-light);">' + (b.size || b.batchSize || 0) + ' BBL</div></div>' +
            '<span class="badge ' + getStatusBadge(b.status) + '">' + b.status + '</span></div>';
        }).join('');
      }).getBatchesData({});
    }
    
    function loadLowStockWidget() {
      google.script.run.withSuccessHandler(function(data) {
        var lowStock = (data.inventory || []).filter(function(i) { 
          return i.status && (i.status.includes('LOW') || i.status.includes('üö®') || i.status.includes('OUT'));
        }).slice(0, 5);
        if (lowStock.length === 0) {
          document.getElementById('lowStockItems').innerHTML = '<p class="text-success">‚úÖ All items adequately stocked</p>';
          return;
        }
        document.getElementById('lowStockItems').innerHTML = lowStock.map(function(i) {
          return '<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);">' +
            '<div><strong>' + escapeHtml(i.beer || i.beerName) + '</strong><div style="font-size:12px;color:var(--text-light);">' + escapeHtml(i.package || i.packageType) + '</div></div>' +
            '<div style="text-align:right;"><span class="text-danger font-bold">' + (i.qtyOnHand || 0) + '</span><div style="font-size:11px;color:var(--text-light);">Min: ' + (i.minQty || 0) + '</div></div></div>';
        }).join('');
      }).getFinishedGoodsData({});
    }
    
    function loadInventoryAlertsWidget() {
      google.script.run.withSuccessHandler(function(data) {
        var alerts = [];
        var materials = data.materials || [];
        var lowStock = materials.filter(function(m) { return m.status && (m.status.includes('REORDER') || m.status.includes('‚ö†')); });
        var outOfStock = materials.filter(function(m) { return m.status && (m.status.includes('OUT') || m.status.includes('üö®')); });
        
        if (outOfStock.length > 0) alerts.push('<div class="alert alert-danger" style="margin-bottom:10px;">üö® <strong>' + outOfStock.length + '</strong> items out of stock</div>');
        if (lowStock.length > 0) alerts.push('<div class="alert alert-warning" style="margin-bottom:10px;">‚ö†Ô∏è <strong>' + lowStock.length + '</strong> items need reorder</div>');
        if (alerts.length === 0) alerts.push('<p class="text-success">‚úÖ All raw materials adequately stocked</p>');
        document.getElementById('inventoryAlerts').innerHTML = alerts.join('');
      }).getRawMaterialsInventory({});
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PRODUCTION / BATCHES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    var allBatches = [];
    var currentBatchFilter = 'all';
    
    function loadBatches() {
      document.getElementById('batchTableBody').innerHTML = '<tr><td colspan="11" class="loading">Loading batches...</td></tr>';
      google.script.run.withSuccessHandler(displayBatches).withFailureHandler(handleError).getBatchesData({});
      loadVesselStatus();
    }
    
    function displayBatches(result) {
      if (!result.success) {
        document.getElementById('batchTableBody').innerHTML = '<tr><td colspan="11">' + (result.error || 'Error') + '</td></tr>';
        return;
      }
      allBatches = result.batches || [];
      document.getElementById('batchCount').textContent = allBatches.length + ' batches';
      renderBatches(allBatches);
    }
    
    function renderBatches(batches) {
  if (batches.length === 0) {
    document.getElementById('batchTableBody').innerHTML = '<tr><td colspan="11" class="empty-state">No batches found</td></tr>';
    return;
  }
  document.getElementById('batchTableBody').innerHTML = batches.map(function(b) {
    var isActive = b.status && !['Packaged', 'Dumped', 'Cancelled'].includes(b.status);
    return '<tr>' +
      '<td><strong>' + escapeHtml(b.batchNumber) + '</strong></td>' +
      '<td>' + formatDate(b.brewDate || b.date) + '</td>' +
      '<td>' + escapeHtml(b.beerType || b.beer) + '</td>' +
      '<td>' + escapeHtml(b.brewer || '-') + '</td>' +
      '<td>' + escapeHtml(b.vessel || b.tank || '-') + '</td>' +
      '<td style="text-align:right;">' + (b.batchSize || b.size || 0) + ' BBL</td>' +
      '<td style="text-align:right;">$' + formatNumber(b.rawMaterialsCost || 0) + '</td>' +
      '<td style="text-align:right;">$' + formatNumber(b.totalCost || 0) + '</td>' +
      '<td><span class="badge ' + getStatusBadge(b.status) + '">' + (b.status || 'Unknown') + '</span></td>' +
      '<td style="text-align:right;">' + (b.actualYield || b.expectedYield || '--') + '</td>' +
      '<td class="batch-actions">' + (isActive ? renderBatchActions(b) : '<span class="text-muted">Complete</span>') + '</td>' +
    '</tr>';
  }).join('');
}
    
    function filterBatchTable() {
      var search = document.getElementById('batchSearch').value.toLowerCase();
      var filtered = allBatches.filter(function(b) {
        var matchSearch = !search || 
          (b.batchNumber || '').toLowerCase().includes(search) ||
          (b.beerType || b.beer || '').toLowerCase().includes(search) ||
          (b.brewer || '').toLowerCase().includes(search);
        var matchFilter = currentBatchFilter === 'all' || b.status === currentBatchFilter;
        return matchSearch && matchFilter;
      });
      renderBatches(filtered);
    }
    
    function applyFilter(filter) {
      currentBatchFilter = filter;
      filterBatchTable();
    }
    
    function loadVesselStatus() {
      google.script.run.withSuccessHandler(function(result) {
        if (!result || !result.success || !result.vessels) {
          document.getElementById('vesselStatusGrid').innerHTML = '<div class="text-muted">No vessel data</div>';
          return;
        }
        document.getElementById('vesselStatusGrid').innerHTML = result.vessels.map(function(v) {
          var isAvailable = v.status === 'Available';
          return '<div style="background:' + (isAvailable ? '#d4edda' : '#f8d7da') + ';border-radius:8px;padding:12px;text-align:center;">' +
            '<div style="font-weight:600;font-size:13px;">' + escapeHtml(v.name) + '</div>' +
            '<div style="font-size:11px;color:var(--text-light);">' + (v.capacity || 60) + ' BBL</div>' +
            '<div style="margin-top:6px;font-weight:600;color:' + (isAvailable ? '#155724' : '#721c24') + ';">' + v.status + '</div>' +
            (v.currentBatch ? '<div style="font-size:10px;margin-top:4px;">' + escapeHtml(v.currentBatch) + '</div>' : '') +
            '</div>';
        }).join('');
      }).getAvailableVessels();
    }
    
    function togglePanel(panelId) {
      var panel = document.getElementById(panelId);
      var toggle = document.getElementById(panelId + 'Toggle');
      if (panel.style.display === 'none') {
        panel.style.display = 'block';
        if (toggle) toggle.classList.add('open');
      } else {
        panel.style.display = 'none';
        if (toggle) toggle.classList.remove('open');
      }
    }
    
    // NEW BATCH - Opens Brewer Sheet from recipe
    function showNewBatchModal() {
      showToast('Select a recipe first, then click "Brew This"', 'info');
      switchToTab('recipes');
    }
    
    // VIEW BATCH DETAILS
    function viewBatch(batchNumber) {
      var batch = allBatches.find(function(b) { return b.batchNumber === batchNumber; });
      if (!batch) {
        showToast('Batch not found', 'error');
        return;
      }
      
      var modalHtml = '<div id="viewBatchModal" style="display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:2000;justify-content:center;align-items:center;padding:20px;">' +
        '<div style="background:white;border-radius:12px;max-width:600px;width:100%;max-height:90vh;overflow-y:auto;">' +
          '<div style="background:linear-gradient(135deg,#8B0000,#a50000);color:white;padding:20px;border-radius:12px 12px 0 0;">' +
            '<div style="display:flex;justify-content:space-between;align-items:center;">' +
              '<h2 style="margin:0;">üç∫ Batch Details</h2>' +
              '<button onclick="document.getElementById(\'viewBatchModal\').remove()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:36px;height:36px;border-radius:50%;cursor:pointer;">‚úï</button>' +
            '</div>' +
          '</div>' +
          '<div style="padding:24px;">' +
            '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">' +
              '<div><label style="font-size:12px;color:#666;">Batch Number</label><div style="font-weight:600;font-size:18px;">' + escapeHtml(batch.batchNumber) + '</div></div>' +
              '<div><label style="font-size:12px;color:#666;">Status</label><div><span class="badge ' + getStatusBadge(batch.status) + '">' + (batch.status || '-') + '</span></div></div>' +
              '<div><label style="font-size:12px;color:#666;">Beer</label><div style="font-weight:500;">' + escapeHtml(batch.beerType || batch.beer || '-') + '</div></div>' +
              '<div><label style="font-size:12px;color:#666;">Brew Date</label><div>' + formatDate(batch.brewDate || batch.date) + '</div></div>' +
              '<div><label style="font-size:12px;color:#666;">Brewer</label><div>' + escapeHtml(batch.brewer || '-') + '</div></div>' +
              '<div><label style="font-size:12px;color:#666;">Vessel</label><div>' + escapeHtml(batch.vessel || batch.tank || '-') + '</div></div>' +
              '<div><label style="font-size:12px;color:#666;">Batch Size</label><div>' + (batch.batchSize || batch.size || 0) + ' BBL</div></div>' +
              '<div><label style="font-size:12px;color:#666;">Expected Yield</label><div>' + (batch.expectedYield || '-') + ' BBL</div></div>' +
              '<div><label style="font-size:12px;color:#666;">Actual Yield</label><div>' + (batch.actualYield || '-') + ' BBL</div></div>' +
              '<div><label style="font-size:12px;color:#666;">Material Cost</label><div>$' + formatNumber(batch.rawMaterialsCost || 0) + '</div></div>' +
              '<div><label style="font-size:12px;color:#666;">Total Cost</label><div>$' + formatNumber(batch.totalCost || 0) + '</div></div>' +
              '<div><label style="font-size:12px;color:#666;">Cost/BBL</label><div>$' + formatNumber((batch.totalCost || 0) / (batch.batchSize || 1)) + '</div></div>' +
            '</div>' +
            (batch.notes ? '<div style="margin-top:16px;padding:12px;background:#f8f9fa;border-radius:8px;"><label style="font-size:12px;color:#666;">Notes</label><div>' + escapeHtml(batch.notes) + '</div></div>' : '') +
            '<div style="margin-top:20px;display:flex;gap:12px;justify-content:flex-end;">' +
              '<button onclick="document.getElementById(\'viewBatchModal\').remove()" style="padding:10px 20px;background:#e9ecef;border:none;border-radius:6px;cursor:pointer;">Close</button>' +
              '<button onclick="document.getElementById(\'viewBatchModal\').remove();updateBatchStatus(\'' + escapeHtml(batch.batchNumber) + '\',\'' + escapeHtml(batch.status || '') + '\')" style="padding:10px 20px;background:#8B0000;color:white;border:none;border-radius:6px;cursor:pointer;">Update Status</button>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    // UPDATE BATCH STATUS
    function updateBatchStatus(batchNumber, currentStatus) {
      var statuses = ['Brewing', 'Fermenting', 'Conditioning', 'Carbonating', 'Ready to Package', 'Packaged', 'Dumped'];
      
      var modalHtml = '<div id="updateStatusModal" style="display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:2000;justify-content:center;align-items:center;padding:20px;">' +
        '<div style="background:white;border-radius:12px;max-width:400px;width:100%;">' +
          '<div style="background:linear-gradient(135deg,#8B0000,#a50000);color:white;padding:20px;border-radius:12px 12px 0 0;">' +
            '<h2 style="margin:0;">üìä Update Status</h2>' +
            '<p style="margin:4px 0 0 0;opacity:0.9;">' + escapeHtml(batchNumber) + '</p>' +
          '</div>' +
          '<div style="padding:24px;">' +
            '<label style="display:block;font-weight:600;margin-bottom:8px;">New Status</label>' +
            '<select id="newBatchStatus" style="width:100%;padding:12px;border:1px solid #ccc;border-radius:6px;font-size:16px;">' +
              statuses.map(function(s) { return '<option value="' + s + '"' + (s === currentStatus ? ' selected' : '') + '>' + s + '</option>'; }).join('') +
            '</select>' +
            '<label style="display:block;font-weight:600;margin:16px 0 8px 0;">Actual Yield (BBL)</label>' +
            '<input type="number" id="batchActualYield" placeholder="Leave blank if not packaged" style="width:100%;padding:12px;border:1px solid #ccc;border-radius:6px;">' +
            '<label style="display:block;font-weight:600;margin:16px 0 8px 0;">Notes</label>' +
            '<textarea id="batchStatusNotes" rows="2" style="width:100%;padding:12px;border:1px solid #ccc;border-radius:6px;" placeholder="Optional notes..."></textarea>' +
            '<div style="margin-top:20px;display:flex;gap:12px;justify-content:flex-end;">' +
              '<button onclick="document.getElementById(\'updateStatusModal\').remove()" style="padding:10px 20px;background:#e9ecef;border:none;border-radius:6px;cursor:pointer;">Cancel</button>' +
              '<button onclick="saveBatchStatus(\'' + escapeHtml(batchNumber) + '\')" style="padding:10px 20px;background:#8B0000;color:white;border:none;border-radius:6px;cursor:pointer;">Save</button>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    function saveBatchStatus(batchNumber) {
      var newStatus = document.getElementById('newBatchStatus').value;
      var actualYield = document.getElementById('batchActualYield').value;
      var notes = document.getElementById('batchStatusNotes').value;
      
      google.script.run
        .withSuccessHandler(function(result) {
          document.getElementById('updateStatusModal').remove();
          if (result.success) {
            showToast('Status updated!', 'success');
            loadBatches();
          } else {
            showToast('Error: ' + (result.error || 'Unknown'), 'error');
          }
        })
        .withFailureHandler(function(err) {
          showToast('Error: ' + err, 'error');
        })
        .updateBatchStatusByNumber(batchNumber, newStatus, actualYield, notes);
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // RECIPES - COMPLETE CLEAN SECTION
    // DELETE your entire RECIPES section and paste this ENTIRE file
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    var allRecipes = [];
    var currentRecipeName = '';
    var currentBrewLaborEntries = [];
    var currentBrewBatchNumber = null;
    
    function loadRecipes() {
      document.getElementById('recipeGrid').innerHTML = '<div class="loading" style="grid-column:1/-1;">Loading recipes...</div>';
      google.script.run.withSuccessHandler(displayRecipes).withFailureHandler(handleError).getAllRecipesEnhanced();
    }
    
    function displayRecipes(result) {
      if (!result || !result.success) {
        document.getElementById('recipeGrid').innerHTML = '<div class="empty-state" style="grid-column:1/-1;">Error loading recipes</div>';
        return;
      }
      allRecipes = result.recipes || [];
      renderRecipes(allRecipes);
      populateStyleFilter();
      updateRecipeStats();
    }
    
    function renderRecipes(recipes) {
      if (recipes.length === 0) {
        document.getElementById('recipeGrid').innerHTML = '<div class="empty-state" style="grid-column:1/-1;">No recipes found</div>';
        return;
      }
      document.getElementById('recipeGrid').innerHTML = recipes.map(function(r) {
        var color = getStyleColor(r.style || r.beerType);
        return '<div class="card" style="cursor:pointer;" onclick="viewRecipe(\'' + escapeHtml(r.recipeName).replace(/'/g, "\\'") + '\')">' +
          '<div style="height:6px;background:' + color + ';"></div>' +
          '<div class="card-body">' +
            '<h3 style="margin:0 0 5px 0;font-size:16px;">' + escapeHtml(r.recipeName) + '</h3>' +
            '<div style="color:var(--text-light);font-size:13px;margin-bottom:10px;">' + escapeHtml(r.style || r.beerType || 'Beer') + '</div>' +
            '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px;">' +
              '<div><span style="color:var(--text-light);">ABV:</span> ' + (r.abv || '-') + '%</div>' +
              '<div><span style="color:var(--text-light);">IBU:</span> ' + (r.ibu || '-') + '</div>' +
              '<div><span style="color:var(--text-light);">Batch:</span> ' + (r.batchSize || 60) + ' BBL</div>' +
              '<div><span style="color:var(--text-light);">COGS:</span> $' + formatNumber(r.cogsPerBBL || 0) + '</div>' +
            '</div>' +
          '</div>' +
        '</div>';
      }).join('');
    }
    
    function filterRecipes() {
      var search = document.getElementById('recipeSearch').value.toLowerCase();
      var style = document.getElementById('styleFilter').value;
      var filtered = allRecipes.filter(function(r) {
        var matchSearch = !search || (r.recipeName || '').toLowerCase().includes(search);
        var matchStyle = !style || (r.style || r.beerType || '').toLowerCase().includes(style.toLowerCase());
        return matchSearch && matchStyle;
      });
      renderRecipes(filtered);
    }
    
    function populateStyleFilter() {
      var styles = {};
      allRecipes.forEach(function(r) { if (r.style || r.beerType) styles[r.style || r.beerType] = true; });
      var select = document.getElementById('styleFilter');
      select.innerHTML = '<option value="">All Styles</option>' + 
        Object.keys(styles).sort().map(function(s) { return '<option value="' + escapeHtml(s) + '">' + escapeHtml(s) + '</option>'; }).join('');
    }
    
    function updateRecipeStats() {
      var el = document.getElementById('recipesTotalCount');
      if (el) el.textContent = allRecipes.length;
    }
    
    function viewRecipe(name) {
      currentRecipeName = name;
      var recipe = allRecipes.find(function(r) { return r.recipeName === name; });
      
      document.getElementById('recipeModalTitle').textContent = name;
      document.getElementById('recipeModalStyle').textContent = recipe ? (recipe.style || recipe.beerType || 'Beer') : 'Beer';
      document.getElementById('recipeModalBatchSize').textContent = recipe ? (recipe.batchSize || 60) : 60;
      document.getElementById('recipeModalABV').textContent = recipe ? (recipe.abv || '-') : '-';
      document.getElementById('recipeModalIBU').textContent = recipe ? (recipe.ibu || '-') : '-';
      document.getElementById('recipeModalYield').textContent = recipe ? ((recipe.yieldPct || 0.95) * 100).toFixed(0) + '%' : '95%';
      
      google.script.run.withSuccessHandler(populateRecipeModal).withFailureHandler(function(err) {
        console.error('Error loading recipe details:', err);
      }).getRecipeDetails(name);
      
      document.getElementById('recipeModal').style.display = 'flex';
    }
    
    function populateRecipeModal(data) {
      if (!data || !data.success) return;
      
      currentRecipeName = data.recipeName;
      
      if (data.grains && data.grains.length > 0) {
        document.getElementById('recipeModalGrains').innerHTML = data.grains.map(function(g) {
          return '<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #eee;">' +
            '<span>' + escapeHtml(g.name || g.ingredient) + '</span>' +
            '<span style="color:var(--text-light);">' + (g.amount || 0) + ' ' + (g.unit || g.uom || 'lbs') + '</span></div>';
        }).join('');
      } else {
        document.getElementById('recipeModalGrains').innerHTML = '<p class="text-muted">No grain bill data</p>';
      }
      
      if (data.hops && data.hops.length > 0) {
        document.getElementById('recipeModalHops').innerHTML = data.hops.map(function(h) {
          return '<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #eee;">' +
            '<span>' + escapeHtml(h.name || h.ingredient) + (h.timing ? ' <span style="color:var(--text-light);font-size:11px;">(' + h.timing + ')</span>' : '') + '</span>' +
            '<span style="color:var(--text-light);">' + (h.amount || 0) + ' ' + (h.unit || h.uom || 'oz') + '</span></div>';
        }).join('');
      } else {
        document.getElementById('recipeModalHops').innerHTML = '<p class="text-muted">No hop schedule data</p>';
      }
      
      document.getElementById('recipeModalYeast').innerHTML = data.yeast ? '<div>' + escapeHtml(data.yeast) + '</div>' : '<p class="text-muted">No yeast data</p>';
      
      if (data.adjuncts && data.adjuncts.length > 0) {
        document.getElementById('recipeModalAdjuncts').innerHTML = data.adjuncts.map(function(a) {
          return '<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #eee;">' +
            '<span>' + escapeHtml(a.name || a.ingredient) + '</span>' +
            '<span style="color:var(--text-light);">' + (a.amount || 0) + ' ' + (a.unit || a.uom || '') + '</span></div>';
        }).join('');
      } else {
        document.getElementById('recipeModalAdjuncts').innerHTML = '<p class="text-muted">No adjuncts</p>';
      }
      
      document.getElementById('recipeModalIngredientCost').textContent = '$' + formatNumber(data.ingredientCost || 0);
      document.getElementById('recipeModalLaborCost').textContent = '$' + formatNumber(data.laborCost || 0);
      document.getElementById('recipeModalCOGS').textContent = '$' + formatNumber(data.cogsPerBBL || 0);
      
      if (data.notes) {
        document.getElementById('recipeModalNotesSection').style.display = 'block';
        document.getElementById('recipeModalNotes').textContent = data.notes;
      } else {
        document.getElementById('recipeModalNotesSection').style.display = 'none';
      }
    }
    
    function openRecipeInSheet() {
      google.script.run.withSuccessHandler(function(url) {
        if (url) window.open(url, '_blank');
        else showToast('Sheet not found', 'error');
      }).getSheetUrl('Recipes');
    }
    
    function brewThisRecipe() {
      if (!currentRecipeName) {
        showToast('No recipe selected', 'error');
        return;
      }
      
      closeModal('recipeModal');
      showToast('Loading Brewer\'s Sheet...', 'info');
      
      Promise.all([
        new Promise(function(resolve, reject) {
          google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getBrewerSheet(currentRecipeName, null);
        }),
        new Promise(function(resolve, reject) {
          google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getBrewers();
        }),
        new Promise(function(resolve, reject) {
          google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getAvailableVessels();
        })
      ]).then(function(results) {
        var sheetResult = results[0];
        var brewersResult = results[1];
        var vesselsResult = results[2];
        
        if (!sheetResult.success) {
          showToast('Error: ' + (sheetResult.error || 'Could not load brewer sheet'), 'error');
          return;
        }
        showBrewerSheetModal(sheetResult.brewerSheet, brewersResult.success ? brewersResult.brewers : [], vesselsResult.success ? vesselsResult.vessels : []);
      }).catch(function(err) {
        showToast('Error loading brewer sheet: ' + err, 'error');
      });
    }
    
    window.currentBrewerSheet = null;
    window.currentBrewers = [];
    window.currentVessels = [];
    
    function showBrewerSheetModal(sheet, brewers, vessels) {
      var existing = document.getElementById('brewerSheetModal');
      if (existing) existing.remove();
      
      window.currentBrewerSheet = sheet;
      window.currentBrewers = brewers;
      window.currentVessels = vessels;
      currentBrewLaborEntries = [];
      currentBrewBatchNumber = null;
      
      var availableFermenters = (vessels || []).filter(function(v) {
        return v.available && (v.type === 'Fermenter' || v.type === 'Pilot Fermenter');
      });
      var vesselOptions = availableFermenters.map(function(v) {
        return '<option value="' + v.name + '">' + v.name + ' (' + (v.capacity || 60) + ' BBL)</option>';
      }).join('');
      
      var warningBanner = '';
      if (sheet.hasWarnings && sheet.insufficientItems && sheet.insufficientItems.length > 0) {
        var itemList = sheet.insufficientItems.map(function(i) { return i.ingredient; }).join(', ');
        warningBanner = '<div style="background:#fff3cd;border:1px solid #ffc107;border-radius:8px;padding:12px;margin-bottom:16px;">' +
          '<strong>‚ö†Ô∏è Insufficient Inventory:</strong> ' + itemList + '</div>';
      }
      
      var estimatedCost = sheet.totalCOGS || sheet.estimatedCost || ((sheet.ingredientCost || 0) + (sheet.laborCost || 0)) || 0;
      var totalGrain = sheet.totalGrain || 0;
      var targetBatchSize = sheet.targetBatchSize || 60;
      
      function buildTable(items, category) {
        if (!items || items.length === 0) return '<p style="color:#666;">None</p>';
        return '<table style="width:100%;border-collapse:collapse;margin-bottom:16px;">' +
          '<tr style="background:#f8f9fa;"><th style="text-align:left;padding:8px;">Ingredient</th><th style="text-align:right;padding:8px;">Recipe</th><th style="text-align:right;padding:8px;color:#8B0000;">ACTUAL</th><th style="padding:8px;">Unit</th><th style="text-align:right;padding:8px;">On Hand</th></tr>' +
          items.map(function(item, idx) {
            var scaled = (item.scaledAmount || item.amount || 0);
            var onHand = (item.qtyOnHand || 0);
            var ingredient = item.ingredient || item.name || 'Unknown';
            var uom = item.uom || item.unit || 'lb';
            var sufficient = item.sufficient !== false && onHand >= scaled;
            return '<tr style="border-bottom:1px solid #eee;">' +
              '<td style="padding:8px;">' + ingredient + '</td>' +
              '<td style="padding:8px;text-align:right;">' + scaled.toFixed(2) + '</td>' +
              '<td style="padding:8px;"><input type="number" class="actual-input" data-cat="' + category + '" data-idx="' + idx + '" value="' + scaled.toFixed(2) + '" step="0.01" style="width:70px;padding:4px;border:2px solid #8B0000;border-radius:4px;text-align:right;"></td>' +
              '<td style="padding:8px;">' + uom + '</td>' +
              '<td style="padding:8px;text-align:right;color:' + (sufficient ? '#28a745' : '#dc3545') + ';">' + onHand.toFixed(2) + '</td>' +
            '</tr>';
          }).join('') + '</table>';
      }
      
      var brewerOptions = '<option value="">-- Select Brewer --</option>' +
        '<option value="Richard Mar">Richard Mar</option>' +
        '<option value="Alex Velasco">Alex Velasco</option>';
      
      var modalHtml = '<div id="brewerSheetModal" style="display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:2000;justify-content:center;align-items:flex-start;padding:20px;overflow-y:auto;">' +
        '<div style="background:white;border-radius:12px;max-width:900px;width:100%;margin:20px auto;">' +
          '<div style="background:linear-gradient(135deg,#8B0000,#a50000);color:white;padding:20px;border-radius:12px 12px 0 0;">' +
            '<div style="display:flex;justify-content:space-between;align-items:center;">' +
              '<div><h2 style="margin:0;">üç∫ Brewer\'s Sheet</h2><p style="margin:4px 0 0 0;opacity:0.9;">' + (sheet.recipeName || 'Recipe') + '</p></div>' +
              '<button onclick="closeBrewerSheetModal()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:36px;height:36px;border-radius:50%;cursor:pointer;">‚úï</button>' +
            '</div>' +
          '</div>' +
          '<div style="padding:24px;max-height:calc(100vh - 200px);overflow-y:auto;">' +
            warningBanner +
            '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:20px;background:#f8f9fa;padding:16px;border-radius:8px;">' +
              '<div><label style="font-size:12px;color:#666;">Batch Size (BBL)</label><div style="display:flex;gap:8px;"><input type="number" id="brewBatchSize" value="' + targetBatchSize + '" style="width:80px;padding:8px;border:1px solid #ccc;border-radius:4px;"><button onclick="rescaleBrewerSheet()" style="padding:8px;background:#8B0000;color:white;border:none;border-radius:4px;cursor:pointer;">‚Üª</button></div></div>' +
              '<div><label style="font-size:12px;color:#666;">Fermenter</label><select id="brewVessel" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;"><option value="">Select...</option>' + vesselOptions + '</select></div>' +
              '<div><label style="font-size:12px;color:#666;">Est. Total Cost</label><div style="font-size:20px;font-weight:bold;color:#8B0000;">$' + estimatedCost.toFixed(2) + '</div></div>' +
            '</div>' +
            '<div style="background:linear-gradient(135deg,#fef3c7,#fde68a);border:2px solid #d97706;border-radius:8px;padding:16px;margin:16px 0;">' +
              '<h4 style="margin:0 0 12px 0;color:#92400e;font-size:14px;">üç∫ Brew Labor</h4>' +
              '<div id="brewLaborEntries" style="margin-bottom:12px;"></div>' +
              '<div style="background:white;padding:12px;border-radius:6px;border:2px dashed #d97706;">' +
                '<div style="display:flex;gap:12px;align-items:flex-end;">' +
                  '<div style="flex:1;"><label style="display:block;font-size:12px;font-weight:600;color:#374151;margin-bottom:4px;">Brewer</label><select id="brewLaborBrewer" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;">' + brewerOptions + '</select></div>' +
                  '<div style="flex:0 0 100px;"><label style="display:block;font-size:12px;font-weight:600;color:#374151;margin-bottom:4px;">Hours</label><input type="number" id="brewLaborHours" step="0.5" min="0.5" max="16" placeholder="8" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;"></div>' +
                  '<div><label style="display:block;font-size:12px;color:transparent;margin-bottom:4px;">&nbsp;</label><button type="button" onclick="addBrewLaborEntryUI()" style="padding:10px 16px;background:#22c55e;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;white-space:nowrap;">+ Log Hours</button></div>' +
                '</div>' +
              '</div>' +
              '<div style="display:flex;justify-content:space-between;margin-top:12px;padding-top:12px;border-top:2px solid #d97706;">' +
                '<span style="font-weight:600;color:#92400e;">Total Brew Labor:</span>' +
                '<span id="brewLaborTotal" style="font-weight:bold;font-size:16px;color:#92400e;">0 hrs</span>' +
              '</div>' +
              '<div style="font-size:11px;color:#b45309;margin-top:8px;font-style:italic;">üí° Both brewers can log their turns. Standard: 2 turns √ó 8 hrs = 16 hrs total.</div>' +
            '</div>' +
            '<h3 style="margin:0 0 8px 0;border-bottom:2px solid #d4af37;padding-bottom:4px;">üåæ Grains (' + totalGrain.toFixed(0) + ' lbs)</h3>' + buildTable(sheet.grains, 'grains') +
            '<h3 style="margin:0 0 8px 0;border-bottom:2px solid #228B22;padding-bottom:4px;">üåø Hops</h3>' + buildTable(sheet.hops, 'hops') +
            '<h3 style="margin:0 0 8px 0;border-bottom:2px solid #8B4513;padding-bottom:4px;">üçØ Other</h3>' + buildTable(sheet.other, 'other') +
            '<div style="margin-top:16px;"><label style="font-weight:600;">Notes</label><textarea id="brewNotes" rows="2" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;margin-top:4px;">' + (sheet.notes || '') + '</textarea></div>' +
            '<div style="margin-top:20px;display:flex;gap:12px;justify-content:flex-end;">' +
              '<button onclick="printBrewerSheet()" style="padding:10px 20px;background:#6c757d;color:white;border:none;border-radius:6px;cursor:pointer;">üñ®Ô∏è Print</button>' +
              '<button onclick="closeBrewerSheetModal()" style="padding:10px 20px;background:#e9ecef;border:none;border-radius:6px;cursor:pointer;">Cancel</button>' +
              '<button onclick="confirmStartBrew()" style="padding:10px 24px;background:#28a745;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:bold;">üöÄ START BREW</button>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    function addBrewLaborEntryUI() {
      var brewerSelect = document.getElementById('brewLaborBrewer');
      var hoursInput = document.getElementById('brewLaborHours');
      
      if (!brewerSelect || !hoursInput) {
        showToast('Form elements not found', 'error');
        return;
      }
      
      var brewer = brewerSelect.value;
      var hours = parseFloat(hoursInput.value) || 0;
      
      if (!brewer) {
        showToast('Please select a brewer', 'error');
        return;
      }
      
      if (hours <= 0) {
        showToast('Please enter hours worked', 'error');
        return;
      }
      
      var existingEntry = currentBrewLaborEntries.find(function(e) {
        return e.employee === brewer;
      });
      
      if (existingEntry) {
        if (!confirm(brewer + ' already has ' + existingEntry.hours + ' hrs logged. Add ' + hours + ' more hours?')) {
          return;
        }
        existingEntry.hours += hours;
      } else {
        currentBrewLaborEntries.push({ employee: brewer, hours: hours });
      }
      
      updateBrewLaborEntriesUI();
      brewerSelect.value = '';
      hoursInput.value = '';
      showToast('‚úì ' + brewer + ': ' + hours + ' hrs added', 'success');
    }
    
    function updateBrewLaborEntriesUI() {
      var container = document.getElementById('brewLaborEntries');
      var totalDisplay = document.getElementById('brewLaborTotal');
      
      if (!container) return;
      
      var html = '';
      var totalHours = 0;
      
      currentBrewLaborEntries.forEach(function(entry) {
        html += '<div style="display:flex;justify-content:space-between;align-items:center;background:white;padding:8px 12px;border-radius:6px;margin-bottom:6px;border-left:4px solid #22c55e;">' +
          '<span style="font-weight:600;color:#166534;">' + entry.employee + '</span>' +
          '<span style="color:#166534;">' + entry.hours + ' hrs</span>' +
          '<span style="color:#22c55e;font-size:18px;">‚úì</span>' +
        '</div>';
        totalHours += parseFloat(entry.hours) || 0;
      });
      
      container.innerHTML = html;
      if (totalDisplay) totalDisplay.textContent = totalHours + ' hrs';
    }
    
    function confirmStartBrew() {
      var sheet = window.currentBrewerSheet;
      var vessel = document.getElementById('brewVessel').value;
      var notes = document.getElementById('brewNotes').value;
      var batchSize = parseFloat(document.getElementById('brewBatchSize').value);
      
      if (!vessel) { 
        showToast('Please select a fermenter', 'error'); 
        return; 
      }
      
      if (currentBrewLaborEntries.length === 0) {
        showToast('Please log at least one brewer\'s hours', 'error');
        return;
      }
      
      var totalHours = currentBrewLaborEntries.reduce(function(sum, e) { return sum + e.hours; }, 0);
      var brewerNames = currentBrewLaborEntries.map(function(e) { return e.employee; }).join(', ');
      
      function collectActuals(category) {
        var items = sheet[category] || [];
        return items.map(function(item, idx) {
          var input = document.querySelector('.actual-input[data-cat="' + category + '"][data-idx="' + idx + '"]');
          return {
            ingredient: item.ingredient, 
            category: item.category, 
            scaledAmount: item.scaledAmount,
            actualAmount: input ? parseFloat(input.value) || 0 : item.scaledAmount,
            uom: item.uom, 
            qtyOnHand: item.qtyOnHand, 
            avgCost: item.avgCost
          };
        });
      }
      
      var brewerData = {
        recipeName: sheet.recipeName, 
        style: sheet.style, 
        targetBatchSize: batchSize,
        brewer: brewerNames,
        brewers: brewerNames,
        laborEntries: currentBrewLaborEntries,
        totalLaborHours: totalHours,
        vessel: vessel, 
        notes: notes,
        targetOG: sheet.targetOG, 
        targetFG: sheet.targetFG, 
        targetABV: sheet.targetABV,
        yeast: sheet.yeast, 
        mashTemp: sheet.mashTemp, 
        fermentationDays: sheet.fermentationDays || 14,
        grains: collectActuals('grains'), 
        hops: collectActuals('hops'), 
        other: collectActuals('other'),
        estimatedCost: sheet.estimatedCost, 
        totalGrain: sheet.totalGrain
      };
      
      var confirmMsg = 'Start brew of ' + sheet.recipeName + '?\n\n' +
        'Brew Labor:\n' + 
        currentBrewLaborEntries.map(function(e) { return '  ‚Ä¢ ' + e.employee + ': ' + e.hours + ' hrs'; }).join('\n') +
        '\n\nTotal: ' + totalHours + ' hrs\n' +
        'Vessel: ' + vessel + '\n' +
        'Batch: ' + batchSize + ' BBL\n\n' +
        'This will deplete inventory and create batch record.';
      
      if (!confirm(confirmMsg)) return;
      
      showToast('Starting brew...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            var batchNumber = result.batchNumber;
            var logIndex = 0;
            
            function logNextEntry() {
              if (logIndex >= currentBrewLaborEntries.length) {
                closeBrewerSheetModal();
                showToast('üéâ Batch ' + batchNumber + ' started! ' + totalHours + ' hrs brew labor logged', 'success');
                if (typeof loadBatches === 'function') loadBatches();
                if (result.pdfUrl) window.open(result.pdfUrl, '_blank');
                return;
              }
              
              var entry = currentBrewLaborEntries[logIndex];
              google.script.run
                .withSuccessHandler(function(laborResult) {
                  logIndex++;
                  logNextEntry();
                })
                .withFailureHandler(function(err) {
                  console.error('Labor log error:', err);
                  logIndex++;
                  logNextEntry();
                })
                .logBrewLabor(batchNumber, entry.employee, entry.hours);
            }
            
            logNextEntry();
            
          } else {
            showToast('Error: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(err) { 
          showToast('Error: ' + err, 'error'); 
        })
        .confirmBrewStartEnhanced(brewerData);
    }
    
    function printBrewerSheet() {
      var sheet = window.currentBrewerSheet;
      var w = window.open('', '_blank');
      w.document.write('<html><head><title>Brewer Sheet - ' + sheet.recipeName + '</title><style>body{font-family:Arial;max-width:800px;margin:20px auto}h1{color:#8B0000}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ccc;padding:8px}th{background:#8B0000;color:white}.actual{background:#fffde7;border:2px solid #8B0000}</style></head><body>');
      w.document.write('<h1>üç∫ ' + sheet.recipeName + '</h1>');
      w.document.write('<p><strong>Batch Size:</strong> ' + sheet.targetBatchSize + ' BBL | <strong>Date:</strong> __________ | <strong>Brewer:</strong> __________</p>');
      ['grains', 'hops', 'other'].forEach(function(cat) {
        if (sheet[cat] && sheet[cat].length > 0) {
          w.document.write('<h3>' + cat.toUpperCase() + '</h3><table><tr><th>‚úì</th><th>Ingredient</th><th>Recipe</th><th class="actual">ACTUAL</th><th>Unit</th></tr>');
          sheet[cat].forEach(function(i) { w.document.write('<tr><td>‚òê</td><td>' + i.ingredient + '</td><td>' + i.scaledAmount.toFixed(2) + '</td><td class="actual"></td><td>' + i.uom + '</td></tr>'); });
          w.document.write('</table>');
        }
      });
      w.document.write('</body></html>');
      w.document.close();
      w.print();
    }
    
    function openNewRecipeModal() {
      var existing = document.getElementById('newRecipeModal');
      if (existing) existing.remove();
      
      var modalHtml = '<div id="newRecipeModal" style="display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:2000;justify-content:center;align-items:center;padding:20px;">' +
        '<div style="background:white;border-radius:12px;max-width:500px;width:100%;">' +
          '<div style="background:linear-gradient(135deg,#8B0000,#a50000);color:white;padding:20px;border-radius:12px 12px 0 0;">' +
            '<div style="display:flex;justify-content:space-between;align-items:center;">' +
              '<h2 style="margin:0;">üìù New Recipe</h2>' +
              '<button onclick="document.getElementById(\'newRecipeModal\').remove()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:36px;height:36px;border-radius:50%;cursor:pointer;">‚úï</button>' +
            '</div>' +
          '</div>' +
          '<div style="padding:24px;">' +
            '<div style="margin-bottom:16px;"><label style="font-weight:600;">Recipe Name *</label><input type="text" id="newRecipeName" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-top:4px;"></div>' +
            '<div style="margin-bottom:16px;"><label style="font-weight:600;">Style</label><input type="text" id="newRecipeStyle" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-top:4px;" placeholder="IPA, Stout, Lager..."></div>' +
            '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">' +
              '<div><label style="font-weight:600;">Batch Size (BBL)</label><input type="number" id="newRecipeBatchSize" value="60" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-top:4px;"></div>' +
              '<div><label style="font-weight:600;">ABV %</label><input type="number" id="newRecipeABV" step="0.1" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-top:4px;"></div>' +
            '</div>' +
            '<div style="margin-bottom:16px;"><label style="font-weight:600;">Sales Channel</label>' +
            '<select id="newRecipeSalesChannel" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-top:4px;">' +
            '<option value="Both" selected>Both (Taproom + B2B)</option>' +
            '<option value="Taproom">Taproom Only (pilots, exclusives)</option>' +
            '<option value="B2B">B2B Only (wholesale)</option>' +
            '</select></div>' +
            '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">' +
              '<div><label style="font-weight:600;">Target OG</label><input type="text" id="newRecipeOG" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-top:4px;" placeholder="1.055"></div>' +
              '<div><label style="font-weight:600;">IBU</label><input type="number" id="newRecipeIBU" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-top:4px;"></div>' +
            '</div>' +
            '<div style="background:#fff9e6;padding:12px;border-radius:6px;margin-bottom:16px;border-left:4px solid #d4af37;font-size:13px;">Add ingredients in the Recipes sheet after creating.</div>' +
            '<div style="display:flex;gap:12px;justify-content:flex-end;">' +
              '<button onclick="document.getElementById(\'newRecipeModal\').remove()" style="padding:10px 20px;background:#e9ecef;border:none;border-radius:6px;cursor:pointer;">Cancel</button>' +
              '<button onclick="saveNewRecipe()" style="padding:10px 20px;background:#8B0000;color:white;border:none;border-radius:6px;cursor:pointer;">Create</button>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    function saveNewRecipe() {
      var name = document.getElementById('newRecipeName').value.trim();
      if (!name) { showToast('Recipe name required', 'error'); return; }
      
      var recipe = {
        name: name,
        style: document.getElementById('newRecipeStyle').value,
        batchSize: parseFloat(document.getElementById('newRecipeBatchSize').value) || 60,
        abv: document.getElementById('newRecipeABV').value,
        og: document.getElementById('newRecipeOG').value,
        ibu: document.getElementById('newRecipeIBU').value,
        salesChannel: document.getElementById('newRecipeSalesChannel').value
      };
      
      google.script.run
        .withSuccessHandler(function(result) {
          document.getElementById('newRecipeModal').remove();
          if (result.success) { showToast('Recipe created!', 'success'); loadRecipes(); }
          else showToast('Error: ' + result.error, 'error');
        })
        .withFailureHandler(function(err) { showToast('Error: ' + err, 'error'); })
        .addNewRecipe(recipe);
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // RAW MATERIALS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    var allMaterials = [];
    
    function loadRawMaterials() {
      document.getElementById('rmTableBody').innerHTML = '<tr><td colspan="9" class="loading">Loading materials...</td></tr>';
      google.script.run.withSuccessHandler(displayMaterials).withFailureHandler(handleError).getRawMaterialsInventory({});
    }
    
    function displayMaterials(result) {
      if (!result.success) {
        document.getElementById('rmTableBody').innerHTML = '<tr><td colspan="9">' + (result.error || 'Error') + '</td></tr>';
        return;
      }
      allMaterials = result.materials || [];
      var summary = result.summary || {};
      var el = document.getElementById('rmTotalItems');
      if (el) el.textContent = allMaterials.length;
      el = document.getElementById('rmTotalValue');
      if (el) el.textContent = '$' + formatNumber(summary.totalValue || 0);
      el = document.getElementById('rmLowStock');
      if (el) el.textContent = summary.lowStock || 0;
      el = document.getElementById('rmOutOfStock');
      if (el) el.textContent = summary.outOfStock || 0;
      renderMaterials(allMaterials);
    }
    
    function renderMaterials(materials) {
      if (materials.length === 0) {
        document.getElementById('rmTableBody').innerHTML = '<tr><td colspan="9">No materials found</td></tr>';
        return;
      }
      document.getElementById('rmTableBody').innerHTML = materials.map(function(m) {
        var statusClass = (m.status || '').includes('OUT') || (m.status || '').includes('üö®') ? 'text-danger' : 
                          (m.status || '').includes('REORDER') || (m.status || '').includes('‚ö†') ? 'text-warning' : 'text-success';
        return '<tr>' +
          '<td><strong>' + escapeHtml(m.item) + '</strong></td>' +
          '<td>' + escapeHtml(m.category) + '</td>' +
          '<td style="text-align:right;">' + formatNumber(m.qtyOnHand) + '</td>' +
          '<td>' + escapeHtml(m.unit) + '</td>' +
          '<td style="text-align:right;">$' + formatNumber(m.avgCost) + '</td>' +
          '<td style="text-align:right;">$' + formatNumber(m.totalValue) + '</td>' +
          '<td style="text-align:right;">' + formatNumber(m.reorderPoint) + '</td>' +
          '<td><span class="' + statusClass + ' font-bold">' + escapeHtml(m.status) + '</span></td>' +
          '<td class="action-cell">' +
            '<button class="btn-icon" onclick="editMaterial(\'' + escapeHtml(m.item).replace(/'/g, "\\'") + '\')" title="Edit">‚úèÔ∏è</button>' +
            '<button class="btn-icon" onclick="adjustMaterial(\'' + escapeHtml(m.item).replace(/'/g, "\\'") + '\', ' + m.qtyOnHand + ')" title="Adjust">üì¶</button>' +
          '</td></tr>';
      }).join('');
    }
    
    function filterMaterials() {
      var search = document.getElementById('rmSearchInput').value.toLowerCase();
      var category = document.getElementById('rmCategoryFilter').value;
      var filtered = allMaterials.filter(function(m) {
        var matchSearch = !search || (m.item || '').toLowerCase().includes(search);
        var matchCat = !category || m.category === category;
        return matchSearch && matchCat;
      });
      renderMaterials(filtered);
    }
    
    // ADD MATERIAL MODAL
    function openAddMaterialModal() {
      var existing = document.getElementById('addMaterialModal');
      if (existing) existing.remove();
      
      var categories = ['Grain', 'Hops', 'Yeast', 'Adjuncts', 'Finings', 'Packaging', 'Consumables', 'Chemicals', 'Other'];
      var units = ['lb', 'oz', 'g', 'kg', 'gal', 'L', 'each', 'pack', 'case', 'bag', 'box'];
      
      var modalHtml = '<div id="addMaterialModal" style="display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:2000;justify-content:center;align-items:center;padding:20px;">' +
        '<div style="background:white;border-radius:12px;max-width:500px;width:100%;">' +
          '<div style="background:linear-gradient(135deg,#8B0000,#a50000);color:white;padding:20px;border-radius:12px 12px 0 0;">' +
            '<div style="display:flex;justify-content:space-between;align-items:center;">' +
              '<h2 style="margin:0;">üåæ Add Material</h2>' +
              '<button onclick="document.getElementById(\'addMaterialModal\').remove()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:36px;height:36px;border-radius:50%;cursor:pointer;">‚úï</button>' +
            '</div>' +
          '</div>' +
          '<div style="padding:24px;">' +
            '<div style="margin-bottom:16px;"><label style="font-weight:600;">Item Name *</label><input type="text" id="newMaterialName" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-top:4px;"></div>' +
            '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">' +
              '<div><label style="font-weight:600;">Category</label><select id="newMaterialCategory" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-top:4px;">' + categories.map(function(c) { return '<option>' + c + '</option>'; }).join('') + '</select></div>' +
              '<div><label style="font-weight:600;">Unit</label><select id="newMaterialUnit" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-top:4px;">' + units.map(function(u) { return '<option>' + u + '</option>'; }).join('') + '</select></div>' +
            '</div>' +
            '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">' +
              '<div><label style="font-weight:600;">Qty On Hand</label><input type="number" id="newMaterialQty" value="0" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-top:4px;"></div>' +
              '<div><label style="font-weight:600;">Avg Cost/$</label><input type="number" id="newMaterialCost" step="0.01" value="0" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-top:4px;"></div>' +
            '</div>' +
            '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">' +
              '<div><label style="font-weight:600;">Reorder Point</label><input type="number" id="newMaterialReorder" value="0" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-top:4px;"></div>' +
              '<div><label style="font-weight:600;">Supplier</label><input type="text" id="newMaterialSupplier" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-top:4px;"></div>' +
            '</div>' +
            '<div style="display:flex;gap:12px;justify-content:flex-end;">' +
              '<button onclick="document.getElementById(\'addMaterialModal\').remove()" style="padding:10px 20px;background:#e9ecef;border:none;border-radius:6px;cursor:pointer;">Cancel</button>' +
              '<button onclick="saveNewMaterial()" style="padding:10px 20px;background:#8B0000;color:white;border:none;border-radius:6px;cursor:pointer;">Add Material</button>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    function saveNewMaterial() {
      var name = document.getElementById('newMaterialName').value.trim();
      if (!name) { showToast('Item name required', 'error'); return; }
      
      var material = {
        item: name, category: document.getElementById('newMaterialCategory').value,
        unit: document.getElementById('newMaterialUnit').value,
        qtyOnHand: parseFloat(document.getElementById('newMaterialQty').value) || 0,
        avgCost: parseFloat(document.getElementById('newMaterialCost').value) || 0,
        reorderPoint: parseFloat(document.getElementById('newMaterialReorder').value) || 0,
        supplier: document.getElementById('newMaterialSupplier').value
      };
      
      google.script.run
        .withSuccessHandler(function(result) {
          document.getElementById('addMaterialModal').remove();
          if (result.success) { showToast('Material added!', 'success'); loadRawMaterials(); }
          else showToast('Error: ' + result.error, 'error');
        })
        .withFailureHandler(function(err) { showToast('Error: ' + err, 'error'); })
        .addRawMaterial(material);
    }
    
    function editMaterial(item) {
      var mat = allMaterials.find(function(m) { return m.item === item; });
      if (!mat) { showToast('Material not found', 'error'); return; }
      
      showToast('Edit in Raw Materials sheet for full control', 'info');
      google.script.run.withSuccessHandler(function(url) {
        if (url) window.open(url, '_blank');
      }).getSheetUrl('Raw Materials');
    }
    
    function adjustMaterial(item, currentQty) {
      var newQty = prompt('Adjust quantity for ' + item + '\n\nCurrent: ' + currentQty + '\n\nEnter new quantity:');
      if (newQty === null) return;
      
      var qty = parseFloat(newQty);
      if (isNaN(qty) || qty < 0) { showToast('Invalid quantity', 'error'); return; }
      
      var reason = prompt('Reason for adjustment:') || 'Manual adjustment';
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) { showToast('Quantity adjusted!', 'success'); loadRawMaterials(); }
          else showToast('Error: ' + result.error, 'error');
        })
        .withFailureHandler(function(err) { showToast('Error: ' + err, 'error'); })
        .adjustMaterialInventory(item, qty, reason);
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FINISHED GOODS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    var allFG = [];
    
    function loadFinishedGoods() {
      document.getElementById('fgTableBody').innerHTML = '<tr><td colspan="8" class="loading">Loading inventory...</td></tr>';
      google.script.run.withSuccessHandler(displayFG).withFailureHandler(handleError).getFinishedGoodsData({});
    }
    
    function displayFG(result) {
      if (!result.success) {
        document.getElementById('fgTableBody').innerHTML = '<tr><td colspan="8">' + (result.error || 'Error') + '</td></tr>';
        return;
      }
      allFG = result.inventory || [];
      var summary = result.summary || {};
      var el = document.getElementById('fgTotalValue');
      if (el) el.textContent = '$' + formatNumber(summary.totalValue || 0);
      el = document.getElementById('fgKegCount');
      if (el) el.textContent = summary.kegCount || allFG.length;
      el = document.getElementById('fgCaseCount');
      if (el) el.textContent = summary.caseCount || 0;
      el = document.getElementById('fgLowCount');
      if (el) el.textContent = summary.lowCount || 0;
      renderFG(allFG);
    }
    
    function renderFG(items) {
      if (items.length === 0) {
        document.getElementById('fgTableBody').innerHTML = '<tr><td colspan="8">No finished goods found</td></tr>';
        return;
      }
      document.getElementById('fgTableBody').innerHTML = items.map(function(i) {
        var statusClass = (i.status || '').includes('LOW') || (i.status || '').includes('üö®') ? 'text-danger' : 
                          (i.status || '').includes('REORDER') ? 'text-warning' : 'text-success';
        return '<tr>' +
          '<td><strong>' + escapeHtml(i.beer || i.beerName) + '</strong></td>' +
          '<td>' + escapeHtml(i.package || i.packageType) + '</td>' +
          '<td style="text-align:right;">' + formatNumber(i.qtyOnHand) + '</td>' +
          '<td style="text-align:right;">' + formatNumber(i.minQty || 0) + '</td>' +
          '<td style="text-align:right;">$' + formatNumber(i.unitCost || 0) + '</td>' +
          '<td style="text-align:right;">$' + formatNumber(i.totalValue || 0) + '</td>' +
          '<td><span class="' + statusClass + ' font-bold">' + escapeHtml(i.status || 'OK') + '</span></td>' +
          '<td class="action-cell">' +
            '<button class="btn-icon" onclick="editFG(\'' + escapeHtml(i.beer || i.beerName).replace(/'/g, "\\'") + '\')" title="Edit">‚úèÔ∏è</button>' +
            '<button class="btn-icon" onclick="adjustFG(\'' + escapeHtml(i.beer || i.beerName).replace(/'/g, "\\'") + '\', \'' + escapeHtml(i.package || i.packageType).replace(/'/g, "\\'") + '\', ' + (i.qtyOnHand || 0) + ')" title="Adjust">üì¶</button>' +
          '</td></tr>';
      }).join('');
    }
    
    function filterFG() {
      var search = document.getElementById('fgSearchInput').value.toLowerCase();
      var filtered = allFG.filter(function(i) {
        return !search || (i.beer || i.beerName || '').toLowerCase().includes(search) || (i.package || i.packageType || '').toLowerCase().includes(search);
      });
      renderFG(filtered);
    }
    
    function openAddFGModal() {
      showToast('Add finished goods in the FG Inventory sheet', 'info');
      google.script.run.withSuccessHandler(function(url) {
        if (url) window.open(url, '_blank');
      }).getSheetUrl('FG Inventory');
    }
    
    function editFG(beer) {
  var item = allFG.find(function(i) { 
    return (i.beer || i.beerName) === beer; 
  });
  if (!item) { showToast('Item not found', 'error'); return; }
  
  document.getElementById('editFGBeer').value = item.beer || item.beerName || '';
  document.getElementById('editFGPackage').value = item.package || item.packageType || '';
  document.getElementById('editFGQty').value = item.qtyOnHand || 0;
  document.getElementById('editFGMinQty').value = item.minQty || 0;
  document.getElementById('editFGCost').value = item.unitCost || 0;
  document.getElementById('editFGModal').style.display = 'flex';
}

function closeEditFGModal() {
  document.getElementById('editFGModal').style.display = 'none';
}

function saveEditFG() {
  var data = {
    beer: document.getElementById('editFGBeer').value,
    package: document.getElementById('editFGPackage').value,
    qtyOnHand: parseFloat(document.getElementById('editFGQty').value) || 0,
    minQty: parseFloat(document.getElementById('editFGMinQty').value) || 0,
    unitCost: parseFloat(document.getElementById('editFGCost').value) || 0
  };
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('Updated!', 'success');
        closeEditFGModal();
        loadFinishedGoods();
      } else {
        showToast('Error: ' + result.error, 'error');
      }
    })
    .withFailureHandler(function(err) { showToast('Error: ' + err, 'error'); })
    .updateFinishedGoodsItem(data);
}
    
    function adjustFG(beer, pkg, currentQty) {
      var newQty = prompt('Adjust quantity for ' + beer + ' (' + pkg + ')\n\nCurrent: ' + currentQty + '\n\nEnter new quantity:');
      if (newQty === null) return;
      
      var qty = parseFloat(newQty);
      if (isNaN(qty) || qty < 0) { showToast('Invalid quantity', 'error'); return; }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) { showToast('Quantity adjusted!', 'success'); loadFinishedGoods(); }
          else showToast('Error: ' + result.error, 'error');
        })
        .withFailureHandler(function(err) { showToast('Error: ' + err, 'error'); })
        .adjustFGInventory(beer, pkg, qty);
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PURCHASES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    var allPurchases = [];
    
    function loadPurchases() {
      document.getElementById('purchaseTableBody').innerHTML = '<tr><td colspan="8" class="loading">Loading purchases...</td></tr>';
      google.script.run.withSuccessHandler(displayPurchases).withFailureHandler(handleError).getPurchasesData({});
    }
    
    function displayPurchases(result) {
      if (!result.success) {
        document.getElementById('purchaseTableBody').innerHTML = '<tr><td colspan="8">' + (result.error || 'Error') + '</td></tr>';
        return;
      }
      allPurchases = result.purchases || [];
      var el = document.getElementById('purchaseYTD');
      if (el) el.textContent = '$' + formatNumber(result.ytdTotal || 0);
      el = document.getElementById('purchaseMonth');
      if (el) el.textContent = '$' + formatNumber(result.mtdTotal || 0);
      el = document.getElementById('purchasePending');
      if (el) el.textContent = result.pendingCount || 0;
      renderPurchases(allPurchases);
    }
    
    function renderPurchases(purchases) {
      if (purchases.length === 0) {
        document.getElementById('purchaseTableBody').innerHTML = '<tr><td colspan="8">No purchases found</td></tr>';
        return;
      }
      document.getElementById('purchaseTableBody').innerHTML = purchases.map(function(p) {
        var isReceived = (p.status || '').toLowerCase().includes('received');
        return '<tr>' +
          '<td><strong>' + escapeHtml(p.poNumber || p.po) + '</strong></td>' +
          '<td>' + formatDate(p.date || p.orderDate) + '</td>' +
          '<td>' + escapeHtml(p.supplier || p.vendor) + '</td>' +
          '<td>' + escapeHtml(p.item || p.description) + '</td>' +
          '<td style="text-align:right;">' + formatNumber(p.qty || p.quantity) + '</td>' +
          '<td style="text-align:right;">$' + formatNumber(p.total || p.amount) + '</td>' +
          '<td><span class="badge ' + (isReceived ? 'badge-success' : 'badge-warning') + '">' + (p.status || 'Pending') + '</span></td>' +
          '<td class="action-cell">' +
            (isReceived ? '' : '<button class="btn-icon" onclick="receivePO(\'' + escapeHtml(p.poNumber || p.po).replace(/'/g, "\\'") + '\')" title="Receive">üì¶</button>') +
          '</td></tr>';
      }).join('');
    }
    
    function filterPurchases() {
      var search = document.getElementById('purchaseSearch').value.toLowerCase();
      var filtered = allPurchases.filter(function(p) {
        return !search || (p.poNumber || p.po || '').toLowerCase().includes(search) || (p.supplier || p.vendor || '').toLowerCase().includes(search);
      });
      renderPurchases(filtered);
    }
    
    function showNewPurchaseModal() {
      showToast('Add purchases in Purchase Log sheet', 'info');
      google.script.run.withSuccessHandler(function(url) {
        if (url) window.open(url, '_blank');
      }).getSheetUrl('Purchase Log');
    }
    
    function receivePO(poNumber) {
      if (!confirm('Mark PO ' + poNumber + ' as received?\n\nThis will add items to Raw Materials inventory.')) return;
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) { showToast('PO received!', 'success'); loadPurchases(); loadRawMaterials(); }
          else showToast('Error: ' + result.error, 'error');
        })
        .withFailureHandler(function(err) { showToast('Error: ' + err, 'error'); })
        .receivePurchaseOrder(poNumber);
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SALES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    var allSales = [];
    
    function loadSales() {
      document.getElementById('salesTableBody').innerHTML = '<tr><td colspan="8" class="loading">Loading sales...</td></tr>';
      google.script.run.withSuccessHandler(displaySales).withFailureHandler(handleError).getSalesData({});
    }
    
    function displaySales(result) {
      if (!result.success) {
        document.getElementById('salesTableBody').innerHTML = '<tr><td colspan="8">' + (result.error || 'Error') + '</td></tr>';
        return;
      }
      allSales = result.sales || [];
      var el = document.getElementById('salesYTDRev');
      if (el) el.textContent = '$' + formatNumber(result.ytdRevenue || 0);
      el = document.getElementById('salesYTDCogs');
      if (el) el.textContent = '$' + formatNumber(result.ytdCOGS || 0);
      el = document.getElementById('salesYTDProfit');
      if (el) el.textContent = '$' + formatNumber(result.ytdProfit || 0);
      el = document.getElementById('salesYTDMargin');
      if (el) el.textContent = ((result.grossMargin || 0) * 100).toFixed(1) + '%';
      renderSales(allSales);
    }
    
    function renderSales(sales) {
      if (sales.length === 0) {
        document.getElementById('salesTableBody').innerHTML = '<tr><td colspan="8">No sales found</td></tr>';
        return;
      }
      document.getElementById('salesTableBody').innerHTML = sales.map(function(s) {
        return '<tr>' +
          '<td>' + formatDate(s.date || s.saleDate) + '</td>' +
          '<td>' + escapeHtml(s.customer || s.account) + '</td>' +
          '<td>' + escapeHtml(s.beer || s.product) + '</td>' +
          '<td>' + escapeHtml(s.package || s.packageType) + '</td>' +
          '<td style="text-align:right;">' + formatNumber(s.qty || s.quantity) + '</td>' +
          '<td style="text-align:right;">$' + formatNumber(s.revenue || s.total) + '</td>' +
          '<td style="text-align:right;">$' + formatNumber(s.cogs || 0) + '</td>' +
          '<td class="action-cell"><button class="btn-icon" onclick="viewSale(' + s.rowIndex + ')" title="View">üëÅÔ∏è</button></td></tr>';
      }).join('');
    }
    
    function filterSales() {
      var search = document.getElementById('salesSearchInput').value.toLowerCase();
      var filtered = allSales.filter(function(s) {
        return !search || (s.customer || s.account || '').toLowerCase().includes(search) || (s.beer || s.product || '').toLowerCase().includes(search);
      });
      renderSales(filtered);
    }
    
    function openNewSaleModal() {
      showToast('Add sales in Depletion Log sheet', 'info');
      google.script.run.withSuccessHandler(function(url) {
        if (url) window.open(url, '_blank');
      }).getSheetUrl('Depletion Log');
    }
    
    function openToastImport() {
      switchToTab('taproom');
    }
    
    function viewSale(rowIndex) {
      var sale = allSales.find(function(s) { return s.rowIndex === rowIndex; });
      if (sale) {
        showToast(sale.customer + ': ' + sale.qty + ' x ' + sale.beer + ' = $' + formatNumber(sale.revenue), 'info');
      }
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TAPROOM (Toast Import)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    var taproomSales = [];
    
    function loadTaproomData() {
      var year = parseInt(document.getElementById('taproomYear').value);
      var month = parseInt(document.getElementById('taproomMonth').value);
      
      document.getElementById('taproomTableBody').innerHTML = '<tr><td colspan="9" class="loading">Loading...</td></tr>';
      
      google.script.run.withSuccessHandler(displayTaproomData).withFailureHandler(handleError).getTaproomSalesData(year, month);
      loadQBToastStatus();
    }
    
    function displayTaproomData(result) {
      if (!result.success) {
        document.getElementById('taproomTableBody').innerHTML = '<tr><td colspan="9">' + (result.error || 'Error') + '</td></tr>';
        return;
      }
      
      taproomSales = result.sales || [];
      var summary = result.summary || {};
      
      var el = document.getElementById('taproomMTD');
      if (el) el.textContent = '$' + formatNumber(summary.mtdRevenue || 0);
      el = document.getElementById('taproomYTD');
      if (el) el.textContent = '$' + formatNumber(summary.ytdRevenue || 0);
      el = document.getElementById('taproomAvgDaily');
      if (el) el.textContent = '$' + formatNumber(summary.avgDaily || 0);
      el = document.getElementById('taproomMTDTips');
      if (el) el.textContent = '$' + formatNumber(summary.mtdTips || 0);
      el = document.getElementById('taproomMerchantFees');
      if (el) el.textContent = '$' + formatNumber(summary.mtdMerchantFees || 0);
      el = document.getElementById('taproomDaysCount');
      if (el) el.textContent = taproomSales.length + ' days';
      el = document.getElementById('taproomDaysBadge');
      if (el) el.textContent = taproomSales.length + ' days';
      
      renderTaproomTable(taproomSales);
      renderDayOfWeekAnalysis(result.dayOfWeekStats || []);
    }
    
    function renderTaproomTable(sales) {
      if (sales.length === 0) {
        document.getElementById('taproomTableBody').innerHTML = '<tr><td colspan="9" style="text-align:center;padding:20px;">No sales data. Upload Toast CSV above.</td></tr>';
        return;
      }
      document.getElementById('taproomTableBody').innerHTML = sales.map(function(s) {
        var d = new Date(s.date);
        var dayName = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()];
        var total = (s.cash || 0) + (s.card || 0);
        return '<tr>' +
          '<td>' + formatDate(s.date) + '</td>' +
          '<td>' + dayName + '</td>' +
          '<td style="text-align:right;">$' + formatNumber(s.cash || 0) + '</td>' +
          '<td style="text-align:right;">$' + formatNumber(s.card || 0) + '</td>' +
          '<td style="text-align:right;font-weight:600;">$' + formatNumber(total) + '</td>' +
          '<td style="text-align:right;">$' + formatNumber(s.tips || 0) + '</td>' +
          '<td style="text-align:right;">$' + formatNumber(s.salesTax || 0) + '</td>' +
          '<td style="text-align:right;color:#dc3545;">$' + formatNumber(s.merchantFees || 0) + '</td>' +
          '<td class="action-cell">' +
            '<button class="btn-icon" onclick="editTaproomDay(\'' + s.date + '\')" title="Edit">‚úèÔ∏è</button>' +
            '<button class="btn-icon btn-danger" onclick="deleteTaproomDay(\'' + s.date + '\')" title="Delete">üóëÔ∏è</button>' +
          '</td></tr>';
      }).join('');
    }
    
    function renderDayOfWeekAnalysis(stats) {
      if (!stats || stats.length === 0) {
        document.getElementById('dayOfWeekAnalysis').innerHTML = '<p class="text-muted">No data yet</p>';
        return;
      }
      var maxAvg = Math.max.apply(null, stats.map(function(s) { return s.avgSales || 0; }));
      document.getElementById('dayOfWeekAnalysis').innerHTML = stats.map(function(s) {
        var pct = maxAvg > 0 ? (s.avgSales / maxAvg * 100) : 0;
        return '<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">' +
          '<div style="width:40px;font-weight:600;">' + (s.day || '').substring(0,3) + '</div>' +
          '<div style="flex:1;background:#e9ecef;border-radius:4px;height:20px;">' +
            '<div style="width:' + pct + '%;background:#8B0000;height:100%;border-radius:4px;"></div>' +
          '</div>' +
          '<div style="width:70px;text-align:right;">$' + formatNumber(s.avgSales || 0) + '</div>' +
        '</div>';
      }).join('');
    }
    
    function handleToastFile(event) {
      var file = event.target.files[0];
      if (!file) return;
      
      var reader = new FileReader();
      reader.onload = function(e) {
        parseAndUploadToast(e.target.result);
      };
      reader.readAsText(file);
    }
    
    function parseAndUploadToast(csvContent) {
      document.getElementById('uploadZone').innerHTML = '<div class="loading">Processing CSV...</div>';
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            document.getElementById('uploadZone').innerHTML = '<div style="color:#28a745;font-size:24px;margin-bottom:10px;">‚úÖ</div>' +
              '<div style="font-weight:600;">Upload Complete!</div>' +
              '<div style="color:var(--text-light);margin-top:5px;">' + result.rowsAdded + ' days imported</div>' +
              '<button class="btn btn-primary" onclick="resetUploadZone()" style="margin-top:15px;">Upload Another</button>';
            loadTaproomData();
          } else {
            showUploadError(result.error || 'Unknown error');
          }
        })
        .withFailureHandler(function(err) {
          showUploadError(err);
        })
        .importToastCSV(csvContent);
    }
    
    function showUploadError(error) {
      document.getElementById('uploadZone').innerHTML = '<div style="color:#dc3545;font-size:24px;margin-bottom:10px;">‚ùå</div>' +
        '<div style="font-weight:600;color:#dc3545;">Upload Failed</div>' +
        '<div style="color:var(--text-light);margin-top:5px;">' + error + '</div>' +
        '<button class="btn btn-secondary" onclick="resetUploadZone()" style="margin-top:15px;">Try Again</button>';
    }
    
    function resetUploadZone() {
      document.getElementById('uploadZone').innerHTML = '<div style="font-size:36px;margin-bottom:10px;">üì§</div>' +
        '<div style="font-weight:600;">Drop Toast CSV here</div>' +
        '<div style="color:var(--text-light);font-size:13px;margin-top:5px;">or click to browse</div>';
      document.getElementById('toastFileInput').value = '';
    }
    
    function openTaproomSheet() {
      google.script.run.withSuccessHandler(function(url) {
        if (url) window.open(url, '_blank');
      }).getSheetUrl('Taproom Sales');
    }
    
    function addManualToastEntry() {
      document.getElementById('manualEntryForm').style.display = 'block';
    }
    
    function saveManualEntry() {
      var entry = {
        date: document.getElementById('manualDate').value,
        cash: parseFloat(document.getElementById('manualCash').value) || 0,
        card: parseFloat(document.getElementById('manualCard').value) || 0,
        tips: parseFloat(document.getElementById('manualTips').value) || 0,
        salesTax: parseFloat(document.getElementById('manualTax').value) || 0,
        merchantFees: parseFloat(document.getElementById('manualFees').value) || 0
      };
      
      if (!entry.date) { showToast('Date required', 'error'); return; }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            document.getElementById('manualEntryForm').style.display = 'none';
            showToast('Entry added!', 'success');
            loadTaproomData();
          } else showToast('Error: ' + result.error, 'error');
        })
        .withFailureHandler(function(err) { showToast('Error: ' + err, 'error'); })
        .addTaproomSalesEntry(entry);
    }
    
    function editTaproomDay(dateStr) {
      var sale = taproomSales.find(function(s) { return s.date === dateStr; });
      if (!sale) { showToast('Day not found', 'error'); return; }
      
      document.getElementById('manualDate').value = dateStr.split('T')[0];
      document.getElementById('manualCash').value = sale.cash || 0;
      document.getElementById('manualCard').value = sale.card || 0;
      document.getElementById('manualTips').value = sale.tips || 0;
      document.getElementById('manualTax').value = sale.salesTax || 0;
      document.getElementById('manualFees').value = sale.merchantFees || 0;
      document.getElementById('manualEntryForm').style.display = 'block';
    }
    
    function deleteTaproomDay(dateStr) {
      if (!confirm('Delete entry for ' + dateStr + '?')) return;
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) { showToast('Deleted', 'success'); loadTaproomData(); }
          else showToast('Error: ' + result.error, 'error');
        })
        .withFailureHandler(function(err) { showToast('Error: ' + err, 'error'); })
        .deleteTaproomSalesEntry(dateStr);
    }
    
    function loadQBToastStatus() {
      // This will be updated by QB Journal tab
    }
    
    function switchToQBJournal() {
      switchToTab('qb-journal');
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // BEER COGS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function loadBeerCOGS() {
  document.getElementById('cogsTableBody').innerHTML = '<tr><td colspan="10" class="loading">Loading COGS...</td></tr>';
  google.script.run.withSuccessHandler(displayBeerCOGS).withFailureHandler(handleError).getBeerCOGSData();
}
    
    function displayBeerCOGS(result) {
  if (!result || !result.success) {
    document.getElementById('cogsTableBody').innerHTML = '<tr><td colspan="10">' + (result ? result.error : 'No data returned') + '</td></tr>';
    return;
  }
  
  var beers = result.beers || [];
  var summary = result.summary || {};
  
  // Update summary cards
  var el = document.getElementById('cogsLowest');
  if (el) el.textContent = '$' + formatNumber(summary.lowestCOGS || 0);
  el = document.getElementById('cogsLowestBeer');
  if (el) el.textContent = summary.lowestBeer || '--';
  el = document.getElementById('cogsHighest');
  if (el) el.textContent = '$' + formatNumber(summary.highestCOGS || 0);
  el = document.getElementById('cogsHighestBeer');
  if (el) el.textContent = summary.highestBeer || '--';
  el = document.getElementById('cogsAverage');
  if (el) el.textContent = '$' + formatNumber(summary.averageCOGS || 0);
  el = document.getElementById('cogsLaborBatch');
  if (el) el.textContent = '$' + formatNumber(summary.laborPerBatch || 0);
  el = document.getElementById('cogsLaborRate');
  if (el) el.textContent = formatNumber(summary.laborPerBatch || 0);
  el = document.getElementById('cogsCount');
  if (el) el.textContent = beers.length + ' beers';
  
  if (beers.length === 0) {
    document.getElementById('cogsTableBody').innerHTML = '<tr><td colspan="10">No COGS data. Check Beer COGS Master sheet.</td></tr>';
    return;
  }
  
  document.getElementById('cogsTableBody').innerHTML = beers.map(function(b) {
    var marginClass = (b.margin || 0) >= 50 ? 'text-success' : (b.margin || 0) >= 30 ? '' : 'text-danger';
    return '<tr>' +
      '<td><strong>' + escapeHtml(b.beer || b.recipeName || '') + '</strong></td>' +
      '<td style="text-align:right;">' + (b.batchSize || 60) + ' BBL</td>' +
      '<td style="text-align:right;">' + (b.yieldPctDisplay || ((b.yieldPct || 0.95) * 100).toFixed(0) + '%') + '</td>' +
      '<td style="text-align:right;">' + formatNumber(b.expectedYield || 0) + ' BBL</td>' +
      '<td style="text-align:right;">$' + formatNumber(b.ingredientCost || 0) + '</td>' +
      '<td style="text-align:right;">$' + formatNumber(b.laborCost || 0) + '</td>' +
      '<td style="text-align:right;">$' + formatNumber(b.totalCost || 0) + '</td>' +
      '<td style="text-align:right;font-weight:600;color:#8B0000;">$' + formatNumber(b.cogsPerBBL || 0) + '</td>' +
      '<td style="text-align:right;">$' + formatNumber(b.floorPrice || 0) + '</td>' +
      '<td style="text-align:right;" class="' + marginClass + '">' + formatNumber(b.margin || 0) + '%</td>' +
    '</tr>';
  }).join('');
}
    
    function recalculateCOGS() {
      if (!confirm('Recalculate COGS for all beers?')) return;
      showToast('Recalculating...', 'info');
      google.script.run.withSuccessHandler(function(result) {
        if (result.success) { showToast('COGS updated!', 'success'); loadBeerCOGS(); }
        else showToast('Error: ' + result.error, 'error');
      }).recalculateAllCOGS();
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // QB JOURNAL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function loadQBJournal() {
      var year = parseInt(document.getElementById('qbYear').value);
      var month = parseInt(document.getElementById('qbMonth').value);
      loadRecurringConfigPreview();
    }
    
    function loadRecurringConfigPreview() {
      var month = parseInt(document.getElementById('qbMonth').value);
      google.script.run.withSuccessHandler(function(result) {
        if (result.success && result.entries) {
          var recurring = result.entries.filter(function(e) { return e.source === 'Recurring'; });
          var tbody = document.getElementById('recurringConfigPreview');
          if (tbody) {
            tbody.innerHTML = recurring.slice(0, 5).map(function(e) {
              return '<tr><td>' + escapeHtml(e.description || e.memo) + '</td><td style="text-align:right;">$' + formatNumber(Math.abs(e.debit || e.credit || 0)) + '</td></tr>';
            }).join('') + (recurring.length > 5 ? '<tr><td colspan="2" style="color:var(--text-light);font-size:12px;">+' + (recurring.length - 5) + ' more...</td></tr>' : '');
          }
        }
      }).getRecurringEntriesConfig(month);
    }
    
    function generateQBEntries() {
      var year = parseInt(document.getElementById('qbYear').value);
      var month = parseInt(document.getElementById('qbMonth').value);
      
      document.getElementById('generateQBBtn').disabled = true;
      document.getElementById('generateQBBtn').textContent = 'Generating...';
      
      google.script.run.withSuccessHandler(function(result) {
        document.getElementById('generateQBBtn').disabled = false;
        document.getElementById('generateQBBtn').textContent = 'üìí Generate Journal Entries';
        
        if (result.success) {
          showToast('Generated ' + (result.totalEntries || 0) + ' entries!', 'success');
          var el = document.getElementById('qbEntryCount');
          if (el) el.textContent = result.totalEntries || 0;
          el = document.getElementById('qbLineCount');
          if (el) el.textContent = result.totalLines || 0;
          el = document.getElementById('qbGenerateResult');
          if (el) el.style.display = 'block';
        } else showToast('Error: ' + result.error, 'error');
      }).withFailureHandler(function(err) {
        document.getElementById('generateQBBtn').disabled = false;
        document.getElementById('generateQBBtn').textContent = 'üìí Generate Journal Entries';
        showToast('Error: ' + err, 'error');
      }).generateMonthlyJournalEntriesV2(year, month);
    }
    
    function exportQBToCSV() {
      google.script.run.withSuccessHandler(function(result) {
        if (result.success && result.downloadUrl) {
          window.open(result.downloadUrl, '_blank');
          showToast('CSV exported!', 'success');
        } else showToast('Error: ' + (result.error || 'No download URL'), 'error');
      }).exportJournalToCSV();
    }
    
    function viewQBExportSheet() {
      google.script.run.withSuccessHandler(function(url) {
        if (url) window.open(url, '_blank');
        else showToast('Sheet not found', 'error');
      }).getSheetUrl('QB Journal Export');
    }
    
    function openRecurringConfig() {
      google.script.run.withSuccessHandler(function(url) {
        if (url) window.open(url, '_blank');
        else showToast('Sheet not found', 'error');
      }).getSheetUrl('Recurring Journal Config');
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TTB / TAX
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function generateTTBReport() {
      var year = parseInt(document.getElementById('ttbYear').value);
      var month = parseInt(document.getElementById('ttbMonth').value);
      
      showToast('Generating TTB report...', 'info');
      
      google.script.run.withSuccessHandler(function(result) {
        if (!result.success) {
          showToast('Error: ' + (result.error || 'Unknown'), 'error');
          return;
        }
        
        var ttb = result.ttb || {};
        var state = result.state || {};
        
        // Update individual elements
        var el = document.getElementById('ttbBeginInv');
        if (el) el.textContent = formatNumber(ttb.beginInventory || 0) + ' BBL';
        el = document.getElementById('ttbProduced');
        if (el) el.textContent = formatNumber(ttb.production || 0) + ' BBL';
        el = document.getElementById('ttbTotal');
        if (el) el.textContent = formatNumber((ttb.beginInventory || 0) + (ttb.production || 0)) + ' BBL';
        el = document.getElementById('ttbEndInv');
        if (el) el.textContent = formatNumber(ttb.endInventory || 0) + ' BBL';
        el = document.getElementById('ttbRemovals');
        if (el) el.textContent = formatNumber(ttb.removals || 0) + ' BBL';
        el = document.getElementById('ttbTaxableBBL');
        if (el) el.textContent = formatNumber(ttb.taxableBBL || ttb.removals || 0) + ' BBL';
        el = document.getElementById('ttbFederalTaxDue');
        if (el) el.textContent = '$' + formatNumber(ttb.taxDue || 0);
        el = document.getElementById('ttbColoradoBBL');
        if (el) el.textContent = formatNumber(state.productionBBL || 0) + ' BBL';
        el = document.getElementById('ttbColoradoGallons');
        if (el) el.textContent = formatNumber(state.productionGallons || 0) + ' gal';
        el = document.getElementById('ttbColoradoTaxDue');
        if (el) el.textContent = '$' + formatNumber(state.taxDue || 0);
        el = document.getElementById('ttbTotalTaxDue');
        if (el) el.textContent = '$' + formatNumber((ttb.taxDue || 0) + (state.taxDue || 0));
        el = document.getElementById('ttbFederalSummary');
        if (el) el.textContent = '$' + formatNumber(ttb.taxDue || 0);
        el = document.getElementById('ttbColoradoSummary');
        if (el) el.textContent = '$' + formatNumber(state.taxDue || 0);
        
        showToast('TTB report generated!', 'success');
      }).withFailureHandler(handleError).getTTBDataWithState(year, month);
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // OPEX
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function loadOpEx() {
  document.getElementById('opexTableBody').innerHTML = '<tr><td colspan="8" class="loading">Loading OpEx...</td></tr>';
  google.script.run.withSuccessHandler(function(result) {
    if (!result.success) {
      document.getElementById('opexTableBody').innerHTML = '<tr><td colspan="8">' + (result.error || 'Error') + '</td></tr>';
      return;
    }
    
    // Update summary cards
    if (result.summary) {
      var el = document.getElementById('opexTotalBudget');
      if (el) el.textContent = '$' + formatNumber(result.summary.totalBudget || 0);
      el = document.getElementById('opexYTDActual');
      if (el) el.textContent = '$' + formatNumber(result.summary.ytdActual || 0);
      el = document.getElementById('opexYTDBudget');
      if (el) el.textContent = '$' + formatNumber(result.summary.ytdBudget || 0);
      el = document.getElementById('opexVarianceValue');
      if (el) {
        var variance = result.summary.variance || 0;
        el.textContent = (variance >= 0 ? '+' : '-') + '$' + formatNumber(Math.abs(variance));
        el.style.color = variance >= 0 ? 'var(--success)' : 'var(--danger)';
      }
      el = document.getElementById('opexVarianceStatus');
      if (el) el.textContent = (result.summary.variance || 0) >= 0 ? 'Under budget' : 'Over budget';
    }
    
    renderOpExCategories(result.categories || []);
  }).withFailureHandler(handleError).getOpExStatus();
}

function renderOpExCategories(categories) {
  if (categories.length === 0) {
    document.getElementById('opexTableBody').innerHTML = '<tr><td colspan="8">No OpEx data</td></tr>';
    return;
  }
  document.getElementById('opexTableBody').innerHTML = categories.map(function(c) {
    var pct = c.ytdBudget > 0 ? (c.ytdActual / c.ytdBudget * 100) : 0;
    var variance = (c.ytdBudget || 0) - (c.ytdActual || 0);
    var varClass = variance >= 0 ? 'text-success' : 'text-danger';
    var statusBadge = pct > 100 ? '<span class="badge badge-danger">Over</span>' : 
                      pct > 90 ? '<span class="badge badge-warning">Watch</span>' : 
                      '<span class="badge badge-success">OK</span>';
    return '<tr>' +
      '<td><strong>' + escapeHtml(c.category || '') + '</strong></td>' +
      '<td style="text-align:right;">$' + formatNumber(c.actual2025 || 0) + '</td>' +
      '<td style="text-align:right;">' + ((c.growthPct || 0) * 100).toFixed(0) + '%</td>' +
      '<td style="text-align:right;">$' + formatNumber(c.budget2026 || 0) + '</td>' +
      '<td style="text-align:right;">$' + formatNumber(c.ytdActual || 0) + '</td>' +
      '<td style="text-align:right;">$' + formatNumber(c.ytdBudget || 0) + '</td>' +
      '<td style="text-align:right;" class="' + varClass + '">' + (variance >= 0 ? '+' : '') + '$' + formatNumber(Math.abs(variance)) + '</td>' +
      '<td>' + statusBadge + '</td>' +
    '</tr>';
  }).join('');
}
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FLOOR PRICING
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function loadFloorPricing() {
      document.getElementById('floorPricingTableBody').innerHTML = '<tr><td colspan="7" class="loading">Loading pricing...</td></tr>';
      google.script.run.withSuccessHandler(function(result) {
        if (!result.success) {
          document.getElementById('floorPricingTableBody').innerHTML = '<tr><td colspan="7">' + (result.error || 'Error') + '</td></tr>';
          return;
        }
        var prices = result.prices || [];
        if (prices.length === 0) {
          document.getElementById('floorPricingTableBody').innerHTML = '<tr><td colspan="7">No pricing data. Set up Floor Pricing sheet.</td></tr>';
          return;
        }
        document.getElementById('floorPricingTableBody').innerHTML = prices.map(function(p) {
          var pintPrice = (p.floorPerBBL || 0) / 248;
          return '<tr>' +
            '<td><strong>' + escapeHtml(p.beer || p.name || p.beerName) + '</strong></td>' +
            '<td style="text-align:right;">$' + formatNumber(p.cogsPerBBL || p.cogs || 0) + '</td>' +
            '<td style="text-align:right;">$' + formatNumber(p.halfBBLKeg || p.halfBBL || 0) + '</td>' +
            '<td style="text-align:right;">$' + formatNumber(p.sixthBBLKeg || p.sixthBBL || 0) + '</td>' +
            '<td style="text-align:right;">$' + formatNumber(pintPrice) + '</td>' +
            '<td style="text-align:right;">$' + formatNumber(p.case12oz || 0) + '</td>' +
            '<td style="text-align:right;">$' + formatNumber(p.case16oz || 0) + '</td>' +
          '</tr>';
        }).join('');
      }).withFailureHandler(handleError).getFloorPrices();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CLOSE BREWER SHEET MODAL HELPER
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function closeBrewerSheetModal() {
      var modal = document.getElementById('brewerSheetModal');
      if (modal) modal.remove();
    }

    function rescaleBrewerSheet() {
      var newSize = parseFloat(document.getElementById('brewBatchSize').value);
      if (!newSize || newSize <= 0) {
        showToast('Enter a valid batch size', 'error');
        return;
      }
      showToast('Rescaling to ' + newSize + ' BBL...', 'info');
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            closeBrewerSheetModal();
            showBrewerSheetModal(result.brewerSheet, window.currentBrewers, window.currentVessels);
          } else {
            showToast('Error: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(err) { showToast('Error: ' + err, 'error'); })
        .getBrewerSheet(window.currentBrewerSheet.recipeName, newSize);
    }

  </script>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       CELLAR WORKFLOW STYLES
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <style>
    /* Batch Action Buttons */
    .batch-actions { white-space: nowrap; }

    .action-btn-group {
      display: flex;
      gap: 4px;
    }

    .action-btn {
      width: 32px;
      height: 32px;
      border: 1px solid #e5e7eb;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .action-btn:hover {
      background: #f3f4f6;
      border-color: #8B0000;
      transform: translateY(-1px);
    }

    .action-btn-send {
      background: #ecfdf5;
      border-color: #10b981;
    }

    .action-btn-send:hover {
      background: #d1fae5;
      border-color: #059669;
    }

    /* Cellar Modal Overrides */
    .cellar-modal .modal-content {
      max-height: 90vh;
      overflow-y: auto;
    }

    .cellar-modal .modal-header {
      background: #8B0000;
      color: white;
      border-radius: 12px 12px 0 0;
    }

    .cellar-modal .modal-close {
      background: none;
      border: none;
      font-size: 1.5em;
      cursor: pointer;
      color: white;
      opacity: 0.8;
    }

    .cellar-modal .modal-close:hover { opacity: 1; }

    .cellar-modal .modal-footer {
      background: #f9fafb;
      border-radius: 0 0 12px 12px;
    }

    /* Batch Info Banner */
    .batch-info-banner {
      background: #fef3c7;
      border: 1px solid #f59e0b;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
      text-align: center;
    }

    /* Transfer Modal */
    .transfer-arrow { text-align: center; font-size: 1.5em; margin: 8px 0; }

    /* Package Modal */
    .package-grid { display: flex; flex-direction: column; gap: 8px; }
    .package-row { display: flex; align-items: center; gap: 10px; }
    .package-row label { flex: 2; margin: 0; font-weight: normal; }
    .package-row .pkg-input { flex: 1; width: auto; text-align: center; }
    .package-row .pkg-bbl { flex: 1; color: #6b7280; text-align: right; font-size: 12px; }

    .yield-summary {
      background: #f3f4f6;
      border-radius: 8px;
      padding: 12px 16px;
      margin-top: 16px;
    }
    .yield-row { display: flex; justify-content: space-between; padding: 4px 0; }

    /* Send It Modal */
    .send-it-header { background: linear-gradient(135deg, #059669, #10b981) !important; }
    .send-it-banner {
      background: linear-gradient(135deg, #059669, #10b981);
      color: white;
      border: none;
    }

    .send-it-summary { margin: 16px 0; }
    .summary-section { margin-bottom: 16px; }
    .summary-section h4 {
      margin: 0 0 8px 0;
      color: #374151;
      font-size: 0.95em;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 6px;
    }
    .summary-row { display: flex; justify-content: space-between; padding: 4px 0; }
    .pkg-line { padding: 2px 0; }

    .send-it-actions {
      background: #f0fdf4;
      border: 1px solid #86efac;
      border-radius: 8px;
      padding: 12px 16px;
    }
    .send-it-actions ul { margin: 8px 0 0 0; padding-left: 20px; }
    .send-it-actions li { padding: 2px 0; }

    .completion-stats { display: flex; justify-content: center; gap: 30px; margin: 20px 0; }
    .stat-item { text-align: center; }
    .stat-value { display: block; font-size: 1.8em; font-weight: bold; color: #059669; }
    .stat-label { font-size: 0.85em; color: #6b7280; }

    .warning-banner {
      background: #fef2f2;
      border: 1px solid #ef4444;
      color: #dc2626;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      text-align: center;
      font-weight: 500;
    }

    .cost-preview {
      background: #f0f9ff;
      border: 1px solid #0ea5e9;
      border-radius: 6px;
      padding: 8px 12px;
      margin-top: 8px;
    }

    /* Cellar Toast Notifications */
    .cellar-toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 12px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 2000;
      transition: transform 0.3s ease;
    }
    .cellar-toast-show { transform: translateX(-50%) translateY(0); }
    .cellar-toast-success { background: #059669; }
    .cellar-toast-error { background: #dc2626; }
    .cellar-toast-info { background: #3b82f6; }
  </style>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       CELLAR WORKFLOW JAVASCRIPT
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // BBL CONVERSIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    var PKG_BBL = {
      'halfBBL': 0.5,
      'sixthBBL': 0.167,
      'quarterBBL': 0.25,
      '12ozCase': 0.0581,
      '16ozCase': 0.0774,
      'crowler': 0.00258,
      'growler': 0.00516
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // UPDATED RENDER BATCHES - WITH CELLAR ACTION BUTTONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    // Override the existing renderBatches function
    var originalRenderBatches = typeof renderBatches === 'function' ? renderBatches : null;
    
    renderBatches = function(batches) {
      if (batches.length === 0) {
        document.getElementById('batchTableBody').innerHTML = '<tr><td colspan="11" class="empty-state">No batches found</td></tr>';
        return;
      }
      document.getElementById('batchTableBody').innerHTML = batches.map(function(b) {
        var isActive = b.status && ['Brewing', 'Fermenting', 'Conditioning', 'Carbonating', 'Ready to Package'].indexOf(b.status) !== -1;
        return '<tr>' +
          '<td><strong>' + escapeHtml(b.batchNumber) + '</strong></td>' +
          '<td>' + formatDate(b.brewDate || b.date) + '</td>' +
          '<td>' + escapeHtml(b.beerType || b.beer) + '</td>' +
          '<td>' + escapeHtml(b.brewer || '-') + '</td>' +
          '<td>' + escapeHtml(b.vessel || b.tank || '-') + '</td>' +
          '<td style="text-align:right;">' + (b.batchSize || b.size || 0) + ' BBL</td>' +
          '<td style="text-align:right;">$' + formatNumber(b.rawMaterialsCost || 0) + '</td>' +
          '<td style="text-align:right;">$' + formatNumber(b.totalCost || 0) + '</td>' +
          '<td><span class="badge ' + getStatusBadge(b.status) + '">' + (b.status || 'Unknown') + '</span></td>' +
          '<td style="text-align:right;">' + (b.actualYield || b.expectedYield || '--') + '</td>' +
          '<td class="batch-actions">' + (isActive ? renderBatchActions(b) : '<button class="btn-icon" onclick="viewBatch(\'' + escapeHtml(b.batchNumber) + '\')" title="View">üëÅÔ∏è</button>') + '</td>' +
        '</tr>';
      }).join('');
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // RENDER BATCH ACTION BUTTONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function renderBatchActions(batch) {
      var batchNum = (batch.batchNumber || '').replace(/'/g, "\\'");
      var beerName = (batch.beerType || batch.beer || '').replace(/'/g, "\\'");
      var vessel = (batch.vessel || batch.tank || '').replace(/'/g, "\\'");
      var expectedYield = batch.expectedYield || batch.batchSize || 60;
      var actualYield = batch.actualYield || 0;
      
      return '<div class="action-btn-group">' +
        '<button class="action-btn" onclick="showGravityModal(\'' + batchNum + '\', \'' + beerName + '\')" title="Log Gravity">üìä</button>' +
        '<button class="action-btn" onclick="showAdditionModal(\'' + batchNum + '\', \'' + beerName + '\')" title="Add Ingredient">üåø</button>' +
        '<button class="action-btn" onclick="showTransferModal(\'' + batchNum + '\', \'' + beerName + '\', \'' + vessel + '\')" title="Transfer">üîÑ</button>' +
        '<button class="action-btn" onclick="showPackageModal(\'' + batchNum + '\', \'' + beerName + '\', ' + expectedYield + ')" title="Package">üì¶</button>' +
        '<button class="action-btn action-btn-send" onclick="showSendItModal(\'' + batchNum + '\', ' + actualYield + ', ' + expectedYield + ', null, \'' + vessel + '\')" title="Send It!">üöÄ</button>' +
      '</div>';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MODAL 1: GRAVITY READING
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function showGravityModal(batchNumber, beerName) {
      var modal = document.createElement('div');
      modal.id = 'gravityModal';
      modal.className = 'modal cellar-modal';
      modal.style.display = 'flex';
      modal.innerHTML = 
        '<div class="modal-content" style="max-width: 450px;">' +
          '<div class="modal-header">' +
            '<h2>üìä Gravity Reading</h2>' +
            '<button class="close-btn" onclick="closeCellarModal(\'gravityModal\')">&times;</button>' +
          '</div>' +
          '<div class="modal-body">' +
            '<div class="batch-info-banner">' +
              '<strong>' + batchNumber + '</strong> - ' + (beerName || 'Unknown Beer') +
            '</div>' +
            '<div class="form-group">' +
              '<label>Gravity (SG)</label>' +
              '<input type="number" id="gravityValue" step="0.001" min="0.990" max="1.150" placeholder="1.048" class="form-input" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;">' +
              '<small class="form-hint" style="color:#666;font-size:12px;">Specific gravity reading</small>' +
            '</div>' +
            '<div class="form-group">' +
              '<label>Temperature (¬∞F)</label>' +
              '<input type="number" id="gravityTemp" step="0.1" min="32" max="100" placeholder="68" class="form-input" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;">' +
            '</div>' +
            '<div class="form-group">' +
              '<label>Notes</label>' +
              '<textarea id="gravityNotes" rows="2" class="form-input" placeholder="Optional notes..." style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;"></textarea>' +
            '</div>' +
          '</div>' +
          '<div class="modal-actions">' +
            '<button class="btn btn-secondary" onclick="closeCellarModal(\'gravityModal\')">Cancel</button>' +
            '<button class="btn btn-primary" onclick="submitGravityReading(\'' + batchNumber + '\')">üíæ Save Reading</button>' +
          '</div>' +
        '</div>';
      document.body.appendChild(modal);
      document.getElementById('gravityValue').focus();
    }

    function submitGravityReading(batchNumber) {
      var gravity = parseFloat(document.getElementById('gravityValue').value);
      var temperature = document.getElementById('gravityTemp').value;
      var notes = document.getElementById('gravityNotes').value;
      
      if (!gravity || gravity < 0.990 || gravity > 1.150) {
        cellarToast('Enter a valid gravity (0.990-1.150)', 'error');
        return;
      }
      
      cellarToast('Saving gravity reading...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            cellarToast('Gravity reading saved: ' + gravity, 'success');
            closeCellarModal('gravityModal');
            loadBatches();
          } else {
            cellarToast('Error: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(err) { cellarToast('Error: ' + err.message, 'error'); })
        .addGravityReading(batchNumber, gravity, temperature, notes);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MODAL 2: DRY HOP / SECONDARY ADDITION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function showAdditionModal(batchNumber, beerName) {
      google.script.run
        .withSuccessHandler(function(result) {
          renderAdditionModal(batchNumber, beerName, result.materials || []);
        })
        .withFailureHandler(function() { renderAdditionModal(batchNumber, beerName, []); })
        .getRawMaterialsInventory({});
    }

    function renderAdditionModal(batchNumber, beerName, materials) {
      var hopOptions = materials
        .filter(function(m) { return m.category === 'Hops'; })
        .map(function(m) { return '<option value="' + m.item + '" data-cost="' + m.avgCost + '" data-unit="' + m.unit + '">' + m.item + ' (' + m.qtyOnHand + ' ' + m.unit + ' avail)</option>'; })
        .join('');
      
      var adjunctOptions = materials
        .filter(function(m) { return ['Adjuncts', 'Finings', 'Yeast', 'Other'].indexOf(m.category) !== -1; })
        .map(function(m) { return '<option value="' + m.item + '" data-cost="' + m.avgCost + '" data-unit="' + m.unit + '">' + m.item + ' (' + m.qtyOnHand + ' ' + m.unit + ' avail)</option>'; })
        .join('');
      
      var modal = document.createElement('div');
      modal.id = 'additionModal';
      modal.className = 'modal cellar-modal';
      modal.style.display = 'flex';
      modal.innerHTML = 
        '<div class="modal-content" style="max-width: 500px;">' +
          '<div class="modal-header">' +
            '<h2>üåø Secondary Addition</h2>' +
            '<button class="close-btn" onclick="closeCellarModal(\'additionModal\')">&times;</button>' +
          '</div>' +
          '<div class="modal-body">' +
            '<div class="batch-info-banner">' +
              '<strong>' + batchNumber + '</strong> - ' + (beerName || 'Unknown Beer') +
            '</div>' +
            '<div class="form-group">' +
              '<label>Addition Type</label>' +
              '<select id="additionType" class="form-input" onchange="filterAdditionIngredients()" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;">' +
                '<option value="hops">üåø Dry Hops</option>' +
                '<option value="adjunct">üçØ Adjunct/Other</option>' +
              '</select>' +
            '</div>' +
            '<div class="form-group">' +
              '<label>Ingredient</label>' +
              '<select id="additionIngredient" class="form-input" onchange="updateAdditionUnit()" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;">' +
                '<option value="">-- Select Ingredient --</option>' +
                '<optgroup label="Hops" id="hopOptionsGroup">' + (hopOptions || '<option disabled>No hops in inventory</option>') + '</optgroup>' +
                '<optgroup label="Adjuncts/Other" id="adjunctOptionsGroup" style="display:none;">' + (adjunctOptions || '<option disabled>No adjuncts</option>') + '</optgroup>' +
              '</select>' +
            '</div>' +
            '<div class="form-row" style="display:flex;gap:12px;">' +
              '<div class="form-group" style="flex:2;">' +
                '<label>Amount</label>' +
                '<input type="number" id="additionAmount" step="0.01" min="0" placeholder="0.00" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;">' +
              '</div>' +
              '<div class="form-group" style="flex:1;">' +
                '<label>Unit</label>' +
                '<select id="additionUOM" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;">' +
                  '<option value="lb">lb</option>' +
                  '<option value="oz">oz</option>' +
                  '<option value="g">g</option>' +
                  '<option value="each">each</option>' +
                  '<option value="gal">gal</option>' +
                '</select>' +
              '</div>' +
            '</div>' +
            '<div class="form-group">' +
              '<label>Notes</label>' +
              '<textarea id="additionNotes" rows="2" placeholder="Day 3 dry hop, contact time, etc." style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;"></textarea>' +
            '</div>' +
          '</div>' +
          '<div class="modal-actions">' +
            '<button class="btn btn-secondary" onclick="closeCellarModal(\'additionModal\')">Cancel</button>' +
            '<button class="btn btn-primary" onclick="submitAddition(\'' + batchNumber + '\')">‚ûï Add to Batch</button>' +
          '</div>' +
        '</div>';
      document.body.appendChild(modal);
    }

    function filterAdditionIngredients() {
      var type = document.getElementById('additionType').value;
      document.getElementById('hopOptionsGroup').style.display = type === 'hops' ? '' : 'none';
      document.getElementById('adjunctOptionsGroup').style.display = type === 'adjunct' ? '' : 'none';
      document.getElementById('additionIngredient').selectedIndex = 0;
    }

    function updateAdditionUnit() {
      var select = document.getElementById('additionIngredient');
      var option = select.options[select.selectedIndex];
      if (option && option.dataset.unit) {
        document.getElementById('additionUOM').value = option.dataset.unit;
      }
    }

    function submitAddition(batchNumber) {
      var ingredient = document.getElementById('additionIngredient').value;
      var amount = parseFloat(document.getElementById('additionAmount').value);
      var uom = document.getElementById('additionUOM').value;
      var notes = document.getElementById('additionNotes').value;
      
      if (!ingredient) { cellarToast('Select an ingredient', 'error'); return; }
      if (!amount || amount <= 0) { cellarToast('Enter a valid amount', 'error'); return; }
      
      cellarToast('Adding ' + amount + ' ' + uom + ' ' + ingredient + '...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            var costMsg = result.cost ? ' (Cost: $' + result.cost.toFixed(2) + ')' : '';
            cellarToast(ingredient + ' added to batch' + costMsg, 'success');
            closeCellarModal('additionModal');
            loadBatches();
          } else {
            cellarToast('Error: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(err) { cellarToast('Error: ' + err.message, 'error'); })
        .addSecondaryAddition(batchNumber, ingredient, amount, uom, notes);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MODAL 3: TRANSFER
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function showTransferModal(batchNumber, beerName, currentVessel) {
      google.script.run
        .withSuccessHandler(function(result) {
          renderTransferModal(batchNumber, beerName, currentVessel, result.vessels || []);
        })
        .withFailureHandler(function() { renderTransferModal(batchNumber, beerName, currentVessel, []); })
        .getAvailableVessels();
    }

    function renderTransferModal(batchNumber, beerName, currentVessel, vessels) {
      var vesselOptions = vessels.map(function(v) {
        var isCurrent = v.name === currentVessel;
        var status = isCurrent ? ' (current)' : v.available ? '' : ' (in use)';
        var disabled = (!v.available && !isCurrent) ? 'disabled' : '';
        return '<option value="' + v.name + '" ' + disabled + '>' + v.name + ' - ' + v.type + ' (' + v.capacity + ' BBL)' + status + '</option>';
      }).join('');
      
      var modal = document.createElement('div');
      modal.id = 'transferModal';
      modal.className = 'modal cellar-modal';
      modal.style.display = 'flex';
      modal.innerHTML = 
        '<div class="modal-content" style="max-width: 450px;">' +
          '<div class="modal-header">' +
            '<h2>üîÑ Transfer Beer</h2>' +
            '<button class="close-btn" onclick="closeCellarModal(\'transferModal\')">&times;</button>' +
          '</div>' +
          '<div class="modal-body">' +
            '<div class="batch-info-banner">' +
              '<strong>' + batchNumber + '</strong> - ' + (beerName || 'Unknown Beer') +
            '</div>' +
            '<div class="form-group">' +
              '<label>From Vessel</label>' +
              '<input type="text" id="transferFrom" value="' + (currentVessel || 'Not assigned') + '" readonly style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;background:#f3f4f6;">' +
            '</div>' +
            '<div class="transfer-arrow">‚¨áÔ∏è</div>' +
            '<div class="form-group">' +
              '<label>To Vessel</label>' +
              '<select id="transferTo" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;">' +
                '<option value="">-- Select Destination --</option>' +
                vesselOptions +
              '</select>' +
            '</div>' +
            '<div class="form-group">' +
              '<label>Notes</label>' +
              '<textarea id="transferNotes" rows="2" placeholder="Transfer notes, DO reading, etc." style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;"></textarea>' +
            '</div>' +
          '</div>' +
          '<div class="modal-actions">' +
            '<button class="btn btn-secondary" onclick="closeCellarModal(\'transferModal\')">Cancel</button>' +
            '<button class="btn btn-primary" onclick="submitTransfer(\'' + batchNumber + '\', \'' + (currentVessel || '') + '\')">üîÑ Transfer</button>' +
          '</div>' +
        '</div>';
      document.body.appendChild(modal);
    }

    function submitTransfer(batchNumber, fromVessel) {
      var toVessel = document.getElementById('transferTo').value;
      var notes = document.getElementById('transferNotes').value;
      
      if (!toVessel) { cellarToast('Select a destination vessel', 'error'); return; }
      if (toVessel === fromVessel) { cellarToast('Already in that vessel', 'error'); return; }
      
      cellarToast('Transferring to ' + toVessel + '...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            cellarToast('Transferred to ' + toVessel, 'success');
            closeCellarModal('transferModal');
            loadBatches();
            loadVesselStatus();
          } else {
            cellarToast('Error: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(err) { cellarToast('Error: ' + err.message, 'error'); })
        .recordTransfer(batchNumber, fromVessel, toVessel, notes);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MODAL 4: PACKAGING
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function showPackageModal(batchNumber, beerName, expectedYield) {
      google.script.run
        .withSuccessHandler(function(result) {
          renderPackageModal(batchNumber, beerName, expectedYield, result.brewers || []);
        })
        .withFailureHandler(function() { renderPackageModal(batchNumber, beerName, expectedYield, []); })
        .getBrewers();
    }

    function renderPackageModal(batchNumber, beerName, expectedYield, brewers) {
      var brewerOptions = brewers.map(function(b) { 
        var name = typeof b === 'string' ? b : b.name;
        return '<option value="' + name + '">' + name + '</option>'; 
      }).join('');
      
      window.pkgExpectedYield = expectedYield || 0;
      
      var modal = document.createElement('div');
      modal.id = 'packageModal';
      modal.className = 'modal cellar-modal';
      modal.style.display = 'flex';
      modal.innerHTML = 
        '<div class="modal-content" style="max-width: 550px;">' +
          '<div class="modal-header">' +
            '<h2>üì¶ Package Batch</h2>' +
            '<button class="close-btn" onclick="closeCellarModal(\'packageModal\')">&times;</button>' +
          '</div>' +
          '<div class="modal-body">' +
            '<div class="batch-info-banner">' +
              '<strong>' + batchNumber + '</strong> - ' + (beerName || 'Unknown Beer') +
              '<br><small>Expected Yield: ' + (expectedYield || '?') + ' BBL</small>' +
            '</div>' +
            '<div class="form-row" style="display:flex;gap:12px;">' +
              '<div class="form-group" style="flex:1;">' +
                '<label>Final Gravity</label>' +
                '<input type="number" id="pkgFinalGravity" step="0.001" min="0.990" max="1.030" placeholder="1.012" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;">' +
              '</div>' +
              '<div class="form-group" style="flex:1;">' +
                '<label>ABV %</label>' +
                '<input type="number" id="pkgABV" step="0.1" min="0" max="20" placeholder="5.5" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;">' +
              '</div>' +
              '<div class="form-group" style="flex:1;">' +
                '<label>Packager</label>' +
                '<select id="pkgPackager" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;">' +
                  '<option value="">-- Select --</option>' +
                  brewerOptions +
                '</select>' +
              '</div>' +
            '</div>' +
            '<h4 style="margin:16px 0 12px 0;border-bottom:1px solid #e5e7eb;padding-bottom:8px;">üìä Package Counts</h4>' +
            '<div class="package-grid">' +
              '<div class="package-row"><label>üõ¢Ô∏è 1/2 BBL Keg</label><input type="number" id="pkg_halfBBL" min="0" value="0" class="pkg-input" onchange="updatePackageYield()" style="width:80px;padding:8px;border:1px solid #ccc;border-radius:4px;text-align:center;"><small class="pkg-bbl">0.00 BBL</small></div>' +
              '<div class="package-row"><label>üõ¢Ô∏è 1/6 BBL Keg</label><input type="number" id="pkg_sixthBBL" min="0" value="0" class="pkg-input" onchange="updatePackageYield()" style="width:80px;padding:8px;border:1px solid #ccc;border-radius:4px;text-align:center;"><small class="pkg-bbl">0.00 BBL</small></div>' +
              '<div class="package-row"><label>üõ¢Ô∏è 1/4 BBL Keg</label><input type="number" id="pkg_quarterBBL" min="0" value="0" class="pkg-input" onchange="updatePackageYield()" style="width:80px;padding:8px;border:1px solid #ccc;border-radius:4px;text-align:center;"><small class="pkg-bbl">0.00 BBL</small></div>' +
              '<div class="package-row"><label>üì¶ 12oz Case (24pk)</label><input type="number" id="pkg_12ozCase" min="0" value="0" class="pkg-input" onchange="updatePackageYield()" style="width:80px;padding:8px;border:1px solid #ccc;border-radius:4px;text-align:center;"><small class="pkg-bbl">0.00 BBL</small></div>' +
              '<div class="package-row"><label>üì¶ 16oz Case (24pk)</label><input type="number" id="pkg_16ozCase" min="0" value="0" class="pkg-input" onchange="updatePackageYield()" style="width:80px;padding:8px;border:1px solid #ccc;border-radius:4px;text-align:center;"><small class="pkg-bbl">0.00 BBL</small></div>' +
              '<div class="package-row"><label>ü•´ Crowler (32oz)</label><input type="number" id="pkg_crowler" min="0" value="0" class="pkg-input" onchange="updatePackageYield()" style="width:80px;padding:8px;border:1px solid #ccc;border-radius:4px;text-align:center;"><small class="pkg-bbl">0.00 BBL</small></div>' +
              '<div class="package-row"><label>üç∫ Growler (64oz)</label><input type="number" id="pkg_growler" min="0" value="0" class="pkg-input" onchange="updatePackageYield()" style="width:80px;padding:8px;border:1px solid #ccc;border-radius:4px;text-align:center;"><small class="pkg-bbl">0.00 BBL</small></div>' +
            '</div>' +
            '<div class="yield-summary" id="yieldSummary">' +
              '<div class="yield-row"><span>Total Packaged:</span><strong id="totalPackagedBBL">0.00 BBL</strong></div>' +
              '<div class="yield-row"><span>Expected:</span><span id="expectedYieldDisplay">' + (expectedYield || '?') + ' BBL</span></div>' +
              '<div class="yield-row" id="varianceRow"><span>Variance:</span><span id="yieldVariance">--</span></div>' +
            '</div>' +
          '</div>' +
          '<div class="modal-actions">' +
            '<button class="btn btn-secondary" onclick="closeCellarModal(\'packageModal\')">Cancel</button>' +
            '<button class="btn btn-primary" onclick="submitPackaging(\'' + batchNumber + '\', ' + (expectedYield || 0) + ')">üì¶ Record Packaging</button>' +
          '</div>' +
        '</div>';
      document.body.appendChild(modal);
    }

    function updatePackageYield() {
      var total = 0;
      var inputs = document.querySelectorAll('.pkg-input');
      
      inputs.forEach(function(input) {
        var id = input.id.replace('pkg_', '');
        var qty = parseInt(input.value) || 0;
        var bbl = qty * (PKG_BBL[id] || 0);
        total += bbl;
        var small = input.parentElement.querySelector('.pkg-bbl');
        if (small) small.textContent = bbl.toFixed(2) + ' BBL';
      });
      
      document.getElementById('totalPackagedBBL').textContent = total.toFixed(2) + ' BBL';
      
      var expected = window.pkgExpectedYield || 0;
      if (expected > 0) {
        var variance = total - expected;
        var variancePct = (variance / expected * 100);
        var varianceEl = document.getElementById('yieldVariance');
        var varianceRow = document.getElementById('varianceRow');
        
        varianceEl.textContent = (variance >= 0 ? '+' : '') + variance.toFixed(2) + ' BBL (' + (variancePct >= 0 ? '+' : '') + variancePct.toFixed(1) + '%)';
        
        if (Math.abs(variancePct) > 10) varianceRow.style.color = '#dc2626';
        else if (Math.abs(variancePct) > 5) varianceRow.style.color = '#d97706';
        else varianceRow.style.color = '#059669';
      }
    }

    function submitPackaging(batchNumber, expectedYield) {
      var finalGravity = parseFloat(document.getElementById('pkgFinalGravity').value);
      var abv = parseFloat(document.getElementById('pkgABV').value);
      var packager = document.getElementById('pkgPackager').value;
      
      var packageBreakdown = {
        '1/2 BBL Keg': parseInt(document.getElementById('pkg_halfBBL').value) || 0,
        '1/6 BBL Keg': parseInt(document.getElementById('pkg_sixthBBL').value) || 0,
        '1/4 BBL Keg': parseInt(document.getElementById('pkg_quarterBBL').value) || 0,
        '12oz Case (24pk)': parseInt(document.getElementById('pkg_12ozCase').value) || 0,
        '16oz Case (24pk)': parseInt(document.getElementById('pkg_16ozCase').value) || 0,
        'Crowler (32oz)': parseInt(document.getElementById('pkg_crowler').value) || 0,
        'Growler (64oz)': parseInt(document.getElementById('pkg_growler').value) || 0
      };
      
      var totalPackages = Object.values(packageBreakdown).reduce(function(a, b) { return a + b; }, 0);
      if (totalPackages === 0) { cellarToast('Enter at least one package count', 'error'); return; }
      
      cellarToast('Recording packaging...', 'info');
      
      // Store for Send It modal
      window.pendingPackageBreakdown = packageBreakdown;
      window.pendingBatchNumber = batchNumber;
      window.pendingExpectedYield = expectedYield;
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            cellarToast('Packaging recorded: ' + result.actualYieldBBL.toFixed(2) + ' BBL', 'success');
            closeCellarModal('packageModal');
            // Auto-show Send It modal
            showSendItModal(batchNumber, result.actualYieldBBL, expectedYield, packageBreakdown, result.vessel || '');
          } else {
            cellarToast('Error: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(err) { cellarToast('Error: ' + err.message, 'error'); })
        .recordPackaging(batchNumber, packageBreakdown, finalGravity, abv, packager);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MODAL 5: SEND IT! CONFIRMATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function showSendItModal(batchNumber, actualYield, expectedYield, packageBreakdown, currentVessel) {
      // If called without package data, fetch from batch
      if (!packageBreakdown) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success && result.batch) {
              var b = result.batch;
              renderSendItModal(batchNumber, b.actualYield || 0, b.expectedYield || 0, b.packageBreakdown || {}, b.vessel || '');
            } else {
              cellarToast('Could not load batch data', 'error');
            }
          })
          .getBatchSummary(batchNumber);
        return;
      }
      renderSendItModal(batchNumber, actualYield, expectedYield, packageBreakdown, currentVessel);
    }

    function renderSendItModal(batchNumber, actualYield, expectedYield, packageBreakdown, currentVessel) {
      var efficiency = expectedYield > 0 ? (actualYield / expectedYield * 100) : 0;
      var variance = actualYield - expectedYield;
      var variancePct = expectedYield > 0 ? (variance / expectedYield * 100) : 0;
      
      var pkgDisplay = '';
      for (var pkgType in packageBreakdown) {
        if (packageBreakdown[pkgType] > 0) {
          pkgDisplay += '<div class="pkg-line">' + pkgType + ': <strong>' + packageBreakdown[pkgType] + '</strong></div>';
        }
      }
      if (!pkgDisplay) pkgDisplay = '<div class="pkg-line">No packages recorded</div>';
      
      var hasWarning = Math.abs(variancePct) > 10;
      var warningMsg = hasWarning ? '<div class="warning-banner">‚ö†Ô∏è Yield variance exceeds 10% - verify package counts!</div>' : '';
      
      // Store for confirmation
      window.pendingPackageBreakdown = packageBreakdown;
      
      var modal = document.createElement('div');
      modal.id = 'sendItModal';
      modal.className = 'modal cellar-modal';
      modal.style.display = 'flex';
      modal.innerHTML = 
        '<div class="modal-content" style="max-width: 500px;">' +
          '<div class="modal-header send-it-header">' +
            '<h2>üöÄ SEND IT!</h2>' +
            '<button class="close-btn" onclick="closeCellarModal(\'sendItModal\')">&times;</button>' +
          '</div>' +
          '<div class="modal-body">' +
            '<div class="batch-info-banner send-it-banner">' +
              '<strong style="font-size:1.2em;">' + batchNumber + '</strong>' +
            '</div>' +
            warningMsg +
            '<div class="send-it-summary">' +
              '<div class="summary-section">' +
                '<h4>üìä Yield Summary</h4>' +
                '<div class="summary-row"><span>Expected Yield:</span><span>' + (expectedYield || 0).toFixed(2) + ' BBL</span></div>' +
                '<div class="summary-row"><span>Actual Yield:</span><strong>' + (actualYield || 0).toFixed(2) + ' BBL</strong></div>' +
                '<div class="summary-row ' + (hasWarning ? 'text-warning' : 'text-success') + '"><span>Efficiency:</span><strong>' + efficiency.toFixed(1) + '%</strong></div>' +
                '<div class="summary-row"><span>Variance:</span><span class="' + (variance >= 0 ? 'text-success' : 'text-warning') + '">' + (variance >= 0 ? '+' : '') + variance.toFixed(2) + ' BBL (' + (variancePct >= 0 ? '+' : '') + variancePct.toFixed(1) + '%)</span></div>' +
              '</div>' +
              '<div class="summary-section">' +
                '<h4>üì¶ Package Breakdown</h4>' +
                pkgDisplay +
              '</div>' +
            '</div>' +
            '<div class="send-it-actions">' +
              '<p><strong>This will:</strong></p>' +
              '<ul>' +
                '<li>‚úÖ Mark batch as "Packaged"</li>' +
                '<li>‚úÖ Add packages to Finished Goods inventory</li>' +
                '<li>‚úÖ Update Beer COGS Master</li>' +
                '<li>‚úÖ Record data for TTB/CO LED reports</li>' +
                '<li>‚úÖ Free vessel "' + (currentVessel || 'N/A') + '"</li>' +
                '<li>‚úÖ Archive batch record to Google Drive</li>' +
              '</ul>' +
            '</div>' +
          '</div>' +
          '<div class="modal-actions">' +
            '<button class="btn btn-secondary" onclick="closeCellarModal(\'sendItModal\')">Cancel</button>' +
            '<button class="btn btn-success" style="background:linear-gradient(135deg,#059669,#10b981);font-size:1.1em;padding:12px 30px;" onclick="confirmSendIt(\'' + batchNumber + '\', \'' + (currentVessel || '') + '\')">üöÄ SEND IT!</button>' +
          '</div>' +
        '</div>';
      document.body.appendChild(modal);
    }

    function confirmSendIt(batchNumber, currentVessel) {
      var packageBreakdown = window.pendingPackageBreakdown || {};
      cellarToast('üöÄ Sending it...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            closeCellarModal('sendItModal');
            showSendItComplete(result);
          } else {
            cellarToast('Error: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(err) { cellarToast('Error: ' + err.message, 'error'); })
        .sendIt(batchNumber, packageBreakdown, currentVessel);
    }

    function showSendItComplete(result) {
      var modal = document.createElement('div');
      modal.id = 'sendItCompleteModal';
      modal.className = 'modal cellar-modal';
      modal.style.display = 'flex';
      modal.innerHTML = 
        '<div class="modal-content" style="max-width:450px;text-align:center;">' +
          '<div class="modal-body" style="padding:40px 30px;">' +
            '<div style="font-size:4em;margin-bottom:20px;">üéâ</div>' +
            '<h2 style="color:#059669;margin-bottom:10px;">SENT!</h2>' +
            '<p style="font-size:1.1em;color:#374151;margin-bottom:20px;">Batch <strong>' + result.batchNumber + '</strong> is complete!</p>' +
            '<div class="completion-stats">' +
              '<div class="stat-item"><span class="stat-value">' + (result.actualYield || 0).toFixed(1) + '</span><span class="stat-label">BBL Yield</span></div>' +
              '<div class="stat-item"><span class="stat-value">' + (result.efficiency || 0).toFixed(0) + '%</span><span class="stat-label">Efficiency</span></div>' +
              '<div class="stat-item"><span class="stat-value">$' + (result.cogsPerBBL || 0).toFixed(2) + '</span><span class="stat-label">COGS/BBL</span></div>' +
            '</div>' +
            (result.archiveUrl ? '<div style="margin-top:20px;"><a href="' + result.archiveUrl + '" target="_blank" class="btn btn-secondary">üìÑ View Batch Record</a></div>' : '') +
          '</div>' +
          '<div class="modal-actions" style="justify-content:center;">' +
            '<button class="btn btn-primary" onclick="closeSendItComplete()">Done</button>' +
          '</div>' +
        '</div>';
      document.body.appendChild(modal);
    }

    function closeSendItComplete() {
      closeCellarModal('sendItCompleteModal');
      loadBatches();
      loadVesselStatus();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // UTILITY FUNCTIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function closeCellarModal(modalId) {
      var modal = document.getElementById(modalId);
      if (modal) modal.remove();
    }

    function cellarToast(message, type) {
      var existing = document.querySelector('.cellar-toast');
      if (existing) existing.remove();
      
      var toast = document.createElement('div');
      toast.className = 'cellar-toast cellar-toast-' + (type || 'info');
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(function() { toast.classList.add('cellar-toast-show'); }, 10);
      setTimeout(function() {
        toast.classList.remove('cellar-toast-show');
        setTimeout(function() { toast.remove(); }, 300);
      }, 3000);
    }

  </script>
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     BATCH SHEET MODAL - PASTE THIS BEFORE </body></html>
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- Batch Sheet Modal -->
<div id="batchSheetModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:900px;max-height:95vh;overflow:hidden;display:flex;flex-direction:column;">
    <div class="modal-header" style="background:linear-gradient(135deg,#8B0000,#a50000);color:white;flex-shrink:0;">
      <div>
        <h2 id="batchSheetTitle" style="margin:0;">Batch Sheet</h2>
        <div id="batchSheetSubtitle" style="font-size:14px;opacity:0.9;">Loading...</div>
      </div>
      <button class="close-btn" onclick="closeBatchSheetModal()" style="color:white;">&times;</button>
    </div>
    <div class="modal-body" style="flex:1;overflow-y:auto;padding:0;">
      <!-- Status Bar -->
      <div id="batchStatusBar" style="display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:#f8f9fa;border-bottom:1px solid #e2e8f0;">
        <div style="display:flex;gap:20px;align-items:center;">
          <span id="batchStatusBadge" class="badge badge-info">Loading</span>
          <span id="batchVesselDisplay" style="font-size:14px;color:#666;">Vessel: --</span>
          <span id="batchDaysDisplay" style="font-size:14px;color:#666;">Days: --</span>
        </div>
        <div id="batchCostDisplay" style="font-weight:600;color:#8B0000;">Cost: $--</div>
      </div>
      
      <!-- Tabs -->
      <div style="display:flex;border-bottom:2px solid #8B0000;background:#fff;">
        <button class="batch-tab active" data-tab="ingredients" onclick="switchBatchTab('ingredients')">üåæ Ingredients</button>
        <button class="batch-tab" data-tab="cellar" onclick="switchBatchTab('cellar')">üìã Cellar Log</button>
        <button class="batch-tab" data-tab="qa" onclick="switchBatchTab('qa')">üìä QA Data</button>
        <button class="batch-tab" data-tab="packaging" onclick="switchBatchTab('packaging')">üì¶ Packaging</button>
      </div>
      
      <!-- Tab Content -->
      <div style="padding:20px;">
        <!-- Ingredients Tab -->
        <div id="batchTab-ingredients" class="batch-tab-content">
          <div id="ingredientsContent">
            <div class="loading">Loading ingredients...</div>
          </div>
        </div>
        
        <!-- Cellar Log Tab -->
        <div id="batchTab-cellar" class="batch-tab-content" style="display:none;">
          <div style="display:flex;gap:10px;margin-bottom:15px;">
            <button class="btn btn-sm btn-outline" onclick="quickAddGravity()">üìä Add Gravity</button>
            <button class="btn btn-sm btn-outline" onclick="quickAddAddition()">üåø Add Addition</button>
            <button class="btn btn-sm btn-outline" onclick="quickAddNote()">üìù Add Note</button>
          </div>
          <div id="cellarLogContent">
            <div class="loading">Loading cellar log...</div>
          </div>
        </div>
        
        <!-- QA Tab -->
        <div id="batchTab-qa" class="batch-tab-content" style="display:none;">
          <div id="qaContent">
            <div class="loading">Loading QA data...</div>
          </div>
        </div>
        
        <!-- Packaging Tab -->
        <div id="batchTab-packaging" class="batch-tab-content" style="display:none;">
          <div id="packagingContent">
            <div class="loading">Loading packaging data...</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Action Footer -->
    <div id="batchActionFooter" style="padding:15px 20px;background:#f8f9fa;border-top:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;">
      <button class="btn btn-secondary" onclick="closeBatchSheetModal()">Close</button>
      <div id="batchActionButtons" style="display:flex;gap:10px;">
        <!-- Populated dynamically based on status -->
      </div>
    </div>
  </div>
</div>

<style>
/* Batch Sheet Styles */
.batch-tab {
  padding: 12px 20px;
  border: none;
  background: none;
  font-size: 14px;
  font-weight: 500;
  color: #666;
  cursor: pointer;
  border-bottom: 3px solid transparent;
  transition: all 0.2s;
}
.batch-tab:hover { color: #8B0000; background: rgba(139,0,0,0.05); }
.batch-tab.active { color: #8B0000; border-bottom-color: #8B0000; font-weight: 600; }
.batch-tab-content { min-height: 200px; }

.batch-row-clickable { cursor: pointer; }
.batch-row-clickable:hover { background: #fff3cd !important; }

.cellar-entry {
  display: flex;
  gap: 12px;
  padding: 12px;
  border-bottom: 1px solid #e2e8f0;
  align-items: flex-start;
}
.cellar-entry:last-child { border-bottom: none; }
.cellar-entry-icon { font-size: 20px; width: 30px; text-align: center; }
.cellar-entry-content { flex: 1; }
.cellar-entry-time { font-size: 12px; color: #666; }
.cellar-entry-value { font-weight: 600; margin-top: 4px; }
.cellar-entry-notes { font-size: 13px; color: #666; margin-top: 4px; }

.qa-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 15px;
}
.qa-item {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 15px;
  text-align: center;
}
.qa-label { font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 5px; }
.qa-value { font-size: 24px; font-weight: 700; color: #8B0000; }

.ingredient-table { width: 100%; border-collapse: collapse; }
.ingredient-table th { 
  text-align: left; 
  padding: 10px; 
  background: #f8f9fa; 
  font-size: 12px; 
  text-transform: uppercase; 
  color: #666;
  border-bottom: 2px solid #e2e8f0;
}
.ingredient-table td { padding: 10px; border-bottom: 1px solid #e2e8f0; }
.ingredient-table tr:last-child td { border-bottom: none; }

.pkg-summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}
.pkg-summary-item {
  background: #f0fdf4;
  border: 1px solid #86efac;
  border-radius: 8px;
  padding: 12px;
  text-align: center;
}
.pkg-summary-count { font-size: 28px; font-weight: 700; color: #166534; }
.pkg-summary-type { font-size: 11px; color: #666; }
</style>
<!-- 
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  RED LEG BREWING - LABOR TRACKING UI COMPONENTS
  Add this to your BRM_UI HTML file
  REPLACES the old timer-based system with simple hour entry
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-->

<!-- STYLES FOR LABOR ENTRY -->
<style>
  /* Labor entry fields */
  .labor-entry-section {
    background: #f0f9ff;
    border: 1px solid #0ea5e9;
    border-radius: 8px;
    padding: 16px;
    margin: 16px 0;
  }
  
  .labor-entry-section h4 {
    margin: 0 0 12px 0;
    color: #0369a1;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .labor-entry-row {
    display: flex;
    gap: 12px;
    align-items: flex-end;
  }
  
  .labor-entry-row .form-group {
    flex: 1;
  }
  
  .labor-entry-row .form-group.hours-input {
    flex: 0 0 100px;
  }
  
  .labor-entry-row label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 4px;
  }
  
  .labor-entry-row select,
  .labor-entry-row input {
    width: 100%;
    padding: 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
  }
  
  .labor-entry-row select:focus,
  .labor-entry-row input:focus {
    outline: none;
    border-color: #0ea5e9;
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
  }
  
  .labor-required-note {
    font-size: 11px;
    color: #dc2626;
    margin-top: 8px;
    font-style: italic;
  }
  
  /* Multiple workers for cellar tasks */
  .labor-entries-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .labor-entry-item {
    display: flex;
    gap: 8px;
    align-items: center;
    background: white;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
  }
  
  .labor-entry-item select {
    flex: 1;
    padding: 8px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
  }
  
  .labor-entry-item input {
    width: 80px;
    padding: 8px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    text-align: right;
  }
  
  .labor-entry-item .remove-btn {
    background: #fee2e2;
    color: #dc2626;
    border: none;
    border-radius: 4px;
    width: 28px;
    height: 28px;
    cursor: pointer;
    font-size: 16px;
  }
  
  .add-worker-btn {
    background: #dbeafe;
    color: #1d4ed8;
    border: 1px dashed #3b82f6;
    border-radius: 6px;
    padding: 8px;
    width: 100%;
    cursor: pointer;
    font-size: 13px;
    margin-top: 8px;
  }
  
  .add-worker-btn:hover {
    background: #bfdbfe;
  }
</style>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LABOR TRACKING - JAVASCRIPT
// Simple manual hour entry system
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Store employee names (loaded from server - NO RATES)
var employeeList = [];
var brewerList = [];

/**
 * Load employee names from server (names only, no rates)
 */
function loadEmployeeList() {
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        employeeList = result.employees || [];
        console.log('Loaded employees:', employeeList.length);
      }
    })
    .withFailureHandler(function(err) {
      console.error('Error loading employees:', err);
    })
    .getEmployeeNames();
}

/**
 * Load brewer names (subset of employees)
 */
function loadBrewerList() {
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        brewerList = result.brewers || [];
      }
    })
    .getBrewerNames();
}

// Load on page init
if (typeof google !== 'undefined' && google.script) {
  loadEmployeeList();
  loadBrewerList();
}

/**
 * Generate employee dropdown HTML (names only - NO RATES SHOWN)
 * @param {string} selectId - ID for the select element
 * @param {string} defaultValue - Optional default selected value
 * @param {boolean} brewersOnly - If true, only show brewers (Richard, Alex)
 */
function getEmployeeDropdownHtml(selectId, defaultValue, brewersOnly) {
  var list = brewersOnly ? brewerList : employeeList;
  
  // Fallback if list not loaded yet
  if (list.length === 0) {
    list = brewersOnly 
      ? [{ name: 'Richard Mar', role: 'Brewer' }, { name: 'Alex Velasco', role: 'Brewer' }]
      : [
          { name: 'Richard Mar', role: 'Brewer' },
          { name: 'Alex Velasco', role: 'Brewer' },
          { name: 'Jeremy Ueberroth', role: 'Cellar/Packaging' },
          { name: 'Zach Schneider', role: 'Cellar/Packaging' },
          { name: 'Dwayne Klaus', role: 'Cellar/Packaging' }
        ];
  }
  
  var html = '<select id="' + selectId + '" required>';
  html += '<option value="">-- Select --</option>';
  
  list.forEach(function(emp) {
    var selected = (defaultValue && emp.name === defaultValue) ? ' selected' : '';
    html += '<option value="' + escapeHtml(emp.name) + '"' + selected + '>' + escapeHtml(emp.name) + '</option>';
  });
  
  html += '</select>';
  return html;
}

/**
 * Generate labor entry section HTML for single worker
 * Used in Brewer's Sheet and simple tasks
 */
function getLaborEntrySectionHtml(prefix, title, brewersOnly, showRequired) {
  var dropdownHtml = getEmployeeDropdownHtml(prefix + 'Worker', '', brewersOnly);
  
  return '<div class="labor-entry-section">' +
    '<h4>üë∑ ' + (title || 'Labor Entry') + '</h4>' +
    '<div class="labor-entry-row">' +
      '<div class="form-group">' +
        '<label>Worker</label>' +
        dropdownHtml +
      '</div>' +
      '<div class="form-group hours-input">' +
        '<label>Hours</label>' +
        '<input type="number" id="' + prefix + 'Hours" step="0.25" min="0.25" max="24" placeholder="0.0" required>' +
      '</div>' +
    '</div>' +
    (showRequired ? '<div class="labor-required-note">‚ö†Ô∏è Required before continuing</div>' : '') +
  '</div>';
}

/**
 * Generate labor entry section for multiple workers
 * Used in cellar tasks where multiple people might work
 */
function getMultiLaborEntrySectionHtml(prefix, title) {
  return '<div class="labor-entry-section">' +
    '<h4>üë∑ ' + (title || 'Task Labor') + '</h4>' +
    '<div id="' + prefix + 'LaborList" class="labor-entries-list">' +
      '<div class="labor-entry-item" data-index="0">' +
        getEmployeeDropdownHtml(prefix + 'Worker_0', '', false) +
        '<input type="number" id="' + prefix + 'Hours_0" step="0.25" min="0.25" max="24" placeholder="Hours">' +
        '<button type="button" class="remove-btn" onclick="removeLaborEntry(\'' + prefix + '\', 0)" title="Remove">√ó</button>' +
      '</div>' +
    '</div>' +
    '<button type="button" class="add-worker-btn" onclick="addLaborEntry(\'' + prefix + '\')">+ Add Another Worker</button>' +
    '<div class="labor-required-note">‚ö†Ô∏è At least one worker with hours required</div>' +
  '</div>';
}

// Track labor entry counts for multi-worker forms
var laborEntryCounters = {};

/**
 * Add another worker entry to a multi-labor form
 */
function addLaborEntry(prefix) {
  if (!laborEntryCounters[prefix]) {
    laborEntryCounters[prefix] = 1;
  }
  
  var index = laborEntryCounters[prefix]++;
  var container = document.getElementById(prefix + 'LaborList');
  
  if (!container) return;
  
  var entryHtml = '<div class="labor-entry-item" data-index="' + index + '">' +
    getEmployeeDropdownHtml(prefix + 'Worker_' + index, '', false) +
    '<input type="number" id="' + prefix + 'Hours_' + index + '" step="0.25" min="0.25" max="24" placeholder="Hours">' +
    '<button type="button" class="remove-btn" onclick="removeLaborEntry(\'' + prefix + '\', ' + index + ')" title="Remove">√ó</button>' +
  '</div>';
  
  container.insertAdjacentHTML('beforeend', entryHtml);
}

/**
 * Remove a worker entry from a multi-labor form
 */
function removeLaborEntry(prefix, index) {
  var container = document.getElementById(prefix + 'LaborList');
  if (!container) return;
  
  var items = container.querySelectorAll('.labor-entry-item');
  
  // Don't remove if it's the only entry
  if (items.length <= 1) {
    showToast('At least one worker is required', 'error');
    return;
  }
  
  var item = container.querySelector('.labor-entry-item[data-index="' + index + '"]');
  if (item) {
    item.remove();
  }
}

/**
 * Get labor entries from a single-worker form
 */
function getSingleLaborEntry(prefix) {
  var worker = document.getElementById(prefix + 'Worker');
  var hours = document.getElementById(prefix + 'Hours');
  
  if (!worker || !hours) return null;
  
  var workerName = worker.value;
  var hoursVal = parseFloat(hours.value) || 0;
  
  if (!workerName || hoursVal <= 0) return null;
  
  return {
    employee: workerName,
    hours: hoursVal
  };
}

/**
 * Get all labor entries from a multi-worker form
 */
function getMultiLaborEntries(prefix) {
  var container = document.getElementById(prefix + 'LaborList');
  if (!container) return [];
  
  var entries = [];
  var items = container.querySelectorAll('.labor-entry-item');
  
  items.forEach(function(item) {
    var index = item.getAttribute('data-index');
    var worker = document.getElementById(prefix + 'Worker_' + index);
    var hours = document.getElementById(prefix + 'Hours_' + index);
    
    if (worker && hours) {
      var workerName = worker.value;
      var hoursVal = parseFloat(hours.value) || 0;
      
      if (workerName && hoursVal > 0) {
        entries.push({
          employee: workerName,
          hours: hoursVal
        });
      }
    }
  });
  
  return entries;
}

/**
 * Validate labor entry (single worker)
 */
function validateSingleLabor(prefix) {
  var entry = getSingleLaborEntry(prefix);
  
  if (!entry) {
    showToast('Please select a worker and enter hours', 'error');
    return false;
  }
  
  if (entry.hours < 0.25) {
    showToast('Hours must be at least 0.25', 'error');
    return false;
  }
  
  return true;
}

/**
 * Validate labor entries (multi-worker)
 */
function validateMultiLabor(prefix) {
  var entries = getMultiLaborEntries(prefix);
  
  if (entries.length === 0) {
    showToast('Please enter at least one worker with hours', 'error');
    return false;
  }
  
  return true;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CELLAR TASK MODALS WITH LABOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * Show Addition Modal (Dry Hop, etc.) with labor entry
 */
function showAdditionModalWithLabor(batchNumber, beerName) {
  var existing = document.getElementById('additionModal');
  if (existing) existing.remove();
  
  var workerOptions = [
    'Richard Mar', 'Alex Velasco', 'Jeremy Ueberroth', 'Zach Schneider', 'Dwayne Klaus'
  ].map(function(name) {
    return '<option value="' + name + '">' + name + '</option>';
  }).join('');
  
  var modalHtml = '<div id="additionModal" class="modal" style="display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:2000;justify-content:center;align-items:center;padding:20px;">' +
    '<div class="modal-content" style="background:white;border-radius:12px;max-width:500px;width:100%;">' +
      '<div class="modal-header" style="background:linear-gradient(135deg,#228B22,#2d8b2d);color:white;padding:16px 20px;border-radius:12px 12px 0 0;">' +
        '<h2 style="margin:0;font-size:18px;">üåø Cellar Addition</h2>' +
        '<button onclick="closeAdditionModal()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:30px;height:30px;border-radius:50%;cursor:pointer;position:absolute;right:16px;top:16px;">‚úï</button>' +
      '</div>' +
      '<div style="padding:20px;">' +
        '<div style="background:#f0f7ff;border:1px solid #3b82f6;padding:12px;border-radius:8px;margin-bottom:16px;">' +
          '<strong>' + escapeHtml(batchNumber) + '</strong>' + (beerName ? ' - ' + escapeHtml(beerName) : '') +
        '</div>' +
        
        // Addition details
        '<div style="margin-bottom:16px;">' +
          '<label style="font-weight:600;font-size:13px;">Addition Type</label>' +
          '<select id="additionType" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-top:4px;">' +
            '<option value="Dry Hop">üåø Dry Hop</option>' +
            '<option value="Fruit">üçá Fruit</option>' +
            '<option value="Finings">üß™ Finings</option>' +
            '<option value="Spices">üå∂Ô∏è Spices</option>' +
            '<option value="Other">üì¶ Other</option>' +
          '</select>' +
        '</div>' +
        
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">' +
          '<div>' +
            '<label style="font-weight:600;font-size:13px;">Item</label>' +
            '<input type="text" id="additionItem" placeholder="e.g., Citra hops" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-top:4px;">' +
          '</div>' +
          '<div>' +
            '<label style="font-weight:600;font-size:13px;">Amount</label>' +
            '<div style="display:flex;gap:8px;margin-top:4px;">' +
              '<input type="number" id="additionAmount" step="0.1" min="0" style="flex:1;padding:10px;border:1px solid #ccc;border-radius:6px;">' +
              '<select id="additionUom" style="width:70px;padding:10px;border:1px solid #ccc;border-radius:6px;">' +
                '<option value="lb">lb</option>' +
                '<option value="oz">oz</option>' +
                '<option value="g">g</option>' +
                '<option value="gal">gal</option>' +
                '<option value="each">each</option>' +
              '</select>' +
            '</div>' +
          '</div>' +
        '</div>' +
        
        // LABOR ENTRY (NEW)
        '<div class="labor-entry-section">' +
          '<h4>üë∑ Task Labor</h4>' +
          '<div class="labor-entry-row">' +
            '<div class="form-group">' +
              '<label>Worker</label>' +
              '<select id="additionWorker" required><option value="">-- Select --</option>' + workerOptions + '</select>' +
            '</div>' +
            '<div class="form-group hours-input">' +
              '<label>Hours</label>' +
              '<input type="number" id="additionHours" step="0.25" min="0.25" max="24" placeholder="0.5" required>' +
            '</div>' +
          '</div>' +
          '<div class="labor-required-note">‚ö†Ô∏è Required before saving</div>' +
        '</div>' +
        
        '<div style="margin-bottom:16px;">' +
          '<label style="font-weight:600;font-size:13px;">Notes</label>' +
          '<textarea id="additionNotes" rows="2" placeholder="Optional notes..." style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-top:4px;"></textarea>' +
        '</div>' +
        
        '<div style="display:flex;gap:12px;justify-content:flex-end;">' +
          '<button onclick="closeAdditionModal()" style="padding:10px 20px;background:#e9ecef;border:none;border-radius:6px;cursor:pointer;">Cancel</button>' +
          '<button onclick="submitAdditionWithLabor(\'' + escapeHtml(batchNumber) + '\')" style="padding:10px 20px;background:#228B22;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;">‚úÖ Save Addition</button>' +
        '</div>' +
      '</div>' +
    '</div>' +
  '</div>';
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeAdditionModal() {
  var modal = document.getElementById('additionModal');
  if (modal) modal.remove();
}

function submitAdditionWithLabor(batchNumber) {
  var additionType = document.getElementById('additionType').value;
  var item = document.getElementById('additionItem').value;
  var amount = parseFloat(document.getElementById('additionAmount').value) || 0;
  var uom = document.getElementById('additionUom').value;
  var worker = document.getElementById('additionWorker').value;
  var hours = parseFloat(document.getElementById('additionHours').value) || 0;
  var notes = document.getElementById('additionNotes').value;
  
  if (!item) { showToast('Please enter the item name', 'error'); return; }
  if (amount <= 0) { showToast('Please enter an amount', 'error'); return; }
  if (!worker) { showToast('Please select a worker', 'error'); return; }
  if (hours <= 0) { showToast('Please enter hours worked', 'error'); return; }
  
  showToast('Saving addition...', 'info');
  
  // First add the cellar addition
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        // Now log the labor
        google.script.run
          .withSuccessHandler(function(laborResult) {
            closeAdditionModal();
            if (laborResult.success) {
              showToast('‚úÖ ' + additionType + ' added! Labor: ' + hours + ' hrs logged', 'success');
            } else {
              showToast('‚úÖ ' + additionType + ' added! (Labor issue: ' + laborResult.error + ')', 'warning');
            }
            if (typeof loadBatches === 'function') loadBatches();
          })
          .withFailureHandler(function(err) {
            closeAdditionModal();
            showToast('Addition saved but labor log failed', 'warning');
          })
          .logCellarLabor(batchNumber, worker, hours, additionType);
      } else {
        showToast('Error: ' + result.error, 'error');
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + err, 'error');
    })
    .addCellarAddition(batchNumber, item, amount, uom, notes);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PACKAGING MODAL WITH LABOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * Show Package Modal with labor entry
 */
function showPackageModalWithLaborEntry(batchNumber, beerName, expectedYield, vessel) {
  window.pkgExpectedYield = expectedYield || 0;
  window.pkgCurrentVessel = vessel || '';
  
  var existing = document.getElementById('packageModal');
  if (existing) existing.remove();
  
  var workerOptions = [
    'Richard Mar', 'Alex Velasco', 'Jeremy Ueberroth', 'Zach Schneider', 'Dwayne Klaus'
  ].map(function(name) {
    return '<option value="' + name + '">' + name + '</option>';
  }).join('');
  
  var modalHtml = '<div id="packageModal" class="modal" style="display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:2000;justify-content:center;align-items:flex-start;padding:20px;overflow-y:auto;">' +
    '<div class="modal-content" style="background:white;border-radius:12px;max-width:600px;width:100%;margin:20px auto;">' +
      '<div class="modal-header" style="background:linear-gradient(135deg,#059669,#10b981);color:white;padding:16px 20px;border-radius:12px 12px 0 0;">' +
        '<h2 style="margin:0;font-size:18px;">üì¶ Package Batch</h2>' +
        '<button onclick="closePackageModal()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:30px;height:30px;border-radius:50%;cursor:pointer;position:absolute;right:16px;top:16px;">‚úï</button>' +
      '</div>' +
      '<div style="padding:20px;">' +
        '<div style="background:#f0fdf4;border:1px solid #22c55e;padding:12px;border-radius:8px;margin-bottom:16px;">' +
          '<strong>' + escapeHtml(batchNumber) + '</strong> - ' + escapeHtml(beerName || 'Unknown Beer') +
          '<br><small>Expected Yield: ' + (expectedYield || '?') + ' BBL</small>' +
        '</div>' +
        
        // Package counts
        '<h4 style="margin:0 0 12px 0;font-size:14px;border-bottom:1px solid #e5e7eb;padding-bottom:8px;">üìä Package Counts</h4>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">' +
          '<div><label style="font-size:12px;color:#666;">1/2 BBL Kegs</label><input type="number" id="pkg_halfBBL" value="0" min="0" onchange="updatePkgYield()" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;"></div>' +
          '<div><label style="font-size:12px;color:#666;">1/6 BBL Kegs</label><input type="number" id="pkg_sixthBBL" value="0" min="0" onchange="updatePkgYield()" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;"></div>' +
          '<div><label style="font-size:12px;color:#666;">1/4 BBL Kegs</label><input type="number" id="pkg_quarterBBL" value="0" min="0" onchange="updatePkgYield()" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;"></div>' +
          '<div><label style="font-size:12px;color:#666;">12oz Cases (24pk)</label><input type="number" id="pkg_12ozCase" value="0" min="0" onchange="updatePkgYield()" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;"></div>' +
          '<div><label style="font-size:12px;color:#666;">16oz Cases (24pk)</label><input type="number" id="pkg_16ozCase" value="0" min="0" onchange="updatePkgYield()" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;"></div>' +
          '<div><label style="font-size:12px;color:#666;">Crowlers (32oz)</label><input type="number" id="pkg_crowler" value="0" min="0" onchange="updatePkgYield()" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;"></div>' +
        '</div>' +
        
        // Yield calculation
        '<div id="pkgYieldCalc" style="background:#f0f9ff;padding:12px;border-radius:8px;margin-bottom:16px;">' +
          '<div style="display:flex;justify-content:space-between;"><span>Calculated Yield:</span><span id="pkgCalcYieldDisplay">0.00 BBL</span></div>' +
          '<div style="display:flex;justify-content:space-between;color:#666;font-size:13px;"><span>Expected:</span><span>' + (expectedYield || '?') + ' BBL</span></div>' +
          '<div id="pkgVarianceDisplay" style="margin-top:5px;font-weight:600;"></div>' +
        '</div>' +
        
        // QA Data
        '<div style="display:flex;gap:12px;margin-bottom:16px;">' +
          '<div style="flex:1;"><label style="font-size:12px;color:#666;">Final Gravity</label><input type="number" id="pkgFG" step="0.001" min="0.990" max="1.030" placeholder="1.012" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;"></div>' +
          '<div style="flex:1;"><label style="font-size:12px;color:#666;">ABV %</label><input type="number" id="pkgABV" step="0.1" min="0" max="20" placeholder="5.5" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;"></div>' +
        '</div>' +
        
        // PACKAGING LABOR (NEW)
        '<div class="labor-entry-section">' +
          '<h4>üë∑ Packaging Labor</h4>' +
          '<div class="labor-entry-row">' +
            '<div class="form-group">' +
              '<label>Packager</label>' +
              '<select id="pkgWorker" required><option value="">-- Select --</option>' + workerOptions + '</select>' +
            '</div>' +
            '<div class="form-group hours-input">' +
              '<label>Hours</label>' +
              '<input type="number" id="pkgHours" step="0.25" min="0.25" max="24" placeholder="0.0" required>' +
            '</div>' +
          '</div>' +
          '<div class="labor-required-note">‚ö†Ô∏è Required before completing batch</div>' +
        '</div>' +
        
        // Buttons
        '<div style="display:flex;gap:12px;justify-content:flex-end;margin-top:20px;">' +
          '<button onclick="closePackageModal()" style="padding:10px 20px;background:#e9ecef;border:none;border-radius:6px;cursor:pointer;">Cancel</button>' +
          '<button onclick="submitPackageWithLabor(\'' + escapeHtml(batchNumber) + '\')" style="padding:12px 24px;background:linear-gradient(135deg,#059669,#10b981);color:white;border:none;border-radius:6px;cursor:pointer;font-weight:bold;font-size:15px;">üöÄ SEND IT!</button>' +
        '</div>' +
      '</div>' +
    '</div>' +
  '</div>';
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closePackageModal() {
  var modal = document.getElementById('packageModal');
  if (modal) modal.remove();
}

function updatePkgYield() {
  var halfBBL = parseInt(document.getElementById('pkg_halfBBL').value) || 0;
  var sixthBBL = parseInt(document.getElementById('pkg_sixthBBL').value) || 0;
  var quarterBBL = parseInt(document.getElementById('pkg_quarterBBL').value) || 0;
  var case12 = parseInt(document.getElementById('pkg_12ozCase').value) || 0;
  var case16 = parseInt(document.getElementById('pkg_16ozCase').value) || 0;
  var crowler = parseInt(document.getElementById('pkg_crowler').value) || 0;
  
  var totalBBL = (halfBBL * 0.5) + (sixthBBL * 0.1667) + (quarterBBL * 0.25) + 
                 (case12 * 0.0685) + (case16 * 0.0913) + (crowler * 0.0081);
  
  document.getElementById('pkgCalcYieldDisplay').textContent = totalBBL.toFixed(2) + ' BBL';
  
  var expectedYield = window.pkgExpectedYield || 0;
  if (expectedYield > 0) {
    var variance = totalBBL - expectedYield;
    var variancePct = (variance / expectedYield) * 100;
    var display = document.getElementById('pkgVarianceDisplay');
    display.innerHTML = '<span>Variance: ' + (variance >= 0 ? '+' : '') + variance.toFixed(2) + ' BBL (' + (variancePct >= 0 ? '+' : '') + variancePct.toFixed(1) + '%)</span>';
    
    if (Math.abs(variancePct) > 10) display.style.color = '#dc2626';
    else if (Math.abs(variancePct) > 5) display.style.color = '#d97706';
    else display.style.color = '#059669';
  }
}

function submitPackageWithLabor(batchNumber) {
  var worker = document.getElementById('pkgWorker').value;
  var hours = parseFloat(document.getElementById('pkgHours').value) || 0;
  var fg = parseFloat(document.getElementById('pkgFG').value);
  var abv = parseFloat(document.getElementById('pkgABV').value);
  
  var packageBreakdown = {
    '1/2 BBL Keg': parseInt(document.getElementById('pkg_halfBBL').value) || 0,
    '1/6 BBL Keg': parseInt(document.getElementById('pkg_sixthBBL').value) || 0,
    '1/4 BBL Keg': parseInt(document.getElementById('pkg_quarterBBL').value) || 0,
    '12oz Case (24pk)': parseInt(document.getElementById('pkg_12ozCase').value) || 0,
    '16oz Case (24pk)': parseInt(document.getElementById('pkg_16ozCase').value) || 0,
    'Crowler (32oz)': parseInt(document.getElementById('pkg_crowler').value) || 0
  };
  
  var totalPackages = Object.values(packageBreakdown).reduce(function(a, b) { return a + b; }, 0);
  
  if (totalPackages === 0) { showToast('Enter at least one package count', 'error'); return; }
  if (!worker) { showToast('Please select a packager', 'error'); return; }
  if (hours <= 0) { showToast('Please enter hours worked', 'error'); return; }
  
  showToast('üöÄ SEND IT! Processing...', 'info');
  
  // First log packaging labor
  google.script.run
    .withSuccessHandler(function(laborResult) {
      // Then complete the batch
      google.script.run
        .withSuccessHandler(function(result) {
          closePackageModal();
          if (result.success) {
            showToast('üöÄ ' + result.message + ' | Packaging labor: ' + hours + ' hrs', 'success');
            if (typeof loadBatches === 'function') loadBatches();
            if (typeof loadFinishedGoods === 'function') loadFinishedGoods();
          } else {
            showToast('Error: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(err) {
          showToast('Error completing batch: ' + err, 'error');
        })
        .sendItComplete(batchNumber, packageBreakdown, window.pkgCurrentVessel);
    })
    .withFailureHandler(function(err) {
      showToast('Error logging labor: ' + err, 'error');
    })
    .logPackagingLabor(batchNumber, worker, hours);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRANSFER MODAL WITH LABOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function showTransferModalWithLabor(batchNumber, beerName, currentVessel, vessels) {
  var existing = document.getElementById('transferModal');
  if (existing) existing.remove();
  
  var vesselOptions = (vessels || [])
    .filter(function(v) { return v.available && v.name !== currentVessel; })
    .map(function(v) {
      return '<option value="' + v.name + '">' + v.name + ' (' + v.capacity + ' BBL)</option>';
    }).join('');
  
  var workerOptions = [
    'Richard Mar', 'Alex Velasco', 'Jeremy Ueberroth', 'Zach Schneider', 'Dwayne Klaus'
  ].map(function(name) {
    return '<option value="' + name + '">' + name + '</option>';
  }).join('');
  
  var modalHtml = '<div id="transferModal" class="modal" style="display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:2000;justify-content:center;align-items:center;padding:20px;">' +
    '<div class="modal-content" style="background:white;border-radius:12px;max-width:450px;width:100%;">' +
      '<div class="modal-header" style="background:linear-gradient(135deg,#2563eb,#1d4ed8);color:white;padding:16px 20px;border-radius:12px 12px 0 0;">' +
        '<h2 style="margin:0;font-size:18px;">üîÑ Transfer Vessel</h2>' +
        '<button onclick="closeTransferModal()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:30px;height:30px;border-radius:50%;cursor:pointer;position:absolute;right:16px;top:16px;">‚úï</button>' +
      '</div>' +
      '<div style="padding:20px;">' +
        '<div style="background:#f0f7ff;border:1px solid #3b82f6;padding:12px;border-radius:8px;margin-bottom:16px;">' +
          '<strong>' + escapeHtml(batchNumber) + '</strong> - ' + escapeHtml(beerName || '') +
          '<br><small>Current: ' + escapeHtml(currentVessel || 'Unknown') + '</small>' +
        '</div>' +
        
        '<div style="margin-bottom:16px;">' +
          '<label style="font-weight:600;font-size:13px;">Transfer To</label>' +
          '<select id="transferToVessel" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-top:4px;">' +
            '<option value="">-- Select Vessel --</option>' +
            vesselOptions +
          '</select>' +
        '</div>' +
        
        // LABOR ENTRY
        '<div class="labor-entry-section">' +
          '<h4>üë∑ Transfer Labor</h4>' +
          '<div class="labor-entry-row">' +
            '<div class="form-group">' +
              '<label>Worker</label>' +
              '<select id="transferWorker" required><option value="">-- Select --</option>' + workerOptions + '</select>' +
            '</div>' +
            '<div class="form-group hours-input">' +
              '<label>Hours</label>' +
              '<input type="number" id="transferHours" step="0.25" min="0.25" max="24" placeholder="0.5" required>' +
            '</div>' +
          '</div>' +
          '<div class="labor-required-note">‚ö†Ô∏è Required before saving</div>' +
        '</div>' +
        
        '<div style="margin-bottom:16px;">' +
          '<label style="font-weight:600;font-size:13px;">Notes</label>' +
          '<textarea id="transferNotes" rows="2" placeholder="Optional notes..." style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-top:4px;"></textarea>' +
        '</div>' +
        
        '<div style="display:flex;gap:12px;justify-content:flex-end;">' +
          '<button onclick="closeTransferModal()" style="padding:10px 20px;background:#e9ecef;border:none;border-radius:6px;cursor:pointer;">Cancel</button>' +
          '<button onclick="submitTransferWithLabor(\'' + escapeHtml(batchNumber) + '\', \'' + escapeHtml(currentVessel || '') + '\')" style="padding:10px 20px;background:#2563eb;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;">‚úÖ Transfer</button>' +
        '</div>' +
      '</div>' +
    '</div>' +
  '</div>';
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeTransferModal() {
  var modal = document.getElementById('transferModal');
  if (modal) modal.remove();
}

function submitTransferWithLabor(batchNumber, fromVessel) {
  var toVessel = document.getElementById('transferToVessel').value;
  var worker = document.getElementById('transferWorker').value;
  var hours = parseFloat(document.getElementById('transferHours').value) || 0;
  var notes = document.getElementById('transferNotes').value;
  
  if (!toVessel) { showToast('Please select a destination vessel', 'error'); return; }
  if (!worker) { showToast('Please select a worker', 'error'); return; }
  if (hours <= 0) { showToast('Please enter hours worked', 'error'); return; }
  
  showToast('Processing transfer...', 'info');
  
  // First do the transfer
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        // Log the labor
        google.script.run
          .withSuccessHandler(function(laborResult) {
            closeTransferModal();
            showToast('‚úÖ Transferred to ' + toVessel + '! Labor: ' + hours + ' hrs', 'success');
            if (typeof loadBatches === 'function') loadBatches();
          })
          .withFailureHandler(function(err) {
            closeTransferModal();
            showToast('Transfer complete but labor log failed', 'warning');
          })
          .logCellarLabor(batchNumber, worker, hours, 'Transfer');
      } else {
        showToast('Error: ' + result.error, 'error');
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + err, 'error');
    })
    .transferVessel(batchNumber, fromVessel, toVessel, notes);
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BATCH SHEET FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

var currentBatchData = null;
var currentBatchNumber = null;

function openBatchSheet(batchNumber) {
  currentBatchNumber = batchNumber;
  document.getElementById('batchSheetModal').style.display = 'flex';
  document.getElementById('batchSheetTitle').textContent = 'Batch ' + batchNumber;
  document.getElementById('batchSheetSubtitle').textContent = 'Loading...';
  
  // Reset tabs
  switchBatchTab('ingredients');
  
  // Load batch data
  loadBatchSheet(batchNumber);
}

function closeBatchSheetModal() {
  document.getElementById('batchSheetModal').style.display = 'none';
  currentBatchData = null;
  currentBatchNumber = null;
  loadBatches(); // Refresh the batch list
}

function loadBatchSheet(batchNumber) {
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        currentBatchData = result;
        renderBatchSheet(result);
      } else {
        showToast('Error loading batch: ' + result.error, 'error');
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + err, 'error');
    })
    .getBatchSheet(batchNumber);
}

function renderBatchSheet(data) {
  var batch = data.batch || {};
  var ingredients = data.ingredients || { grains: [], hops: [], other: [] };
  var cellarLog = data.cellarEntries || data.cellarLog || [];
  var qa = data.qa || {};
  var packaging = data.packaging || {};
  
  // Header
  document.getElementById('batchSheetTitle').textContent = batch.batchNumber || 'Batch';
  document.getElementById('batchSheetSubtitle').textContent = (batch.beerType || batch.beer || 'Unknown Beer') + ' ‚Ä¢ ' + (batch.batchSize || 60) + ' BBL';
  
  // Status bar
  var statusBadge = document.getElementById('batchStatusBadge');
  statusBadge.textContent = batch.status || 'Unknown';
  statusBadge.className = 'badge ' + getStatusBadge(batch.status);
  
  document.getElementById('batchVesselDisplay').textContent = 'Vessel: ' + (batch.vessel || batch.tank || 'Not assigned');
  
  var brewDate = batch.brewDate ? new Date(batch.brewDate) : null;
  var daysInTank = brewDate ? Math.floor((new Date() - brewDate) / (1000 * 60 * 60 * 24)) : '--';
  document.getElementById('batchDaysDisplay').textContent = 'Days: ' + daysInTank;
  
  var totalCost = (batch.rawMaterialsCost || 0) + (batch.laborCost || 0) + (batch.additionCost || 0);
  document.getElementById('batchCostDisplay').textContent = 'Total Cost: $' + formatNumber(totalCost);
  
  // Render tabs
  renderIngredientsTab(batch, ingredients);
  renderCellarLogTab(cellarLog);
  renderQATab(batch, qa);
  renderPackagingTab(batch, packaging);
  
  // Render action buttons based on status
  renderActionButtons(batch);
}

function renderIngredientsTab(batch, ingredients) {
  var content = document.getElementById('ingredientsContent');
  
  // Handle both object format {grains:[], hops:[], other:[]} and flat array
  var grains = [];
  var hops = [];
  var other = [];
  
  if (ingredients) {
    if (Array.isArray(ingredients)) {
      // Flat array format
      grains = ingredients.filter(function(i) { return (i.category || '').toLowerCase().indexOf('grain') !== -1; });
      hops = ingredients.filter(function(i) { return (i.category || '').toLowerCase().indexOf('hop') !== -1; });
      other = ingredients.filter(function(i) { 
        var cat = (i.category || '').toLowerCase();
        return cat.indexOf('grain') === -1 && cat.indexOf('hop') === -1; 
      });
    } else {
      // Object format from backend
      grains = ingredients.grains || [];
      hops = ingredients.hops || [];
      other = ingredients.other || [];
    }
  }
  
  var totalIngredients = grains.length + hops.length + other.length;
  
  if (totalIngredients === 0) {
    content.innerHTML = '<p class="text-muted" style="text-align:center;padding:40px;">No ingredients recorded yet.</p>';
    return;
  }
  
  var html = '<div style="margin-bottom:20px;">' +
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">' +
      '<span style="font-weight:600;color:#666;">Recipe Cost:</span>' +
      '<span style="font-size:20px;font-weight:700;color:#8B0000;">$' + formatNumber(batch.recipeCost || batch.rawMaterialsCost || 0) + '</span>' +
    '</div>' +
  '</div>';
  
  function renderCategory(title, emoji, items) {
    if (!items || items.length === 0) return '';
    var total = items.reduce(function(sum, i) { return sum + (parseFloat(i.totalCost) || parseFloat(i.cost) || 0); }, 0);
    return '<div style="margin-bottom:20px;">' +
      '<h4 style="margin:0 0 10px 0;border-bottom:2px solid #d4af37;padding-bottom:5px;">' + emoji + ' ' + title + ' ($' + formatNumber(total) + ')</h4>' +
      '<table class="ingredient-table">' +
        '<thead><tr><th>Ingredient</th><th style="text-align:right;">Amount</th><th>Unit</th><th style="text-align:right;">Cost</th></tr></thead>' +
        '<tbody>' + items.map(function(i) {
          return '<tr><td>' + escapeHtml(i.ingredient || i.item || i.name || '') + '</td>' +
            '<td style="text-align:right;">' + formatNumber(i.amount || i.qty || 0) + '</td>' +
            '<td>' + (i.uom || i.unit || '') + '</td>' +
            '<td style="text-align:right;">$' + formatNumber(i.totalCost || i.cost || 0) + '</td></tr>';
        }).join('') + '</tbody>' +
      '</table></div>';
  }
  
  html += renderCategory('Grains', 'üåæ', grains);
  html += renderCategory('Hops', 'üåø', hops);
  html += renderCategory('Other', 'üçØ', other);
  
  content.innerHTML = html;
}
  
  function renderCategory(title, emoji, items) {
    if (!items || items.length === 0) return '';
    var total = items.reduce(function(sum, i) { return sum + (i.totalCost || 0); }, 0);
    return '<div style="margin-bottom:20px;">' +
      '<h4 style="margin:0 0 10px 0;border-bottom:2px solid #d4af37;padding-bottom:5px;">' + emoji + ' ' + title + ' ($' + formatNumber(total) + ')</h4>' +
      '<table class="ingredient-table">' +
        '<thead><tr><th>Ingredient</th><th style="text-align:right;">Amount</th><th>Unit</th><th style="text-align:right;">Cost</th></tr></thead>' +
        '<tbody>' + items.map(function(i) {
          return '<tr><td>' + escapeHtml(i.ingredient || i.item) + '</td>' +
            '<td style="text-align:right;">' + formatNumber(i.amount || i.qty || 0) + '</td>' +
            '<td>' + (i.uom || i.unit || '') + '</td>' +
            '<td style="text-align:right;">$' + formatNumber(i.totalCost || 0) + '</td></tr>';
        }).join('') + '</tbody>' +
      '</table></div>';
  }
  
  html += renderCategory('Grains', 'üåæ', grains);
  html += renderCategory('Hops', 'üåø', hops);
  html += renderCategory('Other', 'üçØ', other);
  
  content.innerHTML = html;
}

function renderCellarLogTab(cellarLog) {
  var content = document.getElementById('cellarLogContent');
  
  if (!cellarLog || cellarLog.length === 0) {
    content.innerHTML = '<p class="text-muted" style="text-align:center;padding:40px;">No cellar entries yet.</p>';
    return;
  }
  
  var icons = {
    'Gravity': 'üìä',
    'Addition': 'üåø',
    'Transfer': 'üîÑ',
    'Package': 'üì¶',
    'QA': 'üî¨',
    'Note': 'üìù'
  };
  
  content.innerHTML = cellarLog.map(function(entry) {
    var icon = icons[entry.type] || 'üìã';
    var dateStr = entry.date ? formatDate(entry.date) : '';
    var timeStr = entry.time || '';
    
    return '<div class="cellar-entry">' +
      '<div class="cellar-entry-icon">' + icon + '</div>' +
      '<div class="cellar-entry-content">' +
        '<div class="cellar-entry-time">' + dateStr + (timeStr ? ' ' + timeStr : '') + '</div>' +
        '<div class="cellar-entry-value">' + escapeHtml(entry.description || entry.type) + 
          (entry.value ? ': <strong>' + entry.value + '</strong>' + (entry.units ? ' ' + entry.units : '') : '') +
        '</div>' +
        (entry.notes ? '<div class="cellar-entry-notes">' + escapeHtml(entry.notes) + '</div>' : '') +
        (entry.cost ? '<div style="font-size:12px;color:#8B0000;margin-top:4px;">Cost: $' + formatNumber(entry.cost) + '</div>' : '') +
      '</div>' +
    '</div>';
  }).join('');
}

function renderQATab(batch, qa) {
  var content = document.getElementById('qaContent');
  
  var qaData = [
    { label: 'Original Gravity', value: batch.ogActual || qa.og || '--' },
    { label: 'Final Gravity', value: batch.fgActual || qa.fg || '--' },
    { label: 'ABV', value: (batch.abvActual || qa.abv || '--') + (batch.abvActual || qa.abv ? '%' : '') },
    { label: 'IBU', value: batch.ibuActual || qa.ibu || '--' },
    { label: 'SRM', value: batch.srmActual || qa.srm || '--' },
    { label: 'Mash Temp', value: (batch.mashTemp || qa.mashTemp || '--') + (batch.mashTemp || qa.mashTemp ? '¬∞F' : '') },
    { label: 'Ferment Temp', value: (batch.fermentTemp || qa.fermentTemp || '--') + (batch.fermentTemp || qa.fermentTemp ? '¬∞F' : '') },
    { label: 'Terminal Gravity', value: batch.terminalGravity || qa.terminalGravity || '--' }
  ];
  
  content.innerHTML = '<div class="qa-grid">' + qaData.map(function(item) {
    return '<div class="qa-item">' +
      '<div class="qa-label">' + item.label + '</div>' +
      '<div class="qa-value">' + item.value + '</div>' +
    '</div>';
  }).join('') + '</div>' +
  '<div style="margin-top:20px;text-align:center;">' +
    '<button class="btn btn-outline btn-sm" onclick="editQAData()">‚úèÔ∏è Update QA Data</button>' +
  '</div>';
}

function renderPackagingTab(batch, packaging) {
  var content = document.getElementById('packagingContent');
  
  var pkgBreakdown = packaging.breakdown || batch.packageBreakdown || {};
  var hasPackaging = Object.keys(pkgBreakdown).some(function(k) { return pkgBreakdown[k] > 0; });
  
  if (!hasPackaging && batch.status !== 'Packaged') {
    content.innerHTML = '<div style="text-align:center;padding:40px;">' +
      '<p class="text-muted">Not packaged yet.</p>' +
      '<button class="btn btn-primary" onclick="showPackageModal(\'' + (batch.batchNumber || '') + '\', \'' + (batch.beerType || batch.beer || '') + '\', ' + (batch.expectedYield || batch.batchSize || 60) + ')">üì¶ Start Packaging</button>' +
    '</div>';
    return;
  }
  
  var html = '<div class="pkg-summary-grid">';
  var pkgTypes = ['1/2 BBL Keg', '1/6 BBL Keg', '1/4 BBL Keg', '12oz Case (24pk)', '16oz Case (24pk)', 'Crowler (32oz)', 'Growler (64oz)'];
  pkgTypes.forEach(function(type) {
    var count = pkgBreakdown[type] || 0;
    if (count > 0) {
      html += '<div class="pkg-summary-item">' +
        '<div class="pkg-summary-count">' + count + '</div>' +
        '<div class="pkg-summary-type">' + type + '</div>' +
      '</div>';
    }
  });
  html += '</div>';
  
  // Yield summary
  var expectedYield = batch.expectedYield || batch.batchSize || 60;
  var actualYield = batch.actualYield || packaging.actualYield || 0;
  var efficiency = expectedYield > 0 ? (actualYield / expectedYield * 100) : 0;
  
  html += '<div style="background:#f8f9fa;border-radius:8px;padding:15px;margin-top:15px;">' +
    '<div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>Expected Yield:</span><span>' + expectedYield + ' BBL</span></div>' +
    '<div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>Actual Yield:</span><strong>' + actualYield.toFixed(2) + ' BBL</strong></div>' +
    '<div style="display:flex;justify-content:space-between;"><span>Efficiency:</span><strong style="color:' + (efficiency >= 90 ? '#059669' : efficiency >= 80 ? '#d97706' : '#dc2626') + ';">' + efficiency.toFixed(1) + '%</strong></div>' +
  '</div>';
  
  if (batch.status !== 'Packaged') {
    html += '<div style="margin-top:15px;text-align:center;">' +
      '<button class="btn btn-outline btn-sm" onclick="showPackageModal(\'' + (batch.batchNumber || '') + '\', \'' + (batch.beerType || batch.beer || '') + '\', ' + expectedYield + ')">‚úèÔ∏è Edit Packaging</button>' +
    '</div>';
  }
  
  content.innerHTML = html;
}

function renderActionButtons(batch) {
  var container = document.getElementById('batchActionButtons');
  var status = batch.status || '';
  var batchNum = (batch.batchNumber || '').replace(/'/g, "\\'");
  var beerName = (batch.beerType || batch.beer || '').replace(/'/g, "\\'");
  var vessel = (batch.vessel || batch.tank || '').replace(/'/g, "\\'");
  var expectedYield = batch.expectedYield || batch.batchSize || 60;
  
  var buttons = [];
  
  switch(status) {
    case 'Brewing':
      buttons.push('<button class="btn btn-primary" onclick="closeBatchSheetModal();finalizeBrewModal(\'' + batchNum + '\')">‚úÖ Finalize Brew</button>');
      break;
    case 'Fermenting':
    case 'Conditioning':
    case 'Carbonating':
      buttons.push('<button class="btn btn-outline" onclick="closeBatchSheetModal();showGravityModal(\'' + batchNum + '\', \'' + beerName + '\')">üìä Gravity</button>');
      buttons.push('<button class="btn btn-outline" onclick="closeBatchSheetModal();showAdditionModal(\'' + batchNum + '\', \'' + beerName + '\')">üåø Addition</button>');
      buttons.push('<button class="btn btn-outline" onclick="closeBatchSheetModal();showTransferModal(\'' + batchNum + '\', \'' + beerName + '\', \'' + vessel + '\')">üîÑ Transfer</button>');
      buttons.push('<button class="btn btn-primary" onclick="closeBatchSheetModal();showPackageModal(\'' + batchNum + '\', \'' + beerName + '\', ' + expectedYield + ')">üì¶ Package</button>');
      break;
    case 'Ready to Package':
      buttons.push('<button class="btn btn-success" style="background:#059669;" onclick="closeBatchSheetModal();showSendItModal(\'' + batchNum + '\', ' + (batch.actualYield || 0) + ', ' + expectedYield + ', null, \'' + vessel + '\')">üöÄ SEND IT!</button>');
      break;
    case 'Packaged':
      buttons.push('<span style="color:#059669;font-weight:600;">‚úÖ Batch Complete!</span>');
      break;
    default:
      buttons.push('<button class="btn btn-outline" onclick="closeBatchSheetModal();updateBatchStatus(\'' + batchNum + '\', \'' + status + '\')">üìä Update Status</button>');
  }
  
  container.innerHTML = buttons.join('');
}

function switchBatchTab(tabName) {
  // Update tab buttons
  document.querySelectorAll('.batch-tab').forEach(function(btn) {
    btn.classList.remove('active');
    if (btn.dataset.tab === tabName) btn.classList.add('active');
  });
  
  // Update tab content
  document.querySelectorAll('.batch-tab-content').forEach(function(content) {
    content.style.display = 'none';
  });
  document.getElementById('batchTab-' + tabName).style.display = 'block';
}

// Quick add functions from cellar log tab
function quickAddGravity() {
  if (currentBatchNumber) {
    closeBatchSheetModal();
    var batch = currentBatchData ? currentBatchData.batch : {};
    showGravityModal(currentBatchNumber, batch.beerType || batch.beer || '');
  }
}

function quickAddAddition() {
  if (currentBatchNumber) {
    closeBatchSheetModal();
    var batch = currentBatchData ? currentBatchData.batch : {};
    showAdditionModal(currentBatchNumber, batch.beerType || batch.beer || '');
  }
}

function quickAddNote() {
  if (currentBatchNumber) {
    var note = prompt('Enter note for batch ' + currentBatchNumber + ':');
    if (note) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast('Note added!', 'success');
            loadBatchSheet(currentBatchNumber);
          } else {
            showToast('Error: ' + result.error, 'error');
          }
        })
        .addCellarEntry(currentBatchNumber, 'Note', null, null, note);
    }
  }
}

function editQAData() {
  if (currentBatchNumber) {
    showToast('Edit QA data in the Batch Log sheet', 'info');
    google.script.run.withSuccessHandler(function(url) {
      if (url) window.open(url, '_blank');
    }).getSheetUrl('Batch Log');
  }
}

function finalizeBrewModal(batchNumber) {
  // Get available vessels and show finalize modal
  google.script.run
    .withSuccessHandler(function(result) {
      renderFinalizeBrewModal(batchNumber, result.vessels || []);
    })
    .getAvailableVessels();
}

function renderFinalizeBrewModal(batchNumber, vessels) {
  var vesselOptions = vessels
    .filter(function(v) { return v.available; })
    .map(function(v) {
      return '<option value="' + v.name + '">' + v.name + ' (' + v.capacity + ' BBL)</option>';
    }).join('');
  
  var modal = document.createElement('div');
  modal.id = 'finalizeBrewModal';
  modal.className = 'modal';
  modal.style.display = 'flex';
  modal.innerHTML = 
    '<div class="modal-content" style="max-width:450px;">' +
      '<div class="modal-header" style="background:#8B0000;color:white;">' +
        '<h2>‚úÖ Finalize Brew</h2>' +
        '<button class="close-btn" onclick="document.getElementById(\'finalizeBrewModal\').remove()" style="color:white;">&times;</button>' +
      '</div>' +
      '<div class="modal-body">' +
        '<div style="background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;padding:12px;margin-bottom:16px;text-align:center;">' +
          '<strong>' + batchNumber + '</strong>' +
        '</div>' +
        '<div class="form-group">' +
          '<label>Assign to Vessel</label>' +
          '<select id="finalizeVessel" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;">' +
            '<option value="">-- Select Fermenter --</option>' +
            vesselOptions +
          '</select>' +
        '</div>' +
        '<div class="form-group">' +
          '<label>Original Gravity (OG)</label>' +
          '<input type="number" id="finalizeOG" step="0.001" min="1.000" max="1.150" placeholder="1.048" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;">' +
        '</div>' +
        '<div class="form-group">' +
          '<label>Mash Temp (¬∞F)</label>' +
          '<input type="number" id="finalizeMashTemp" step="1" min="140" max="170" placeholder="152" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;">' +
        '</div>' +
        '<div class="form-group">' +
          '<label>Notes</label>' +
          '<textarea id="finalizeNotes" rows="2" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;" placeholder="Brew day notes..."></textarea>' +
        '</div>' +
        '<div style="background:#fff3cd;border-radius:6px;padding:10px;font-size:13px;margin-top:16px;">' +
          '‚ö†Ô∏è This will deplete raw materials based on actual amounts used.' +
        '</div>' +
      '</div>' +
      '<div class="modal-actions">' +
        '<button class="btn btn-secondary" onclick="document.getElementById(\'finalizeBrewModal\').remove()">Cancel</button>' +
        '<button class="btn btn-primary" onclick="submitFinalizeBrew(\'' + batchNumber + '\')">‚úÖ Finalize & Start Fermentation</button>' +
      '</div>' +
    '</div>';
  document.body.appendChild(modal);
}

function submitFinalizeBrew(batchNumber) {
  var vessel = document.getElementById('finalizeVessel').value;
  var og = document.getElementById('finalizeOG').value;
  var mashTemp = document.getElementById('finalizeMashTemp').value;
  var notes = document.getElementById('finalizeNotes').value;
  
  if (!vessel) {
    showToast('Select a vessel', 'error');
    return;
  }
  
  showToast('Finalizing brew...', 'info');
  
  google.script.run
    .withSuccessHandler(function(result) {
      document.getElementById('finalizeBrewModal').remove();
      if (result.success) {
        showToast('Brew finalized! Status: Fermenting', 'success');
        loadBatches();
      } else {
        showToast('Error: ' + result.error, 'error');
      }
    })
    .withFailureHandler(function(err) {
      showToast('Error: ' + err, 'error');
    })
    .finalizeBrewWithActuals(batchNumber, vessel, null, null, og, mashTemp, notes);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UPDATE renderBatches TO MAKE ROWS CLICKABLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Store original and override
var _originalRenderBatches = renderBatches;

renderBatches = function(batches) {
  if (batches.length === 0) {
    document.getElementById('batchTableBody').innerHTML = '<tr><td colspan="11" class="empty-state">No batches found</td></tr>';
    return;
  }
  document.getElementById('batchTableBody').innerHTML = batches.map(function(b) {
    var isActive = b.status && ['Brewing', 'Fermenting', 'Conditioning', 'Carbonating', 'Ready to Package'].indexOf(b.status) !== -1;
    var batchNum = (b.batchNumber || '').replace(/'/g, "\\'");
    return '<tr class="batch-row-clickable" onclick="openBatchSheet(\'' + batchNum + '\')">' +
      '<td><strong>' + escapeHtml(b.batchNumber) + '</strong></td>' +
      '<td>' + formatDate(b.brewDate || b.date) + '</td>' +
      '<td>' + escapeHtml(b.beerType || b.beer) + '</td>' +
      '<td>' + escapeHtml(b.brewer || '-') + '</td>' +
      '<td>' + escapeHtml(b.vessel || b.tank || '-') + '</td>' +
      '<td style="text-align:right;">' + (b.batchSize || b.size || 0) + ' BBL</td>' +
      '<td style="text-align:right;">$' + formatNumber(b.rawMaterialsCost || 0) + '</td>' +
      '<td style="text-align:right;">$' + formatNumber(b.totalCost || 0) + '</td>' +
      '<td><span class="badge ' + getStatusBadge(b.status) + '">' + (b.status || 'Unknown') + '</span></td>' +
      '<td style="text-align:right;">' + (b.actualYield || b.expectedYield || '--') + '</td>' +
      '<td class="batch-actions" onclick="event.stopPropagation();">' + (isActive ? renderBatchActions(b) : '<button class="btn-icon" onclick="event.stopPropagation();openBatchSheet(\'' + batchNum + '\')" title="View">üëÅÔ∏è</button>') + '</td>' +
    '</tr>';
  }).join('');
};

</script>
<!-- ============================================
     EDIT RECIPE MODAL
     Paste this RIGHT BEFORE </body></html> in your BRM HTML file
     ============================================ -->

<!-- Edit Recipe Modal -->
<div id="editRecipeModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; overflow-y:auto;">
  <div style="background:white; margin:20px auto; max-width:900px; border-radius:12px; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
    
    <!-- Header -->
    <div style="background:linear-gradient(135deg, #1D3557 0%, #457B9D 100%); color:white; padding:20px 24px; border-radius:12px 12px 0 0; display:flex; justify-content:space-between; align-items:center;">
      <div>
        <h2 style="margin:0; font-size:22px;" id="editRecipeTitle">Edit Recipe</h2>
        <p style="margin:4px 0 0 0; opacity:0.8; font-size:13px;">Modify recipe details and ingredients</p>
      </div>
      <button onclick="closeEditRecipeModal()" style="background:rgba(255,255,255,0.2); border:none; color:white; width:36px; height:36px; border-radius:50%; cursor:pointer; font-size:20px;">√ó</button>
    </div>
    
    <!-- Tabs -->
    <div style="display:flex; border-bottom:2px solid #e5e7eb; background:#f8fafc;">
      <button class="edit-recipe-tab active" onclick="showEditRecipeTab('details')" id="tabDetails" style="flex:1; padding:14px; border:none; background:transparent; cursor:pointer; font-weight:600; color:#1D3557; border-bottom:3px solid #E63946; margin-bottom:-2px;">
        üìã Recipe Details
      </button>
      <button class="edit-recipe-tab" onclick="showEditRecipeTab('ingredients')" id="tabIngredients" style="flex:1; padding:14px; border:none; background:transparent; cursor:pointer; font-weight:500; color:#666; border-bottom:3px solid transparent; margin-bottom:-2px;">
        üåæ Ingredients
      </button>
      <button class="edit-recipe-tab" onclick="showEditRecipeTab('history')" id="tabHistory" style="flex:1; padding:14px; border:none; background:transparent; cursor:pointer; font-weight:500; color:#666; border-bottom:3px solid transparent; margin-bottom:-2px;">
        üìú Change History
      </button>
    </div>
    
    <!-- Tab Content -->
    <div style="padding:24px;">
      
      <!-- Details Tab -->
      <div id="editDetailsTab">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          
          <div>
            <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">Recipe Name</label>
            <input type="text" id="editRecipeName" style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;" readonly>
            <small style="color:#999;">Recipe name cannot be changed (would break batch links)</small>
          </div>
          
          <div>
            <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">Beer Type / Style</label>
            <input type="text" id="editBeerType" style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
          </div>
          
          <div>
            <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">Batch Size (BBL)</label>
            <input type="number" id="editBatchSize" step="0.1" style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
          </div>
          
          <div>
            <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">Expected Yield %</label>
            <input type="number" id="editExpectedYield" step="1" style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
          </div>
          
          <div>
            <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">OG (Original Gravity)</label>
            <input type="text" id="editOG" style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;" placeholder="1.055">
          </div>
          
          <div>
            <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">FG (Final Gravity)</label>
            <input type="text" id="editFG" style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;" placeholder="1.012">
          </div>
          
          <div>
            <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">ABV %</label>
            <input type="number" id="editABV" step="0.1" style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
          </div>
          
          <div>
            <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">IBU</label>
            <input type="number" id="editIBU" step="1" style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
          </div>
          
          <div>
            <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">SRM (Color)</label>
            <input type="number" id="editSRM" step="1" style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
          </div>
          
          <div>
            <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">Fermentation Days</label>
            <input type="number" id="editFermDays" step="1" style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
          </div>
          
          <div>
            <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">Mash Temp (¬∞F)</label>
            <input type="number" id="editMashTemp" step="1" style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
          </div>
          
          <div>
            <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">Sales Channel</label>
            <select id="editSalesChannel" style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
              <option value="Both">Both (Taproom + B2B)</option>
              <option value="Taproom Only">Taproom Only</option>
              <option value="B2B Only">B2B Only</option>
            </select>
          </div>
          
        </div>
      </div>
      
      <!-- Ingredients Tab -->
      <div id="editIngredientsTab" style="display:none;">
        
        <!-- Grains Section -->
        <div style="margin-bottom:24px;">
          <h4 style="color:#1D3557; margin:0 0 12px 0; display:flex; align-items:center; gap:8px;">
            üåæ Grains & Malts
            <button onclick="addIngredientRow('grain')" style="background:#10B981; color:white; border:none; padding:4px 10px; border-radius:4px; font-size:12px; cursor:pointer;">+ Add</button>
          </h4>
          <div id="grainsContainer"></div>
        </div>
        
        <!-- Hops Section -->
        <div style="margin-bottom:24px;">
          <h4 style="color:#1D3557; margin:0 0 12px 0; display:flex; align-items:center; gap:8px;">
            üåø Hops
            <button onclick="addIngredientRow('hop')" style="background:#10B981; color:white; border:none; padding:4px 10px; border-radius:4px; font-size:12px; cursor:pointer;">+ Add</button>
          </h4>
          <div id="hopsContainer"></div>
        </div>
        
        <!-- Yeast Section -->
        <div style="margin-bottom:24px;">
          <h4 style="color:#1D3557; margin:0 0 12px 0; display:flex; align-items:center; gap:8px;">
            üß´ Yeast
            <button onclick="addIngredientRow('yeast')" style="background:#10B981; color:white; border:none; padding:4px 10px; border-radius:4px; font-size:12px; cursor:pointer;">+ Add</button>
          </h4>
          <div id="yeastContainer"></div>
        </div>
        
        <!-- Other Section -->
        <div style="margin-bottom:24px;">
          <h4 style="color:#1D3557; margin:0 0 12px 0; display:flex; align-items:center; gap:8px;">
            üì¶ Other (Adjuncts, Fruit, etc.)
            <button onclick="addIngredientRow('other')" style="background:#10B981; color:white; border:none; padding:4px 10px; border-radius:4px; font-size:12px; cursor:pointer;">+ Add</button>
          </h4>
          <div id="otherContainer"></div>
        </div>
        
      </div>
      
      <!-- History Tab -->
      <div id="editHistoryTab" style="display:none;">
        <div id="changeHistoryContainer">
          <p style="color:#666; text-align:center; padding:40px;">Loading change history...</p>
        </div>
      </div>
      
      <!-- Reason for Change (shown on Details and Ingredients tabs) -->
      <div id="reasonSection" style="margin-top:24px; padding-top:20px; border-top:1px solid #e5e7eb;">
        <label style="display:block; font-weight:600; color:#E63946; margin-bottom:6px;">
          ‚ö†Ô∏è Reason for Change (Required)
        </label>
        <textarea id="editChangeReason" rows="2" style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; resize:vertical;" placeholder="e.g., Supplier shortage - substituted Cascade for Centennial"></textarea>
      </div>
      
    </div>
    
    <!-- Footer -->
    <div style="padding:16px 24px; background:#f8fafc; border-top:1px solid #e5e7eb; border-radius:0 0 12px 12px; display:flex; justify-content:space-between; align-items:center;">
      <button onclick="closeEditRecipeModal()" style="background:#6B7280; color:white; border:none; padding:12px 24px; border-radius:6px; font-weight:600; cursor:pointer;">
        Cancel
      </button>
      <button onclick="saveRecipeChanges()" id="saveRecipeBtn" style="background:linear-gradient(135deg, #E63946 0%, #d62839 100%); color:white; border:none; padding:12px 32px; border-radius:6px; font-weight:600; cursor:pointer; font-size:15px;">
        üíæ Save Changes
      </button>
    </div>
    
  </div>
</div>

<script>
// ============================================
// EDIT RECIPE MODAL JAVASCRIPT
// ============================================

let currentEditRecipe = null;
let originalRecipeData = null;
let ingredientChanges = [];

/**
 * Open the Edit Recipe modal
 * @param {string} recipeName - Name of recipe to edit
 */
function openEditRecipeModal(recipeName) {
  currentEditRecipe = recipeName;
  ingredientChanges = [];
  
  document.getElementById('editRecipeModal').style.display = 'block';
  document.getElementById('editRecipeTitle').textContent = 'Edit Recipe: ' + recipeName;
  
  // Show loading state
  document.getElementById('editDetailsTab').innerHTML = '<p style="text-align:center; padding:40px; color:#666;">Loading recipe data...</p>';
  
  // Fetch recipe data
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        originalRecipeData = result;
        populateEditForm(result);
      } else {
        alert('Error loading recipe: ' + result.error);
        closeEditRecipeModal();
      }
    })
    .withFailureHandler(function(error) {
      alert('Error: ' + error.message);
      closeEditRecipeModal();
    })
    .getRecipeForEdit(recipeName);
  
  // Load change history
  loadRecipeHistory(recipeName);
  
  // Show details tab by default
  showEditRecipeTab('details');
}

/**
 * Close the Edit Recipe modal
 */
function closeEditRecipeModal() {
  document.getElementById('editRecipeModal').style.display = 'none';
  currentEditRecipe = null;
  originalRecipeData = null;
  ingredientChanges = [];
}

/**
 * Switch between tabs
 */
function showEditRecipeTab(tabName) {
  // Hide all tabs
  document.getElementById('editDetailsTab').style.display = 'none';
  document.getElementById('editIngredientsTab').style.display = 'none';
  document.getElementById('editHistoryTab').style.display = 'none';
  document.getElementById('reasonSection').style.display = 'none';
  document.getElementById('saveRecipeBtn').style.display = 'inline-block';
  
  // Reset tab styles
  document.querySelectorAll('.edit-recipe-tab').forEach(tab => {
    tab.style.fontWeight = '500';
    tab.style.color = '#666';
    tab.style.borderBottom = '3px solid transparent';
  });
  
  // Show selected tab
  if (tabName === 'details') {
    document.getElementById('editDetailsTab').style.display = 'block';
    document.getElementById('reasonSection').style.display = 'block';
    document.getElementById('tabDetails').style.fontWeight = '600';
    document.getElementById('tabDetails').style.color = '#1D3557';
    document.getElementById('tabDetails').style.borderBottom = '3px solid #E63946';
  } else if (tabName === 'ingredients') {
    document.getElementById('editIngredientsTab').style.display = 'block';
    document.getElementById('reasonSection').style.display = 'block';
    document.getElementById('tabIngredients').style.fontWeight = '600';
    document.getElementById('tabIngredients').style.color = '#1D3557';
    document.getElementById('tabIngredients').style.borderBottom = '3px solid #E63946';
  } else if (tabName === 'history') {
    document.getElementById('editHistoryTab').style.display = 'block';
    document.getElementById('saveRecipeBtn').style.display = 'none';
    document.getElementById('tabHistory').style.fontWeight = '600';
    document.getElementById('tabHistory').style.color = '#1D3557';
    document.getElementById('tabHistory').style.borderBottom = '3px solid #E63946';
  }
}

/**
 * Populate the edit form with recipe data
 */
function populateEditForm(data) {
  const recipe = data.recipe;
  
  // Rebuild details tab HTML
  document.getElementById('editDetailsTab').innerHTML = `
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
      <div>
        <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">Recipe Name</label>
        <input type="text" id="editRecipeName" value="${recipe['Recipe Name'] || ''}" style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; background:#f3f4f6;" readonly>
        <small style="color:#999;">Recipe name cannot be changed</small>
      </div>
      <div>
        <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">Beer Type / Style</label>
        <input type="text" id="editBeerType" value="${recipe['Beer Type'] || recipe['Style'] || ''}" style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
      </div>
      <div>
        <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">Batch Size (BBL)</label>
        <input type="number" id="editBatchSize" value="${recipe['Batch Size'] || recipe['Batch Size (BBL)'] || ''}" step="0.1" style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
      </div>
      <div>
        <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">Expected Yield %</label>
        <input type="number" id="editExpectedYield" value="${recipe['Expected Yield'] || recipe['Expected Yield %'] || ''}" step="1" style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
      </div>
      <div>
        <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">OG (Original Gravity)</label>
        <input type="text" id="editOG" value="${recipe['OG'] || ''}" style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
      </div>
      <div>
        <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">FG (Final Gravity)</label>
        <input type="text" id="editFG" value="${recipe['FG'] || ''}" style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
      </div>
      <div>
        <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">ABV %</label>
        <input type="number" id="editABV" value="${recipe['ABV'] || recipe['ABV %'] || ''}" step="0.1" style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
      </div>
      <div>
        <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">IBU</label>
        <input type="number" id="editIBU" value="${recipe['IBU'] || ''}" step="1" style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
      </div>
      <div>
        <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">SRM (Color)</label>
        <input type="number" id="editSRM" value="${recipe['SRM'] || ''}" step="1" style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
      </div>
      <div>
        <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">Fermentation Days</label>
        <input type="number" id="editFermDays" value="${recipe['Fermentation Days'] || recipe['Ferm Days'] || ''}" step="1" style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
      </div>
      <div>
        <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">Mash Temp (¬∞F)</label>
        <input type="number" id="editMashTemp" value="${recipe['Mash Temp'] || ''}" step="1" style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
      </div>
      <div>
        <label style="display:block; font-weight:600; color:#374151; margin-bottom:6px;">Sales Channel</label>
        <select id="editSalesChannel" style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
          <option value="Both" ${(recipe['Sales Channel'] || 'Both') === 'Both' ? 'selected' : ''}>Both (Taproom + B2B)</option>
          <option value="Taproom Only" ${recipe['Sales Channel'] === 'Taproom Only' ? 'selected' : ''}>Taproom Only</option>
          <option value="B2B Only" ${recipe['Sales Channel'] === 'B2B Only' ? 'selected' : ''}>B2B Only</option>
        </select>
      </div>
    </div>
  `;
  
  // Populate ingredients
  populateIngredients(data.ingredients);
}

/**
 * Populate ingredients section
 */
function populateIngredients(ingredients) {
  // Grains
  let grainsHtml = '';
  (ingredients.grains || []).forEach((ing, idx) => {
    grainsHtml += createIngredientRowHtml(ing, 'grain', idx);
  });
  document.getElementById('grainsContainer').innerHTML = grainsHtml || '<p style="color:#999; font-size:13px;">No grains in recipe</p>';
  
  // Hops
  let hopsHtml = '';
  (ingredients.hops || []).forEach((ing, idx) => {
    hopsHtml += createIngredientRowHtml(ing, 'hop', idx);
  });
  document.getElementById('hopsContainer').innerHTML = hopsHtml || '<p style="color:#999; font-size:13px;">No hops in recipe</p>';
  
  // Yeast
  let yeastHtml = '';
  (ingredients.yeast || []).forEach((ing, idx) => {
    yeastHtml += createIngredientRowHtml(ing, 'yeast', idx);
  });
  document.getElementById('yeastContainer').innerHTML = yeastHtml || '<p style="color:#999; font-size:13px;">No yeast in recipe</p>';
  
  // Other
  let otherHtml = '';
  (ingredients.other || []).forEach((ing, idx) => {
    otherHtml += createIngredientRowHtml(ing, 'other', idx);
  });
  document.getElementById('otherContainer').innerHTML = otherHtml || '<p style="color:#999; font-size:13px;">No other ingredients</p>';
}

/**
 * Create HTML for an ingredient row
 */
function createIngredientRowHtml(ing, type, idx) {
  const rowId = type + '_' + idx;
  const name = ing['Ingredient Name'] || ing['Name'] || '';
  const amount = ing['Amount'] || '';
  const uom = ing['UOM'] || ing['Unit'] || '';
  const rowIndex = ing._rowIndex || '';
  
  return `
    <div id="row_${rowId}" data-row-index="${rowIndex}" data-type="${type}" style="display:flex; gap:10px; margin-bottom:8px; align-items:center; background:#f8fafc; padding:10px; border-radius:6px;">
      <input type="text" value="${name}" placeholder="Ingredient Name" style="flex:2; padding:8px; border:1px solid #d1d5db; border-radius:4px;" data-field="Ingredient Name" data-original="${name}">
      <input type="number" value="${amount}" placeholder="Amount" step="0.01" style="flex:1; padding:8px; border:1px solid #d1d5db; border-radius:4px;" data-field="Amount" data-original="${amount}">
      <input type="text" value="${uom}" placeholder="UOM" style="width:80px; padding:8px; border:1px solid #d1d5db; border-radius:4px;" data-field="UOM" data-original="${uom}">
      <button onclick="markIngredientDeleted('${rowId}')" style="background:#EF4444; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer;">üóëÔ∏è</button>
    </div>
  `;
}

/**
 * Add a new ingredient row
 */
function addIngredientRow(type) {
  const containerId = type === 'grain' ? 'grainsContainer' : 
                      type === 'hop' ? 'hopsContainer' : 
                      type === 'yeast' ? 'yeastContainer' : 'otherContainer';
  
  const container = document.getElementById(containerId);
  const idx = 'new_' + Date.now();
  const rowId = type + '_' + idx;
  
  // Remove "no ingredients" message if present
  const noMsg = container.querySelector('p');
  if (noMsg) noMsg.remove();
  
  const typeLabel = type === 'grain' ? 'Grain/Malt' : 
                    type === 'hop' ? 'Hop' : 
                    type === 'yeast' ? 'Yeast' : 'Other';
  
  const newRowHtml = `
    <div id="row_${rowId}" data-row-index="" data-type="${type}" data-new="true" style="display:flex; gap:10px; margin-bottom:8px; align-items:center; background:#ECFDF5; padding:10px; border-radius:6px; border:2px dashed #10B981;">
      <input type="text" placeholder="${typeLabel} Name" style="flex:2; padding:8px; border:1px solid #d1d5db; border-radius:4px;" data-field="Ingredient Name" data-original="">
      <input type="number" placeholder="Amount" step="0.01" style="flex:1; padding:8px; border:1px solid #d1d5db; border-radius:4px;" data-field="Amount" data-original="">
      <input type="text" placeholder="UOM" style="width:80px; padding:8px; border:1px solid #d1d5db; border-radius:4px;" data-field="UOM" data-original="">
      <button onclick="removeNewIngredientRow('${rowId}')" style="background:#6B7280; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer;">‚úï</button>
    </div>
  `;
  
  container.insertAdjacentHTML('beforeend', newRowHtml);
}

/**
 * Mark an existing ingredient for deletion
 */
function markIngredientDeleted(rowId) {
  const row = document.getElementById('row_' + rowId);
  if (row) {
    row.style.background = '#FEE2E2';
    row.style.opacity = '0.6';
    row.setAttribute('data-deleted', 'true');
    row.querySelector('button').textContent = '‚Ü©Ô∏è';
    row.querySelector('button').onclick = function() { unmarkIngredientDeleted(rowId); };
  }
}

/**
 * Unmark ingredient deletion
 */
function unmarkIngredientDeleted(rowId) {
  const row = document.getElementById('row_' + rowId);
  if (row) {
    row.style.background = '#f8fafc';
    row.style.opacity = '1';
    row.removeAttribute('data-deleted');
    row.querySelector('button').textContent = 'üóëÔ∏è';
    row.querySelector('button').onclick = function() { markIngredientDeleted(rowId); };
  }
}

/**
 * Remove a newly added (unsaved) ingredient row
 */
function removeNewIngredientRow(rowId) {
  const row = document.getElementById('row_' + rowId);
  if (row) row.remove();
}

/**
 * Load recipe change history
 */
function loadRecipeHistory(recipeName) {
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success && result.history.length > 0) {
        let html = '<table style="width:100%; border-collapse:collapse; font-size:13px;">';
        html += '<tr style="background:#1D3557; color:white;"><th style="padding:10px; text-align:left;">Date</th><th style="padding:10px; text-align:left;">User</th><th style="padding:10px; text-align:left;">Change</th><th style="padding:10px; text-align:left;">Old ‚Üí New</th><th style="padding:10px; text-align:left;">Reason</th></tr>';
        
        result.history.forEach((record, idx) => {
          const bgColor = idx % 2 === 0 ? '#f8fafc' : 'white';
          html += `<tr style="background:${bgColor}; border-bottom:1px solid #e5e7eb;">
            <td style="padding:10px;">${record['Date']}</td>
            <td style="padding:10px;">${(record['User'] || '').split('@')[0]}</td>
            <td style="padding:10px; font-weight:500;">${record['Field Changed']}</td>
            <td style="padding:10px;"><span style="color:#EF4444;">${record['Old Value']}</span> ‚Üí <span style="color:#10B981;">${record['New Value']}</span></td>
            <td style="padding:10px; color:#666; font-style:italic;">${record['Reason'] || '-'}</td>
          </tr>`;
        });
        
        html += '</table>';
        document.getElementById('changeHistoryContainer').innerHTML = html;
      } else {
        document.getElementById('changeHistoryContainer').innerHTML = '<p style="color:#666; text-align:center; padding:40px;">No changes recorded yet for this recipe.</p>';
      }
    })
    .withFailureHandler(function(error) {
      document.getElementById('changeHistoryContainer').innerHTML = '<p style="color:#EF4444; text-align:center; padding:40px;">Error loading history: ' + error.message + '</p>';
    })
    .getRecipeChangeHistory(recipeName);
}

/**
 * Save all recipe changes
 */
function saveRecipeChanges() {
  const reason = document.getElementById('editChangeReason').value.trim();
  
  if (!reason) {
    alert('Please enter a reason for the change. This is required for tracking.');
    document.getElementById('editChangeReason').focus();
    return;
  }
  
  // Collect recipe detail updates
  const updates = {};
  const fields = [
    { id: 'editBeerType', name: 'Beer Type' },
    { id: 'editBatchSize', name: 'Batch Size' },
    { id: 'editExpectedYield', name: 'Expected Yield' },
    { id: 'editOG', name: 'OG' },
    { id: 'editFG', name: 'FG' },
    { id: 'editABV', name: 'ABV' },
    { id: 'editIBU', name: 'IBU' },
    { id: 'editSRM', name: 'SRM' },
    { id: 'editFermDays', name: 'Fermentation Days' },
    { id: 'editMashTemp', name: 'Mash Temp' },
    { id: 'editSalesChannel', name: 'Sales Channel' }
  ];
  
  fields.forEach(field => {
    const el = document.getElementById(field.id);
    if (el) {
      updates[field.name] = el.value;
    }
  });
  
  // Collect ingredient changes
  const ingredientUpdates = [];
  
  document.querySelectorAll('[id^="row_"]').forEach(row => {
    const rowIndex = row.getAttribute('data-row-index');
    const isNew = row.getAttribute('data-new') === 'true';
    const isDeleted = row.getAttribute('data-deleted') === 'true';
    const type = row.getAttribute('data-type');
    
    if (isDeleted && rowIndex) {
      // Mark for deletion
      ingredientUpdates.push({
        action: 'delete',
        rowIndex: parseInt(rowIndex)
      });
    } else if (isNew) {
      // Add new ingredient
      const inputs = row.querySelectorAll('input');
      const name = inputs[0].value.trim();
      const amount = inputs[1].value;
      const uom = inputs[2].value.trim();
      
      if (name && amount) {
        ingredientUpdates.push({
          action: 'add',
          data: {
            'Ingredient Name': name,
            'Ingredient Type': type === 'grain' ? 'Grain' : type === 'hop' ? 'Hop' : type === 'yeast' ? 'Yeast' : 'Other',
            'Amount': parseFloat(amount),
            'UOM': uom
          }
        });
      }
    } else if (rowIndex) {
      // Check for updates to existing
      const inputs = row.querySelectorAll('input');
      inputs.forEach(input => {
        const field = input.getAttribute('data-field');
        const original = input.getAttribute('data-original');
        const current = input.value;
        
        if (original !== current) {
          ingredientUpdates.push({
            action: 'update',
            rowIndex: parseInt(rowIndex),
            field: field,
            newValue: field === 'Amount' ? parseFloat(current) : current,
            ingredientName: inputs[0].value
          });
        }
      });
    }
  });
  
  // Show saving indicator
  document.getElementById('saveRecipeBtn').textContent = 'Saving...';
  document.getElementById('saveRecipeBtn').disabled = true;
  
  // Save recipe details
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        // Now save ingredient changes if any
        if (ingredientUpdates.length > 0) {
          google.script.run
            .withSuccessHandler(function(ingResult) {
              document.getElementById('saveRecipeBtn').textContent = 'üíæ Save Changes';
              document.getElementById('saveRecipeBtn').disabled = false;
              
              alert('Recipe updated successfully!\n\nChanges logged: ' + (result.changesLogged + (ingResult.changesLogged || 0)));
              closeEditRecipeModal();
              
              // Refresh recipes display if function exists
              if (typeof loadRecipes === 'function') loadRecipes();
            })
            .withFailureHandler(function(error) {
              document.getElementById('saveRecipeBtn').textContent = 'üíæ Save Changes';
              document.getElementById('saveRecipeBtn').disabled = false;
              alert('Error saving ingredients: ' + error.message);
            })
            .updateRecipeIngredients(currentEditRecipe, ingredientUpdates, reason);
        } else {
          document.getElementById('saveRecipeBtn').textContent = 'üíæ Save Changes';
          document.getElementById('saveRecipeBtn').disabled = false;
          
          if (result.changesLogged > 0) {
            alert('Recipe updated successfully!\n\nChanges logged: ' + result.changesLogged);
          } else {
            alert('No changes detected.');
          }
          closeEditRecipeModal();
          
          if (typeof loadRecipes === 'function') loadRecipes();
        }
      } else {
        document.getElementById('saveRecipeBtn').textContent = 'üíæ Save Changes';
        document.getElementById('saveRecipeBtn').disabled = false;
        alert('Error: ' + result.error);
      }
    })
    .withFailureHandler(function(error) {
      document.getElementById('saveRecipeBtn').textContent = 'üíæ Save Changes';
      document.getElementById('saveRecipeBtn').disabled = false;
      alert('Error saving recipe: ' + error.message);
    })
    .updateRecipe(currentEditRecipe, updates, reason);
}

// Close modal on background click
document.getElementById('editRecipeModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeEditRecipeModal();
  }
});

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // YEAST PROPAGATION - Complete JavaScript
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    var yeastData = {
      strains: [],
      pitches: [],
      summary: {},
      laborRate: 25.00,
      dmeCostPerLb: 2.50
    };
    
    var selectedPitchForUse = null;
    
    // Load yeast data when tab is activated
    function loadYeastData() {
      document.getElementById('yeastTableBody').innerHTML = '<tr><td colspan="9" class="loading">Loading yeast inventory...</td></tr>';
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.success !== false) {
            yeastData = result;
            renderYeastDashboard(result);
          } else {
            document.getElementById('yeastTableBody').innerHTML = '<tr><td colspan="9" style="color:var(--danger);">Error: ' + (result ? result.error : 'No data returned') + '</td></tr>';
          }
        })
        .withFailureHandler(function(err) {
          document.getElementById('yeastTableBody').innerHTML = '<tr><td colspan="9" style="color:var(--danger);">Error: ' + err + '</td></tr>';
        })
        .getYeastDashboardData();
    }
    
    function renderYeastDashboard(data) {
      var summary = data.summary || {};
      var strains = data.strains || [];
      var pitches = data.availablePitches || [];
      var avgCosts = data.averageCosts || [];
      
      // Update summary stats
      document.getElementById('yeastActivePitches').textContent = summary.activePitches || 0;
      document.getElementById('yeastTotalPitches').textContent = summary.totalPitches || 0;
      document.getElementById('yeastAvgGen').textContent = summary.avgGeneration ? 'P' + summary.avgGeneration.toFixed(1) : '--';
      document.getElementById('yeastAvgCost').textContent = '$' + formatNumber(summary.avgCostPerPitch || 0);
      document.getElementById('yeastAvailableCount').textContent = pitches.length + ' available';
      
      // Render strain overview
      renderStrainOverview(strains, avgCosts);
      
      // Render pitches table
      renderYeastPitches(pitches);
      
      // Render cost analysis
      renderYeastCostAnalysis(strains, avgCosts);
      
      // Populate strain filter dropdown
      populateYeastStrainFilter(strains);
      
      // Store for modals
      yeastData.laborRate = data.laborRate || 25.00;
      yeastData.dmeCostPerLb = data.dmeCostPerLb || 2.50;
    }
    
    function renderStrainOverview(strains, avgCosts) {
      var container = document.getElementById('strainOverviewGrid');
      
      if (!strains || strains.length === 0) {
        container.innerHTML = '<p class="text-muted">No strains configured. Run initializeYeastPropagationSystem() first.</p>';
        return;
      }
      
      container.innerHTML = strains.map(function(s) {
        var avgCost = avgCosts.find(function(c) { return c.strain === s.strainName; });
        var cost = avgCost ? avgCost.avgCost : 0;
        var singleUse = s.singleUseOnly === true || s.singleUseOnly === 'TRUE';
        
        return '<div style="border:1px solid var(--border);border-radius:8px;padding:15px;background:#fafafa;">' +
          '<h4 style="margin:0 0 10px 0;color:#8B0000;display:flex;justify-content:space-between;align-items:center;">' +
            escapeHtml(s.strainName) +
            (singleUse ? '<span class="badge badge-warning" style="font-size:10px;">SINGLE USE</span>' : '') +
          '</h4>' +
          '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px;">' +
            '<div style="display:flex;justify-content:space-between;"><span style="color:#666;">Source:</span><span>' + escapeHtml(s.baseYeastSource || '-') + '</span></div>' +
            '<div style="display:flex;justify-content:space-between;"><span style="color:#666;">Max Gen:</span><span>P' + (s.maxGenerations || 8) + '</span></div>' +
            '<div style="display:flex;justify-content:space-between;"><span style="color:#666;">Active:</span><span style="color:#28a745;font-weight:600;">' + (s.activeCount || 0) + '</span></div>' +
            '<div style="display:flex;justify-content:space-between;"><span style="color:#666;">Avg Cost:</span><span style="color:#8B0000;font-weight:600;">$' + formatNumber(cost) + '</span></div>' +
          '</div>' +
        '</div>';
      }).join('');
    }
    
    function renderYeastPitches(pitches) {
      var tbody = document.getElementById('yeastTableBody');
      
      if (!pitches || pitches.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No pitches available. Create a new P0 propagation to get started.</td></tr>';
        return;
      }
      
      tbody.innerHTML = pitches.map(function(p) {
        var genClass = getGenBadgeClass(p.generation);
        var statusClass = p.status === 'Active' ? 'badge-success' : p.status === 'Depleted' ? 'badge-gray' : 'badge-warning';
        var sourceInfo = p.parentPitchId ? 'From ' + p.parentPitchId + (p.sourceBatch ? ' (Batch ' + p.sourceBatch + ')' : '') : 'Initial Culture';
        
        return '<tr>' +
          '<td><strong>' + escapeHtml(p.pitchId) + '</strong></td>' +
          '<td>' + escapeHtml(p.strain) + '</td>' +
          '<td><span class="badge ' + genClass + '">' + p.generation + '</span></td>' +
          '<td>' + formatDate(p.dateCreated) + '</td>' +
          '<td style="text-align:right;">' + formatNumber(p.volume || 0) + '</td>' +
          '<td style="text-align:right;font-weight:600;color:#8B0000;">$' + formatNumber(p.costPerPitch || 0) + '</td>' +
          '<td style="font-size:12px;color:#666;">' + sourceInfo + '</td>' +
          '<td><span class="badge ' + statusClass + '">' + (p.status || 'Unknown') + '</span></td>' +
          '<td>' + (p.status === 'Active' ? 
            '<button class="btn-icon" onclick="showUsePitchModal(\'' + escapeHtml(p.pitchId) + '\')" title="Use in Batch">üç∫</button>' : 
            '<span class="text-muted">-</span>') +
          '</td>' +
        '</tr>';
      }).join('');
    }
    
    function getGenBadgeClass(gen) {
      if (!gen) return 'badge-info';
      var num = parseInt(gen.replace('P', '')) || 0;
      if (num === 0) return 'badge-danger';
      if (num === 1) return 'badge-warning';
      if (num <= 3) return 'badge-info';
      return 'badge-success';
    }
    
    function renderYeastCostAnalysis(strains, avgCosts) {
      // Cost by generation
      var genContainer = document.getElementById('yeastCostByGen');
      genContainer.innerHTML = 
        '<div style="font-size:13px;">' +
          '<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);"><span>P0 (Initial)</span><strong style="color:#dc3545;">$60-70</strong></div>' +
          '<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);"><span>P1 (1st Harvest)</span><strong>$4-8</strong></div>' +
          '<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);"><span>P2-P4</span><strong>$4-8</strong></div>' +
          '<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);"><span>P5-P8</span><strong style="color:#28a745;">$4-8</strong></div>' +
          '<div style="margin-top:15px;padding:10px;background:#f0fff4;border-radius:6px;font-size:12px;color:#276749;">' +
            'üí° <strong>Cost degradation:</strong> Each harvest dilutes the expensive P0 cost. After 7 harvests, weighted avg drops to ~$12/pitch.' +
          '</div>' +
        '</div>';
      
      // Strain costs
      var strainContainer = document.getElementById('yeastStrainCosts');
      if (!avgCosts || avgCosts.length === 0) {
        strainContainer.innerHTML = '<p class="text-muted">No cost data yet.</p>';
        return;
      }
      
      strainContainer.innerHTML = avgCosts.map(function(c) {
        return '<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);">' +
          '<span>' + escapeHtml(c.strain) + '</span>' +
          '<span style="font-weight:600;color:#8B0000;">$' + formatNumber(c.avgCost || 0) + '/pitch</span>' +
        '</div>';
      }).join('');
    }
    
    function populateYeastStrainFilter(strains) {
      var select = document.getElementById('yeastStrainFilter');
      select.innerHTML = '<option value="">All Strains</option>' +
        (strains || []).map(function(s) {
          return '<option value="' + escapeHtml(s.strainName) + '">' + escapeHtml(s.strainName) + '</option>';
        }).join('');
    }
    
    function filterYeastPitches() {
      var strainFilter = document.getElementById('yeastStrainFilter').value;
      var statusFilter = document.getElementById('yeastStatusFilter').value;
      
      var filtered = (yeastData.availablePitches || []).filter(function(p) {
        var matchStrain = !strainFilter || p.strain === strainFilter;
        var matchStatus = !statusFilter || p.status === statusFilter;
        return matchStrain && matchStatus;
      });
      
      renderYeastPitches(filtered);
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // NEW P0 MODAL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function showNewP0Modal() {
      // Populate strains dropdown
      var select = document.getElementById('p0Strain');
      select.innerHTML = '<option value="">Select strain...</option>' +
        (yeastData.strains || []).map(function(s) {
          return '<option value="' + escapeHtml(s.strainName) + '" data-dme="' + (s.defaultDME || 4) + '">' + escapeHtml(s.strainName) + '</option>';
        }).join('');
      
      // Set today's date
      document.getElementById('p0Date').value = new Date().toISOString().split('T')[0];
      
      calculateP0Cost();
      openModal('newP0Modal');
    }
    
    function updateP0Defaults() {
      var select = document.getElementById('p0Strain');
      var option = select.options[select.selectedIndex];
      if (option && option.dataset.dme) {
        document.getElementById('p0DME').value = option.dataset.dme;
      }
      calculateP0Cost();
    }
    
    function calculateP0Cost() {
      var dmeLbs = parseFloat(document.getElementById('p0DME').value) || 0;
      var laborHrs = parseFloat(document.getElementById('p0Labor').value) || 0;
      var nutrientCost = parseFloat(document.getElementById('p0NutrientCost').value) || 0;
      var yeastCost = parseFloat(document.getElementById('p0YeastCost').value) || 0;
      
      var dmeCost = dmeLbs * yeastData.dmeCostPerLb;
      var laborCost = laborHrs * yeastData.laborRate;
      var totalCost = dmeCost + nutrientCost + yeastCost + laborCost;
      
      document.getElementById('p0DMECostPreview').textContent = '$' + dmeCost.toFixed(2);
      document.getElementById('p0NutrientCostPreview').textContent = '$' + nutrientCost.toFixed(2);
      document.getElementById('p0YeastCostPreview').textContent = '$' + yeastCost.toFixed(2);
      document.getElementById('p0LaborCostPreview').textContent = '$' + laborCost.toFixed(2);
      document.getElementById('p0TotalCostPreview').textContent = '$' + totalCost.toFixed(2);
    }
    
    function submitNewP0() {
      var strain = document.getElementById('p0Strain').value;
      if (!strain) { showToast('Please select a strain', 'error'); return; }
      
      var formData = {
        strainName: strain,
        dmeLbs: parseFloat(document.getElementById('p0DME').value) || 0,
        laborHours: parseFloat(document.getElementById('p0Labor').value) || 0,
        nutrients: document.getElementById('p0Nutrients').value,
        nutrientCost: parseFloat(document.getElementById('p0NutrientCost').value) || 0,
        initialYeastCost: parseFloat(document.getElementById('p0YeastCost').value) || 0,
        dateCreated: document.getElementById('p0Date').value,
        volume: parseFloat(document.getElementById('p0Volume').value) || 0,
        cellCount: parseFloat(document.getElementById('p0CellCount').value) || 0,
        notes: document.getElementById('p0Notes').value
      };
      
      showToast('Creating P0 propagation...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            closeModal('newP0Modal');
            showToast('P0 Created! Pitch ID: ' + result.pitchId + ' - Cost: $' + result.totalCost.toFixed(2), 'success');
            loadYeastData();
          } else {
            showToast('Error: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(err) {
          showToast('Error: ' + err, 'error');
        })
        .apiCreateP0(formData);
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // HARVEST MODAL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function showHarvestModal() {
      // Populate available pitches dropdown (only Active ones that can be harvested)
      var select = document.getElementById('harvestParentPitch');
      var activePitches = (yeastData.availablePitches || []).filter(function(p) { return p.status === 'Active'; });
      
      select.innerHTML = '<option value="">Select pitch to harvest from...</option>' +
        activePitches.map(function(p) {
          return '<option value="' + p.pitchId + '" data-strain="' + escapeHtml(p.strain) + '" data-gen="' + p.generation + '" data-cost="' + p.costPerPitch + '">' +
            p.pitchId + ' - ' + escapeHtml(p.strain) + ' (' + p.generation + ') - $' + p.costPerPitch.toFixed(2) +
          '</option>';
        }).join('');
      
      // Reset form
      document.getElementById('harvestParentInfo').style.display = 'none';
      document.getElementById('harvestSingleUseWarning').style.display = 'none';
      document.getElementById('harvestSubmitBtn').disabled = false;
      
      calculateHarvestCost();
      openModal('harvestModal');
    }
    
    function updateHarvestParentInfo() {
      var select = document.getElementById('harvestParentPitch');
      var option = select.options[select.selectedIndex];
      var infoSection = document.getElementById('harvestParentInfo');
      var warningSection = document.getElementById('harvestSingleUseWarning');
      var submitBtn = document.getElementById('harvestSubmitBtn');
      
      if (!option.value) {
        infoSection.style.display = 'none';
        warningSection.style.display = 'none';
        return;
      }
      
      var strain = option.dataset.strain;
      var gen = option.dataset.gen;
      var cost = option.dataset.cost;
      
      document.getElementById('harvestParentStrain').textContent = strain;
      document.getElementById('harvestParentGen').textContent = gen;
      var currentGenNum = parseInt(gen.replace('P', '')) || 0;
      document.getElementById('harvestNewGen').textContent = 'P' + (currentGenNum + 1);
      document.getElementById('harvestParentCost').textContent = '$' + parseFloat(cost).toFixed(2);
      
      infoSection.style.display = 'block';
      
      // Check if single use (Hazy)
      if (strain.toLowerCase().includes('hazy')) {
        warningSection.style.display = 'block';
        submitBtn.disabled = true;
      } else {
        warningSection.style.display = 'none';
        submitBtn.disabled = false;
      }
      
      calculateHarvestCost();
    }
    
    function calculateHarvestCost() {
      var dmeLbs = parseFloat(document.getElementById('harvestDME').value) || 0;
      var laborMin = parseFloat(document.getElementById('harvestLabor').value) || 0;
      
      var dmeCost = dmeLbs * yeastData.dmeCostPerLb;
      var laborCost = (laborMin / 60) * yeastData.laborRate;
      var totalCost = dmeCost + laborCost;
      
      document.getElementById('harvestDMECostPreview').textContent = '$' + dmeCost.toFixed(2);
      document.getElementById('harvestLaborCostPreview').textContent = '$' + laborCost.toFixed(2);
      document.getElementById('harvestTotalCostPreview').textContent = '$' + totalCost.toFixed(2);
      
      // Show savings
      var p0Estimate = 60;
      var savings = p0Estimate - totalCost;
      if (savings > 0) {
        document.getElementById('harvestSavingsNote').textContent = '‚ñº Saving $' + savings.toFixed(2) + ' vs new P0 propagation';
      } else {
        document.getElementById('harvestSavingsNote').textContent = '';
      }
    }
    
    function submitHarvest() {
      var parentPitch = document.getElementById('harvestParentPitch').value;
      if (!parentPitch) { showToast('Please select a source pitch', 'error'); return; }
      
      var sourceBatch = document.getElementById('harvestSourceBatch').value;
      if (!sourceBatch) { showToast('Please enter the source batch number', 'error'); return; }
      
      var formData = {
        parentPitchId: parentPitch,
        sourceBatch: sourceBatch,
        dmeLbs: parseFloat(document.getElementById('harvestDME').value) || 0,
        laborMinutes: parseFloat(document.getElementById('harvestLabor').value) || 10,
        volume: parseFloat(document.getElementById('harvestVolume').value) || 0,
        cellCount: parseFloat(document.getElementById('harvestCellCount').value) || 0,
        notes: document.getElementById('harvestNotes').value
      };
      
      showToast('Creating harvest...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            closeModal('harvestModal');
            showToast('Harvest Created! Pitch ID: ' + result.pitchId + ' (' + result.generation + ') - Cost: $' + result.totalCost.toFixed(2), 'success');
            loadYeastData();
          } else {
            showToast('Error: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(err) {
          showToast('Error: ' + err, 'error');
        })
        .apiCreateHarvest(formData);
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // USE PITCH MODAL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function showUsePitchModal(pitchId) {
      var pitch = (yeastData.availablePitches || []).find(function(p) { return p.pitchId === pitchId; });
      if (!pitch) { showToast('Pitch not found', 'error'); return; }
      
      selectedPitchForUse = pitch;
      
      document.getElementById('usePitchId').textContent = pitch.pitchId;
      document.getElementById('usePitchStrain').textContent = pitch.strain;
      document.getElementById('usePitchGen').textContent = pitch.generation;
      document.getElementById('usePitchCost').textContent = '$' + pitch.costPerPitch.toFixed(2);
      document.getElementById('usePitchBatch').value = '';
      
      openModal('usePitchModal');
    }
    
    function submitUsePitch() {
      if (!selectedPitchForUse) { showToast('No pitch selected', 'error'); return; }
      
      var batchNumber = document.getElementById('usePitchBatch').value;
      if (!batchNumber) { showToast('Please enter a batch number', 'error'); return; }
      
      showToast('Marking pitch as used...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            closeModal('usePitchModal');
            showToast('Pitch ' + selectedPitchForUse.pitchId + ' used in Batch ' + batchNumber, 'success');
            selectedPitchForUse = null;
            loadYeastData();
          } else {
            showToast('Error: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(err) {
          showToast('Error: ' + err, 'error');
        })
        .apiUsePitch(selectedPitchForUse.pitchId, batchNumber);
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // UPDATE RAW MATERIALS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function updateYeastCostsInRawMaterials() {
      if (!confirm('Update Raw Materials with weighted average yeast costs?\n\nThis will add/update yeast entries for each strain.')) return;
      
      showToast('Updating Raw Materials...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast('Raw Materials updated with ' + (result.updatedCount || 0) + ' yeast costs!', 'success');
          } else {
            showToast('Error: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(err) {
          showToast('Error: ' + err, 'error');
        })
        .apiUpdateYeastCostsInRawMaterials();
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ADD YEAST TO TAB LOADER
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    // Update the loadTabData function to include yeast
    var originalLoadTabData = typeof loadTabData === 'function' ? loadTabData : null;
    
    loadTabData = function(tabId) {
      if (tabId === 'yeast') {
        loadYeastData();
        return;
      }
      if (originalLoadTabData) {
        originalLoadTabData(tabId);
      }
    };
</script>
</body>
</html>